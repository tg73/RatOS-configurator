(()=>{"use strict";var e={14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},4074:e=>{e.exports=require("perf_hooks")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},71576:e=>{e.exports=require("string_decoder")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},71267:e=>{e.exports=require("worker_threads")},59796:e=>{e.exports=require("zlib")},61014:(e,r,t)=>{t.d(r,{vy:()=>l});var a=t(52013),s=t(86),_=t(88509),i=t(41866);let JobCancelledError=class JobCancelledError extends Error{constructor(){super("Job cancelled")}};let o=new Map,n=0,l={DEFAULT_DAMPING_RATIO:.1,SHAPER_VIBRATION_REDUCTION:20,TEST_DAMPING_RATIOS:[.075,.1,.15],MAX_SHAPER_FREQ:150,WINDOW_T_SEC:.5,MIN_FREQ:5,MAX_FREQ:200,TARGET_SMOOTHING:.12},cancelJob=e=>{let r=o.get(e);r&&!1===r.signal.aborted&&r.abort(),o.delete(e)},throwIfCancelled=e=>{if(e.aborted)throw new JobCancelledError};async function getShaperSmoothing(e,r=5e3,t=5){let a=.5*r,[s,_]=e,o=1/(0,i.P0)(s),n=_.length,l=(0,i.P0)(s.map((e,r)=>e*_[r]))*o,c=0,u=0;for(let e=0;e<n;e++)_[e]>=l&&(c+=s[e]*(t+a*(_[e]-l))*(_[e]-l)),u+=s[e]*a*(_[e]-l)**2;return Math.max(c*=o*Math.sqrt(2),u*=o)}async function bisect(e){let r=1,t=1;if(!await e(1e-9))return 0;for(;!await e(r);)t=r,r*=.5;if(t===r)for(;await e(t);)t*=2;for(;t-r>1e-8;){let a=(r+t)*.5;await e(a)?r=a:t=a}return r}async function findShaperMaxAccel(e,r){let t=await bisect(async t=>await getShaperSmoothing(e,t,r)<=l.TARGET_SMOOTHING);return t}async function estimateRemainingVibrations(e,r,t,s){let _=(0,a.tidy)(()=>{let s=(0,a.tensor1d)(e[0]),_=(0,a.tensor1d)(e[1]),i=(0,a.div)(1,(0,a.sum)(s)),o=(0,a.mul)((0,a.mul)(t,2),Math.PI),n=(0,a.mul)(o,r),l=(0,a.mul)(o,Math.sqrt(1-r**2)),c=(0,a.mul)(s,(0,a.exp)((0,a.outerProduct)((0,a.mul)(n,-1),(0,a.sub)((0,a.slice)(_,_.size-1,1),_)))),u=(0,a.mul)(c,(0,a.sin)((0,a.outerProduct)(l,_))),p=(0,a.mul)(c,(0,a.cos)((0,a.outerProduct)(l,_)));return(0,a.mul)((0,a.sqrt)((0,a.sum)((0,a.stack)([(0,a.pow)((0,a.sum)(u,1),2),(0,a.pow)((0,a.sum)(p,1),2)]),0)),i)}),i=await (0,a.tidy)(()=>{let e=(0,a.div)((0,a.max)(s),l.SHAPER_VIBRATION_REDUCTION),r=(0,a.sum)((0,a.max)((0,a.sub)((0,a.mul)(_,s),e),0)),t=(0,a.sum)((0,a.max)((0,a.sub)(s,e),0));return(0,a.div)(r,t)}).array();return[i,_]}let range=(e,r,t)=>Array.from({length:(r-e)/t+1},(r,a)=>e+a*t);async function fitShaper(e,r,t,s,_,o=[null,null,null],n,c,u,p,d){n=n||l.DEFAULT_DAMPING_RATIO,u=u||l.TEST_DAMPING_RATIOS;let w=o[1]??l.MAX_SHAPER_FREQ,f=Math.min(o[0]??t.minFreq,w-1e-7),m=o[2]??.2;throwIfCancelled(r),p=Math.max(p||l.MAX_FREQ,w);let b=(0,a.slice1d)(s.frequencies,0,s.frequencies.length),h=(0,a.slice1d)(b,0,s.frequencies.findIndex(e=>e>p)),q=(0,a.slice1d)(s.estimates,0,b.size);b.dispose();let g=(0,a.zeros)([q.size]),k=(await Promise.all(range(f,w,10).map(async e=>{if(t.minFreq>e)return null;let s=t.initFunc(e,n),_=0,i=g.clone();for(let e of u){let[t,o]=await estimateRemainingVibrations(s,e,h,q);throwIfCancelled(r);let n=i;i=(0,a.tidy)(()=>(0,a.max)((0,a.stack)([n,o]),0)),n.dispose(),t>_&&(_=t)}return _<.15?e:null}))).filter(Boolean);throwIfCancelled(r);let y=range(Math.min(...k),Math.max(...k),m),x=new Map,reportProgress=(r,a)=>{x.set(r,a);let s=(0,i.P0)(Array.from(x.values()))/y.length;postMessage({type:"fitShaperProgress",model:t.name,progress:s,jobId:e}),d?.(t.name,s)},v=(await Promise.all(y.reverse().map(async(e,s)=>{reportProgress(e,0),throwIfCancelled(r);let i=0,o=g.clone(),l=t.initFunc(e,n),p=await getShaperSmoothing(l,void 0,_);if(throwIfCancelled(r),c&&p>c)return null;for(let e of(reportProgress(s,1/3),u)){let[t,s]=await estimateRemainingVibrations(l,e,h,q);throwIfCancelled(r);let _=o;o=(0,a.tidy)(()=>(0,a.max)((0,a.stack)([_,s]),0)),_.dispose(),t>i&&(i=t)}reportProgress(s,2/3);let d=await findShaperMaxAccel(l,_);throwIfCancelled(r);let w=p*(Math.pow(i,1.5)+.2*i+.01),f=await o.array(),m=await (0,a.mul)(q,o).array();reportProgress(s,1);let b={name:t.name,freq:e,vals:f,psd:m,vibrs:i,smoothing:p,score:w,color:t.color,maxAccel:d};return b}))).reduce((e,r)=>(null===r||(null==e||r.vibrs<1.1*e.vibrs&&r.score<e.score)&&(e=r),e),null);return h.dispose(),q.dispose(),g.dispose(),throwIfCancelled(r),postMessage({type:"fitShaper",result:v,jobId:e}),v}async function findBestShaper(e,r,t,s,o=_.$l,n,l,c,u,p){await (0,a.setBackend)("wasm"),throwIfCancelled(r);let d=[],w=new Map;o.forEach(e=>w.set(e.name,0)),postMessage({type:"findBestShaperProgress",progress:0,jobId:e});let reportProgress=(r,t)=>{w.set(r,t);let a=(0,i.P0)(Array.from(w.values()))/o.length;postMessage({type:"findBestShaperProgress",progress:a,jobId:e})};for(let a of o){let _=await fitShaper(e,r,a,t,s,n,l,c,u,p,reportProgress);_&&d.push(_)}throwIfCancelled(r);let f=d.reduce((e,r)=>((!e||r&&1.2*r.score<e.score||1.05*r.score<e.score&&1.1*r.smoothing<e.smoothing)&&(e=r),e));return{result:f,shapers:d}}(0,s._1)({"tfjs-backend-wasm.wasm":"/configure/tfjs-backend-wasm.wasm","tfjs-backend-wasm-simd.wasm":"/configure/tfjs-backend-wasm-simd.wasm","tfjs-backend-wasm-threaded-simd.wasm":"/configure/tfjs-backend-wasm-threaded-simd.wasm"}),onmessage=async e=>{let r=e.data.type;switch(r){case"findBestShaper":let{calibrationData:t,scv:a,shaperFreqs:s,dampingRatio:i,maxSmoothing:l,testDampingRatios:c,maxFreq:u,id:p}=e.data,d=p??n++,w=new AbortController;try{o.set(d,w);let e=await findBestShaper(d,w.signal,t,a,_.$l,s,i,l,c,u);postMessage({type:"findBestShaper",jobId:d,...e})}catch(e){e instanceof JobCancelledError&&(cancelJob(d),postMessage({type:"jobCancelled",id:d}))}break;case"cancelJob":cancelJob(e.data.id)}}}},r={};function __webpack_require__(t){var a=r[t];if(void 0!==a)return a.exports;var s=r[t]={exports:{}},_=!0;try{e[t](s,s.exports,__webpack_require__),_=!1}finally{_&&delete r[t]}return s.exports}__webpack_require__.m=e,__webpack_require__.x=()=>{var e=__webpack_require__.O(void 0,[5417,2013,8509,1866],()=>__webpack_require__(61014));return __webpack_require__.O(e)},(()=>{var e=[];__webpack_require__.O=(r,t,a,s)=>{if(t){s=s||0;for(var _=e.length;_>0&&e[_-1][2]>s;_--)e[_]=e[_-1];e[_]=[t,a,s];return}for(var i=1/0,_=0;_<e.length;_++){for(var[t,a,s]=e[_],o=!0,n=0;n<t.length;n++)i>=s&&Object.keys(__webpack_require__.O).every(e=>__webpack_require__.O[e](t[n]))?t.splice(n--,1):(o=!1,s<i&&(i=s));if(o){e.splice(_--,1);var l=a();void 0!==l&&(r=l)}}return r}})(),__webpack_require__.d=(e,r)=>{for(var t in r)__webpack_require__.o(r,t)&&!__webpack_require__.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},__webpack_require__.f={},__webpack_require__.e=e=>Promise.all(Object.keys(__webpack_require__.f).reduce((r,t)=>(__webpack_require__.f[t](e,r),r),[])),__webpack_require__.u=e=>""+e+".js",__webpack_require__.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),(()=>{var e={2881:1,1014:1};__webpack_require__.O.require=r=>e[r];var installChunk=r=>{var t=r.modules,a=r.ids,s=r.runtime;for(var _ in t)__webpack_require__.o(t,_)&&(__webpack_require__.m[_]=t[_]);s&&s(__webpack_require__);for(var i=0;i<a.length;i++)e[a[i]]=1;__webpack_require__.O()};__webpack_require__.f.require=(r,t)=>{e[r]||installChunk(require("./"+__webpack_require__.u(r)))}})(),(()=>{var e=__webpack_require__.x;__webpack_require__.x=()=>(__webpack_require__.e(5417),__webpack_require__.e(2013),__webpack_require__.e(8509),__webpack_require__.e(1866),e())})();var t=__webpack_require__.x();module.exports=t})();