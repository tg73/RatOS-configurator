exports.id=5599,exports.ids=[5599],exports.modules={25599:(e,t,r)=>{"use strict";r.d(t,{dj:()=>deserializeToolheadConfiguration,fM:()=>loadSerializedConfig,uz:()=>readSerializedConfig,regenerateKlipperConfiguration:()=>regenerateKlipperConfiguration});var o,i,n,a,s=r(38316),l=r(36523),d=r(32081),p=r(57147),c=r.n(p),u=r(71017),h=r.n(u),g=r(14521),f=r(73837),_=r(81115),m=r(16561);let b={x_step_pin:s.z.string().optional(),x_dir_pin:s.z.string().optional(),x_enable_pin:s.z.string().optional(),x_uart_pin:s.z.string().optional(),x_diag_pin:s.z.string().optional(),x_endstop_pin:s.z.string().optional(),x1_step_pin:s.z.string().optional(),x1_dir_pin:s.z.string().optional(),x1_enable_pin:s.z.string().optional(),x1_uart_pin:s.z.string().optional(),x1_diag_pin:s.z.string().optional(),x1_endstop_pin:s.z.string().optional(),dual_carriage_step_pin:s.z.string().optional(),dual_carriage_dir_pin:s.z.string().optional(),dual_carriage_enable_pin:s.z.string().optional(),dual_carriage_uart_pin:s.z.string().optional(),dual_carriage_diag_pin:s.z.string().optional(),dual_carriage_endstop_pin:s.z.string().optional(),y_step_pin:s.z.string().optional(),y_dir_pin:s.z.string().optional(),y_enable_pin:s.z.string().optional(),y_uart_pin:s.z.string().optional(),y_diag_pin:s.z.string().optional(),y_endstop_pin:s.z.string().optional(),y1_step_pin:s.z.string().optional(),y1_dir_pin:s.z.string().optional(),y1_enable_pin:s.z.string().optional(),y1_uart_pin:s.z.string().optional(),y1_diag_pin:s.z.string().optional(),y1_endstop_pin:s.z.string().optional(),y2_step_pin:s.z.string().optional(),y2_dir_pin:s.z.string().optional(),y2_enable_pin:s.z.string().optional(),y2_uart_pin:s.z.string().optional(),y2_diag_pin:s.z.string().optional(),y2_endstop_pin:s.z.string().optional(),z0_step_pin:s.z.string().optional(),z0_dir_pin:s.z.string().optional(),z0_enable_pin:s.z.string().optional(),z0_uart_pin:s.z.string().optional(),z0_diag_pin:s.z.string().optional(),z1_step_pin:s.z.string().optional(),z1_dir_pin:s.z.string().optional(),z1_enable_pin:s.z.string().optional(),z1_uart_pin:s.z.string().optional(),z1_diag_pin:s.z.string().optional(),z2_step_pin:s.z.string().optional(),z2_dir_pin:s.z.string().optional(),z2_enable_pin:s.z.string().optional(),z2_uart_pin:s.z.string().optional(),z2_diag_pin:s.z.string().optional(),z3_step_pin:s.z.string().optional(),z3_dir_pin:s.z.string().optional(),z3_enable_pin:s.z.string().optional(),z3_uart_pin:s.z.string().optional(),z3_diag_pin:s.z.string().optional(),e_step_pin:s.z.string().optional(),e_dir_pin:s.z.string().optional(),e_enable_pin:s.z.string().optional(),e_uart_pin:s.z.string().optional(),e_diag_pin:s.z.string().optional(),e_heater_pin:s.z.string().optional(),e_sensor_pin:s.z.string().optional(),stepper_spi_mosi_pin:s.z.string().optional(),stepper_spi_miso_pin:s.z.string().optional(),stepper_spi_sclk_pin:s.z.string().optional(),adxl345_cs_pin:s.z.string().optional(),bltouch_sensor_pin:s.z.string().optional(),bltouch_control_pin:s.z.string().optional(),probe_pin:s.z.string().optional(),fan_part_cooling_pin:s.z.string().optional(),fan_toolhead_cooling_pin:s.z.string().optional(),fan_controller_board_pin:s.z.string().optional(),heater_bed_heating_pin:s.z.string().optional(),heater_bed_sensor_pin:s.z.string().optional(),"4p_fan_part_cooling_pin":s.z.string().optional(),"4p_fan_part_cooling_tach_pin":s.z.string().optional(),"4p_toolhead_cooling_pin":s.z.string().optional(),"4p_toolhead_cooling_tach_pin":s.z.string().optional(),"4p_controller_board_pin":s.z.string().optional(),"4p_controller_board_tach_pin":s.z.string().optional()},z=s.z.object(b);!function(e){e.x="x",e.x1="x1",e.y="y",e.y1="y1",e.y2="y2",e.z0="z0",e.z1="z1",e.z2="z2",e.z3="z3",e.e="e",e.e1="e1",e.dual_carriage="dual_carriage"}(a||(a={}));let T={x:m.po.x,x1:m.po.x1,y:m.po.y,y1:m.po.y1,y2:m.po.y2,z0:m.po.z,z1:m.po.z1,z2:m.po.z2,z3:m.po.z3,e:m.po.extruder,e1:m.po.extruder1,dual_carriage:m.po.dual_carriage},x=s.z.nativeEnum(a).transform(e=>T[e]??null),P=s.z.nativeEnum(m.po).transform(e=>Object.keys(T).find(t=>T[t]===e)??null),y=z.extend({x_step_pin:s.z.string(),x_dir_pin:s.z.string(),x_enable_pin:s.z.string(),x_uart_pin:s.z.string(),x_endstop_pin:s.z.string(),y_step_pin:s.z.string(),y_dir_pin:s.z.string(),y_enable_pin:s.z.string(),y_uart_pin:s.z.string(),y_endstop_pin:s.z.string(),z0_step_pin:s.z.string(),z0_dir_pin:s.z.string(),z0_enable_pin:s.z.string(),z0_uart_pin:s.z.string(),e_step_pin:s.z.string(),e_dir_pin:s.z.string(),e_enable_pin:s.z.string(),e_uart_pin:s.z.string(),e_heater_pin:s.z.string(),e_sensor_pin:s.z.string(),probe_pin:s.z.string(),heater_bed_heating_pin:s.z.string(),heater_bed_sensor_pin:s.z.string()}).and(s.z.object({fan_part_cooling_pin:s.z.string(),fan_toolhead_cooling_pin:s.z.string()}).or(s.z.object({"4p_fan_part_cooling_pin":s.z.string(),"4p_fan_part_cooling_tach_pin":s.z.string(),"4p_toolhead_cooling_pin":s.z.string(),"4p_toolhead_cooling_tach_pin":s.z.string()}))),v=z.extend({x_step_pin:s.z.string(),x_dir_pin:s.z.string(),x_enable_pin:s.z.string(),x_uart_pin:s.z.string(),x_endstop_pin:s.z.string(),y_step_pin:s.z.string(),y_dir_pin:s.z.string(),y_enable_pin:s.z.string(),y_uart_pin:s.z.string(),y_endstop_pin:s.z.string(),z0_step_pin:s.z.string(),z0_dir_pin:s.z.string(),z0_enable_pin:s.z.string(),z0_uart_pin:s.z.string(),z1_step_pin:s.z.string(),z1_dir_pin:s.z.string(),z1_enable_pin:s.z.string(),z1_uart_pin:s.z.string(),z2_step_pin:s.z.string(),z2_dir_pin:s.z.string(),z2_enable_pin:s.z.string(),z2_uart_pin:s.z.string(),probe_pin:s.z.string(),heater_bed_heating_pin:s.z.string(),heater_bed_sensor_pin:s.z.string()}).and(s.z.object({fan_part_cooling_pin:s.z.string(),fan_toolhead_cooling_pin:s.z.string()}).or(s.z.object({"4p_fan_part_cooling_pin":s.z.string(),"4p_fan_part_cooling_tach_pin":s.z.string(),"4p_toolhead_cooling_pin":s.z.string(),"4p_toolhead_cooling_tach_pin":s.z.string()}))),w=z.extend({e_step_pin:s.z.string(),e_dir_pin:s.z.string(),e_enable_pin:s.z.string(),e_uart_pin:s.z.string(),e_heater_pin:s.z.string(),e_sensor_pin:s.z.string(),adxl345_cs_pin:s.z.string(),probe_pin:s.z.string()}).and(s.z.object({fan_part_cooling_pin:s.z.string(),fan_toolhead_cooling_pin:s.z.string()}).or(s.z.object({"4p_fan_part_cooling_pin":s.z.string(),"4p_fan_part_cooling_tach_pin":s.z.string(),"4p_toolhead_cooling_pin":s.z.string(),"4p_toolhead_cooling_tach_pin":s.z.string()}))),C=s.z.object({uart_pin:s.z.string(),uart_address:s.z.string().optional(),rx_pin:s.z.string().optional(),tx_pin:s.z.string().optional()}),S=s.z.object({cs_pin:s.z.string()}).and(s.z.object({spi_bus:s.z.string()}).or(s.z.object({spi_software_mosi_pin:s.z.string().optional(),spi_software_miso_pin:s.z.string().optional(),spi_software_sclk_pin:s.z.string().optional()}))),hasSPI=e=>S.safeParse(e).success,hasUART=e=>C.safeParse(e).success,$=s.z.object({step_pin:s.z.string(),dir_pin:s.z.string(),enable_pin:s.z.string(),diag_pin:s.z.string().optional(),endstop_pin:s.z.string().optional(),uart_pin:s.z.string().optional(),rx_pin:s.z.string().optional(),tx_pin:s.z.string().optional(),cs_pin:s.z.string().optional()}),E=$.extend({title:s.z.string(),uart_address:s.z.string().optional(),spi_bus:s.z.string().optional(),spi_software_mosi_pin:s.z.string().optional(),spi_software_miso_pin:s.z.string().optional(),spi_software_sclk_pin:s.z.string().optional()}).refine(e=>hasSPI(e)||hasUART(e),{message:"Motor slot must have either SPI or UART pins"});E.innerType().omit({title:!0}).partial();let R=s.z.string(),reversePinLookup=(e,t)=>{let r=Object.entries(t.motorSlots??{});for(let[t,o]of r)if(Object.entries(e).every(([e,t])=>o[e]===t))return t},A=s.z.string().brand("BoardID"),N=s.z.string().brand("BoardPath"),I=s.z.string().brand("BoardSerialPath"),O=s.z.record(s.z.nativeEnum(m.po).or(s.z.string()),m.MI),k=s.z.record(R,E),F=s.z.object({id:A,isToolboard:s.z.boolean().optional(),isHost:s.z.boolean().optional(),serialPath:I.optional(),boardImageFileName:s.z.string().optional(),manualFileName:s.z.string().optional(),wireDiagramFileName:s.z.string().optional(),name:s.z.string(),manufacturer:s.z.string(),firmwareBinaryName:s.z.string(),compileScript:s.z.string(),flashScript:s.z.string().optional(),flashInstructions:s.z.string().optional(),disableAutoFlash:s.z.boolean().optional(),documentationLink:s.z.string().optional(),hasQuirksFiles:s.z.boolean().optional(),driverCount:s.z.number(),integratedDrivers:O.optional(),extruderlessConfig:s.z.string().optional(),fourPinFanConnectorCount:s.z.number().optional(),driverVoltages:m.v6.array().default([24]),hasMcuTempSensor:s.z.boolean().default(!0),thermistorPullup:s.z.number().default(4700),alternativePT1000Resistor:s.z.number().optional(),invertPinLogic:s.z.array(s.z.string()).default([]),customSections:s.z.record(s.z.string().regex(/^\S+$/),s.z.object({name:s.z.string().optional(),parameters:s.z.record(s.z.string().regex(/^\S+$/),s.z.string().or(s.z.number()).or(s.z.boolean())),comments:s.z.array(s.z.string()).default([])})).optional(),motorSlots:s.z.record(R,E).optional(),outputPins:s.z.array(s.z.object({pin:s.z.string(),name:s.z.string(),value:s.z.number().min(0).max(1)})).optional(),dfu:s.z.object({dfuBootImage:s.z.string(),flashDevice:s.z.string(),instructions:s.z.array(s.z.string()),reminder:s.z.string().optional(),hasBoot0Jumper:s.z.boolean()}).optional(),stepperSPI:s.z.object({software:s.z.object({sclk:s.z.string(),mosi:s.z.string(),miso:s.z.string()})}).or(s.z.object({hardware:s.z.object({bus:s.z.string()})})).optional(),ADXL345SPI:s.z.object({cs_pin:s.z.string()}).and(s.z.object({software:s.z.object({sclk:s.z.string(),mosi:s.z.string(),miso:s.z.string()})}).or(s.z.object({hardware:s.z.object({bus:s.z.string()})}))).optional(),LIS2DW:s.z.object({cs_pin:s.z.string()}).and(s.z.object({software:s.z.object({sclk:s.z.string(),mosi:s.z.string(),miso:s.z.string()})}).or(s.z.object({hardware:s.z.object({bus:s.z.string()})}))).optional(),path:N}).and(s.z.object({isToolboard:s.z.literal(!0),motorSlots:s.z.undefined()}).or(s.z.object({motorSlots:k})).or(s.z.object({isHost:s.z.literal(!0),motorSlots:s.z.undefined()}))),L=F.and(s.z.object({detected:s.z.boolean()})),D=s.z.object({id:s.z.string(),disableAutoFlash:s.z.literal(!1).optional(),isToolboard:s.z.boolean().optional(),compileScript:s.z.string(),flashScript:s.z.string(),path:N}),M=F.and(s.z.object({isToolboard:s.z.literal(!0),isHost:s.z.literal(!1).optional(),integratedDrivers:O.and(s.z.object({[m.po.extruder]:s.z.string()}))})),j=M.and(s.z.object({detected:s.z.boolean()}));var H=r(22353),B=r(24580),W=r.n(B);let q=new(W())({useClones:!1}),U=new Map,V=new(W())({useClones:!1}),G=new Map,cacheAsyncMetadataFn=(e,t,r)=>async o=>{let i=r.get(`${t}-${o}`);if(null==i){let i=G.get(`${t}-${o}`);null==i&&(i=e(o),G.set(`${t}-${o}`,i));let n=await i;return r.set(`${t}-${o}`,n),n}return i},parseMetadata=async(e,t)=>{if(""===e.trim())return null;let r=await (0,f.promisify)(d.exec)(`sed -n '/^# {/{:a; N; /\\n# }/!ba; p}' ${e}`),o=r.stdout.split("\n").map(e=>e.trim()).filter(e=>""!==e).map(e=>0===e.indexOf("#")?e.substring(1):e);if(0===o.length)return null;try{let r=JSON.parse(o.join("\n"));r.path=e;let i=e.split("/").pop();if(null==i)throw Error("File name couldn't be parsed from path: "+e);return r.id=i.replace(/\.cfg$/g,""),t.parse(r)}catch(t){throw t instanceof Error&&(0,l.getLogger)().error(t.message),Error("Failed to parse JSON from file: "+e+" with content: "+o.join("\n"))}},parsePinValue=e=>{if(!("null"===e||e.startsWith("<")&&e.endsWith(">")))return e},K=cacheAsyncMetadataFn(async e=>{let t=(0,H.xg)(),r=await (0,f.promisify)(d.exec)(`python3 ${h().join(t,"initojson.py")} ${e}`),o=JSON.parse(r.stdout);if(null==o)throw Error("Failed to parse config file: "+e);let i=Object.keys(o).find(e=>e.startsWith("board_pins"));if(null==i)throw Error("Failed to find board pin section in config file: "+e);let n=o[i].aliases.map(e=>e.replace(",","")),a=o[i].aliases.filter(e=>!e.includes("="));if(a.length>0)throw Error('Board pin aliases do not parse correctly, got "'+a.join(", ")+'"');let s={};return n.forEach(e=>{let t=e.split("=");if(t.length>2)throw Error('Board pin aliases do not parse correctly, got "'+e+'"');s[t[0]]=parsePinValue(t[1])}),s},"parsePinAlias",V),parseBoardPinConfig=async(e,t)=>{let r=h().join(e.path,e.isToolboard?"toolboard-config.cfg":t&&null!=e.extruderlessConfig?e.extruderlessConfig:"config.cfg"),o=e.isToolboard?w:t?v:y;return o.parse(await K(r))};cacheAsyncMetadataFn(async e=>{if(!(0,p.existsSync)(e))throw Error("Firmware config file does not exist: "+e);let t=(0,p.createReadStream)(e),r=(0,g.createInterface)({input:t,crlfDelay:1/0}),o='CONFIG_MCU="';for await(let e of r)if(e.startsWith(o))return e.substring(o.length,e.length-2);throw Error("Failed to find MCU in firmware config file: "+e)},"extractMcuFromFirmwareConfig",V);let X=(o=e=>{let t=_.serverSchema.parse(process.env),r=h().join(t.RATOS_CONFIGURATION_PATH,"extruders",e+".cfg"),o=(0,H.xg)(),i=(0,d.execSync)(`python3 ${h().join(o,"initojson.py")} ${r}`),n=JSON.parse(i.toString());if(null==n)throw Error("Failed to parse config file: "+r);let a=Object.keys(n).find(e=>e.startsWith("extruder"));if(null==a)throw Error("Failed to find extruder section in config file: "+r);let s=n[a];if(null==s||null==s.rotation_distance)throw Error("Failed to find extruder rotation distance");return s.rotation_distance},i="getExtruderRotationDistance",e=>{let t=V.get(`${i}-${e}`);if(null==t){let t=o(e);return V.set(`${i}-${e}`,t),t}return t}),readInclude=e=>{let t=_.serverSchema.parse(process.env),r=h().join(t.RATOS_CONFIGURATION_PATH,e);if(!(0,p.existsSync)(r))throw Error("Included file doesn't exist: "+e);return(0,p.readFileSync)(r,"utf-8")},stripIncludes=e=>stripLinesStartingWith(e,"[include"),stripCommentLines=e=>stripLinesStartingWith(e,"#"),stripLinesStartingWith=(e,t)=>e.split("\n").filter(e=>!e.trim().startsWith(t)).join("\n"),stripDriverSections=e=>{let t=!1;return e.split("\n").map(e=>{if(e.trim().startsWith("[tmc")&&(t=!0),t){if(!e.trim().startsWith("["))return null;t=!1}return e}).filter(e=>null!=e).join("\n")},replaceLinesStartingWith=(e,t,r)=>e.split("\n").map(e=>e.trim().startsWith(t)?r:e).filter(e=>null!==e).join("\n");var Y=r(20997),Z=r(41169),J=r(5873);let Q=s.z.union([s.z.literal("rose"),s.z.literal("red"),s.z.literal("yellow"),s.z.literal("orange"),s.z.literal("green"),s.z.literal("lime"),s.z.literal("blue"),s.z.literal("sky"),s.z.literal("indigo"),s.z.literal("purple"),s.z.literal("pink"),s.z.literal("brand"),s.z.literal("gray"),s.z.literal("plain")]),ee=(0,Z.cva)("",{variants:{color:{rose:"text-rose-700 dark:text-rose-400",red:"text-red-700 dark:text-red-400",yellow:"text-yellow-800 dark:text-yellow-500",orange:"text-orange-800 dark:text-orange-500",green:"text-green-700 dark:text-green-400",lime:"text-lime-700 dark:text-lime-400",blue:"text-blue-700 dark:text-blue-400",sky:"text-sky-700 dark:text-sky-400",indigo:"text-indigo-700 dark:text-indigo-400",purple:"text-purple-700 dark:text-purple-400",pink:"text-pink-700 dark:text-pink-400",brand:"text-brand-700 dark:text-brand-400",gray:"text-zinc-600 dark:text-zinc-400",plain:"text-zinc-900 dark:text-zinc-100"}}}),et=(0,Z.cva)("",{variants:{color:{rose:"bg-rose-50 dark:bg-rose-400/10",red:"bg-red-50 dark:bg-red-400/10",yellow:"bg-yellow-50 dark:bg-yellow-400/10",orange:"bg-orange-50 dark:bg-orange-400/10",green:"bg-green-50 dark:bg-green-500/10",lime:"bg-lime-50 dark:bg-lime-500/10",blue:"bg-blue-50 dark:bg-blue-400/10",sky:"bg-sky-50 dark:bg-sky-400/10",indigo:"bg-indigo-50 dark:bg-indigo-400/10",purple:"bg-purple-50 dark:bg-purple-400/10",pink:"bg-pink-50 dark:bg-pink-400/10",brand:"bg-brand-100 dark:bg-brand-400/10",gray:"bg-zinc-50 dark:bg-zinc-400/10",plain:"bg-zinc-900/10 dark:bg-zinc-100/10"}}}),er=(0,Z.cva)("",{variants:{color:{rose:"border-rose-600/10 dark:border-rose-400/20 ring-rose-600/10 dark:ring-rose-400/20",red:"border-red-600/10 dark:border-red-400/20 ring-red-600/10 dark:ring-red-400/20",yellow:"border-yellow-600/20 dark:border-yellow-400/20 ring-yellow-600/20 dark:ring-yellow-400/20",orange:"border-orange-600/20 dark:border-orange-400/20 ring-orange-600/20 dark:ring-orange-400/20",green:"border-green-600/20 dark:border-green-500/20 ring-green-600/20 dark:ring-green-500/20",lime:"border-lime-600/20 dark:border-lime-500/20 ring-lime-600/20 dark:ring-lime-500/20",blue:"border-blue-700/10 dark:border-blue-400/30 ring-blue-700/10 dark:ring-blue-400/30",sky:"border-sky-700/10 dark:border-sky-400/30 ring-sky-700/10 dark:ring-sky-400/30",indigo:"border-indigo-700/10 dark:border-indigo-400/30 ring-indigo-700/10 dark:ring-indigo-400/30",purple:"border-purple-700/10 dark:border-purple-400/30 ring-purple-700/10 dark:ring-purple-400/30",pink:"border-pink-700/10 dark:border-pink-400/20 ring-pink-700/10 dark:ring-pink-400/20",brand:"border-brand-600/40 dark:border-brand-400/30 ring-brand-600/40 dark:ring-brand-400/30",gray:"border-zinc-500/10 dark:border-zinc-400/20 ring-zinc-500/10 dark:ring-zinc-400/20",plain:"border-zinc-900 dark:border-zinc-100 ring-zinc-900 dark:ring-zinc-100"}}});(0,Z.cva)("flex-0 inline-flex w-auto items-center rounded-md font-medium ring-1 ring-inset",{variants:{size:{sm:"px-1.5 gap-1.5 py-1 text-2xs leading-3",md:"px-2 gap-2 py-1 text-xs leading-4",lg:"px-2 gap-2 py-1 text-xs leading-6"},color:{rose:[et({color:"rose"}),er({color:"rose"}),ee({color:"rose"})],red:[et({color:"red"}),er({color:"red"}),ee({color:"red"})],yellow:[et({color:"yellow"}),er({color:"yellow"}),ee({color:"yellow"})],orange:[et({color:"orange"}),er({color:"orange"}),ee({color:"orange"})],green:[et({color:"green"}),er({color:"green"}),ee({color:"green"})],lime:[et({color:"lime"}),er({color:"lime"}),ee({color:"lime"})],blue:[et({color:"blue"}),er({color:"blue"}),ee({color:"blue"})],sky:[et({color:"sky"}),er({color:"sky"}),ee({color:"sky"})],indigo:[et({color:"indigo"}),er({color:"indigo"}),ee({color:"indigo"})],purple:[et({color:"purple"}),er({color:"purple"}),ee({color:"purple"})],pink:[et({color:"pink"}),er({color:"pink"}),ee({color:"pink"})],brand:[et({color:"brand"}),er({color:"brand"}),ee({color:"brand"})],gray:[et({color:"gray"}),er({color:"gray"}),ee({color:"gray"})],plain:[et({color:"plain"}),er({color:"plain"}),ee({color:"plain"})]}},defaultVariants:{size:"md",color:"gray"}});let eo=["EPCOS 100K B57560G104F","ATC Semitec 104GT-2","ATC Semitec 104NT-4-R025H42G","Generic 3950","Honeywell 100K 135-104LAG-J01","NTC 100K MGB18-104F39050L32","SliceEngineering 450","TDK NTCG104LH104JT1","PT1000"],ei="";if(process.env.RATOS_CONFIGURATION_PATH){let e=_.serverSchema.parse(process.env);ei=e.RATOS_CONFIGURATION_PATH}let en=s.z.object({path:s.z.string().startsWith(ei).endsWith(".cfg"),id:s.z.string()}),ea=s.z.enum(eo),es=en.extend({type:s.z.literal("hotend"),title:s.z.string(),thermistor:s.z.enum(eo),flowType:s.z.union([s.z.literal("sf"),s.z.literal("hf"),s.z.literal("uhf")])}),el=s.z.object({type:s.z.enum(["Regular","CHT"]),diameter:s.z.number().min(.2).max(1.8)}),ed=en.extend({type:s.z.literal("extruder"),stepper:m.vF.shape.id.optional(),current:m.P6.shape.current.optional(),title:s.z.string()}),ep=en.extend({type:s.z.literal("static-probe").or(s.z.literal("stowable-probe")),title:s.z.string()}),ec=s.z.object({id:s.z.enum(["endstop","endstop-toolboard","sensorless"]),title:s.z.string(),badge:s.z.array(s.z.object({children:s.z.string(),color:Q})).optional()}),eu=s.z.union([s.z.literal("toolboard_t0"),s.z.literal("toolboard_t1"),s.z.literal("controlboard"),s.z.literal("rpi"),s.z.literal("beacon")]),eh=s.z.union([s.z.literal("adxl345"),s.z.literal("lis2dw"),s.z.literal("beacon")]),eg=s.z.object({id:s.z.enum(["toolboard","controlboard","sbc","none","beacon"]),title:s.z.string(),accelerometerType:eh.default("adxl345").optional()}),ef=s.z.object({name:eu,type:eh});eg.extend({accelerometerType:eh});let e_=s.z.object({id:s.z.enum(["2pin","4pin","4pin-dedicated","2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard","none"]),title:s.z.string(),badge:s.z.array(s.z.object({children:s.z.string(),color:Q})).optional()}),getDefaultNozzle=()=>({diameter:.4,type:"Regular"}),em=s.z.object({hotend:es,thermistor:ea,extruder:ed,xEndstop:ec,yEndstop:ec,hotendFan:e_,partFan:e_,nozzle:el.default(getDefaultNozzle()),xAccelerometer:eg.optional().nullable(),yAccelerometer:eg.optional().nullable(),toolboard:M.nullable(),probe:ep.optional(),axis:s.z.literal(m.po.x).or(s.z.literal(m.po.dual_carriage)),description:s.z.string().optional(),toolNumber:s.z.number().optional()}).strict(),eb=s.z.union([s.z.literal(0),s.z.literal(1)]),ez=s.z.union([s.z.literal(m.po.x),s.z.literal(m.po.dual_carriage),s.z.literal(m.po.extruder),s.z.literal(m.po.extruder1)]),eT=s.z.union([ez,eb]),ex=em.refine(e=>null!==e.toolboard||"endstop-toolboard"!==e.xEndstop.id,"Cannot use toolboard endstop without a toolboard").refine(e=>null!==e.toolboard||!["2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard"].includes(e.hotendFan.id),"Cannot use toolboard hotend fan without a toolboard").refine(e=>null!==e.toolboard||!["2pin-toolboard","4pin-toolboard","4pin-dedicated-toolboard"].includes(e.partFan.id),"Cannot use toolboard part cooling fan without a toolboard"),eP=em.partial().optional(),ey=em.extend({hotend:es.shape.id,extruder:ed.shape.id,thermistor:ea,xEndstop:ec.shape.id,yEndstop:ec.shape.id,hotendFan:e_.shape.id,partFan:e_.shape.id,xAccelerometer:eg.shape.id.optional().nullable(),yAccelerometer:eg.shape.id.optional().nullable(),toolboard:A.optional().nullable(),probe:ep.shape.id.optional().nullable()}).strict(),ev=ey.partial().optional(),ew="";if(process.env.RATOS_CONFIGURATION_PATH){let e=_.serverSchema.parse(process.env);ew=h().join(e.RATOS_CONFIGURATION_PATH,"printers")}let eC=s.z.object({velocity:s.z.number().min(0).describe("Maximum velocity for this printer"),accel:s.z.number().min(0).describe("Maximum acceleration for this printer"),z_velocity:s.z.number().min(0).describe("Maximum z velocity for this printer"),z_accel:s.z.number().min(0).describe("Maximum z acceleration for this printer"),square_corner_velocity:s.z.number().min(0).default(5).describe("Maximum square corner velocity for this printer"),travel_velocity:s.z.number().min(0).default(200).describe("Maximum travel velocity for this printer"),travel_accel:s.z.number().min(0).default(3e3).describe("Maximum travel velocity for this printer")}).strict(),eS=s.z.object({x:s.z.number().min(0).describe("The print volume in X"),y:s.z.number().min(0).describe("The print volume in Y"),z:s.z.number().min(0).describe("The print volume in Z")}).describe("The print volume of a printer"),e$=s.z.object({id:s.z.string().transform(e=>"caramba-chonk"===e?"v-chonk":e.startsWith("caramba-")?e.replace("caramba-","v-core-4-"):e),name:s.z.string().describe("The name of the printer"),releaseDate:s.z.string().optional().describe("The release date of the printer in ISO 8601/RFC3339 eg. 2023-12-31"),description:s.z.string().describe("A description of the printer"),manufacturer:s.z.string().describe("The name of the manufacturer of this printer"),documentationLink:s.z.string().describe("Link to the RatOS documentation for this printer"),image:s.z.string().describe("Link to an image of the printer"),sizes:s.z.record(s.z.string(),eS).describe("Size options for this printer"),template:s.z.string().describe("Printer.cfg template for this printer"),path:s.z.string().startsWith(ew),driverCountRequired:s.z.number().describe("Number of drivers required for this printer"),kinematics:s.z.union([s.z.literal("cartesian"),s.z.literal("corexy"),s.z.literal("hybrid-corexy"),s.z.literal("hybrid-corexy-idex")]).optional(),bedMargin:s.z.object({x:s.z.tuple([s.z.number().default(0),s.z.number().default(0)]),y:s.z.tuple([s.z.number().default(0),s.z.number().default(0)])}).describe("Margin of available movement around the bed for this printer").default({x:[0,0],y:[0,0]}),speedLimits:s.z.object({basic:eC,performance:eC.optional()}).strict().describe("Speed limits for this printer"),defaults:s.z.object({toolheads:s.z.array(ey).describe("Default toolheads for this printer"),board:A.describe("Default board for this printer. Should be the name of the board directory."),rails:s.z.array(m.r).describe("Default rails for this printer"),controllerFan:e_.shape.id.optional().describe("Default controller fan for this printer")}).strict().describe("Default hardware for this printer")}).describe("A RatOS supported 3d printer"),eE=e$.extend({defaults:e$.shape.defaults.extend({toolheads:s.z.array(ex)}).strict()}),eR=s.z.array(m.HB).parse([{id:"LDO-TMC2209",title:"LDO TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"LDO-NITEHAWK-TMC2209",title:"LDO TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.1,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"LDO-TMC5160-HV",title:"LDO TMC5160 HV",type:"TMC5160",protocol:"SPI",senseResistor:.075,voltages:[24,36,48],maxCurrent:3,coolingCurrentThreshold:1.5},{id:"BTT-KRAKEN-2160-PLUS",title:"BTT TMC2160 PLUS",type:"TMC5160",protocol:"SPI",senseResistor:.022,voltages:[24,36,48,56,60],maxCurrent:8,coolingCurrentThreshold:3},{id:"BTT-KRAKEN-2160",title:"BTT TMC2160",type:"TMC5160",protocol:"SPI",senseResistor:.075,voltages:[24,36,48,56,60],maxCurrent:3,coolingCurrentThreshold:1.5},{id:"BTT-TMC2209-13",title:"BTT TMC2209 v1.3",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"BTT-TMC2226-10",title:"BTT TMC2226 v1.0",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"BTT-TMC5160-PRO-11",title:"BTT TMC5160(T) Pro v1.1",type:"TMC5160",protocol:"SPI",senseResistor:.075,voltages:[24,36,48,56],maxCurrent:3,coolingCurrentThreshold:1.5},{id:"BTT-TMC5160T-PLUS-10",title:"BTT TMC5160T Plus v1.0",type:"TMC5160",protocol:"SPI",senseResistor:.022,voltages:[24,36,48,56,60],maxCurrent:10.6,coolingCurrentThreshold:3,external:!0},{id:"BTT-EZ2209",title:"BTT EZ2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.3,voltages:[24],maxCurrent:2},{id:"BTT-EZ2226",title:"BTT EZ2226",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.3,voltages:[24],maxCurrent:2},{id:"BTT-EZ2130",title:"BTT EZ2130",type:"TMC2130",protocol:"SPI",senseResistor:.11,coolingCurrentThreshold:.9,voltages:[24],maxCurrent:2},{id:"BTT-EZ5160-PRO",title:"BTT EZ5160 Pro",type:"TMC5160",protocol:"SPI",senseResistor:.075,coolingCurrentThreshold:1.6,voltages:[24,36,48],maxCurrent:2.5},{id:"BTT-EZ5160-RGB",title:"BTT EZ5160 RGB",type:"TMC5160",protocol:"SPI",senseResistor:.05,coolingCurrentThreshold:3,voltages:[24,48,36,56],maxCurrent:4.7},{id:"BTT-TMC2240-10",title:"BTT TMC2240 v1.0",type:"TMC2240",protocol:"SPI",coolingCurrentThreshold:1.1,voltages:[24,36],maxCurrent:2.1},{id:"LDO-2240-UART",title:"LDO TMC2240 UART",type:"TMC2240",protocol:"UART",coolingCurrentThreshold:1.1,voltages:[24,36],maxCurrent:2.1},{id:"MELLOW-FLY-HV-TMC5160-PRO-12",title:"Mellow FLY HV TMC5160 Pro v1.2",type:"TMC5160",protocol:"SPI",senseResistor:.033,coolingCurrentThreshold:3,voltages:[24,36,48],maxCurrent:4.25,external:!0},{id:"MELLOW-FLY-TMC2209",title:"Mellow FLY TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2},{id:"PRUSA-EINSY-RAMBO-TMC2130",title:"Prusa Einsy Rambo TMC2130",type:"TMC2130",protocol:"SPI",senseResistor:.22,coolingCurrentThreshold:.9,voltages:[24],maxCurrent:2},{id:"PRUSA-BUDDY-TMC2209",title:"Prusa Buddy TMC2209",type:"TMC2209",protocol:"UART",senseResistor:.11,coolingCurrentThreshold:1.1,voltages:[24],maxCurrent:2}]),findPreset=(e,t,r,o,i)=>e.presets?.slice().sort((e,t)=>i?t.run_current-e.run_current:e.run_current-t.run_current).find(e=>e.driver===t.type&&e.voltage===r&&("TMC2240"===t.type||"sense_resistor"in e&&e.sense_resistor===t.senseResistor)&&(null==o||e.run_current===o)),eA=s.z.array(m.vF).parse([{id:"generic",title:"Generic Stepper",maxPeakCurrent:2.8},{id:"BONDTECH-42H025H-0704-002",title:"Bondtech LGX Stepper",maxPeakCurrent:.7},{id:"LDO-42STH48-2504AC",title:"LDO-42STH48-2504AC",maxPeakCurrent:2.5,presets:[{run_current:1.1,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:1,driver_TOFF:3,driver_HEND:0,driver_HSTRT:0},{run_current:1.6,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:2,driver_TOFF:3,driver_HEND:0,driver_HSTRT:6},{run_current:1.6,voltage:24,driver:"TMC5160",sense_resistor:.075,driver_TBL:2,driver_TOFF:3,driver_HEND:0,driver_HSTRT:6},{run_current:1.768,voltage:48,driver:"TMC5160",sense_resistor:.075,driver_TBL:0,driver_TOFF:4,driver_HEND:0,driver_HSTRT:4}]},{id:"LDO-42STH40-1684AC",title:"LDO-42STH40-1684AC",maxPeakCurrent:1.68,presets:[{run_current:.4,voltage:24,driver:"TMC2130",sense_resistor:.22,driver_IHOLDDELAY:8,driver_TPOWERDOWN:0,driver_TBL:2,driver_TOFF:3,driver_HEND:1,driver_HSTRT:5,driver_PWM_FREQ:2,driver_PWM_GRAD:2,driver_PWM_AMPL:230,driver_PWM_AUTOSCALE:!0,driver_SGT:5},{run_current:.52,voltage:24,driver:"TMC2130",sense_resistor:.22,driver_IHOLDDELAY:8,driver_TPOWERDOWN:0,driver_TBL:2,driver_TOFF:3,driver_HEND:1,driver_HSTRT:5,driver_PWM_FREQ:2,driver_PWM_GRAD:4,driver_PWM_AMPL:240,driver_PWM_AUTOSCALE:!0,driver_SGT:3},{run_current:.8,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:1,driver_TOFF:3,driver_HEND:3,driver_HSTRT:0},{run_current:1.188,voltage:24,driver:"TMC2209",sense_resistor:.11,driver_TBL:0,driver_TOFF:3,driver_HEND:0,driver_HSTRT:0}]},{id:"LDO-42STH48-2004MAH",title:"LDO-42STH48-2004MAH",maxPeakCurrent:2,fullStepsPerRotation:400},{id:"LDO-42STH48-2004AC",title:"LDO-42STH48-2004AC",maxPeakCurrent:2},{id:"LDO-42STH25-1404MAC",title:"LDO-42STH25-1404MAC",maxPeakCurrent:1.4,fullStepsPerRotation:400,presets:[{voltage:24,driver:"TMC2209",sense_resistor:.11,run_current:.85,driver_TBL:1,driver_TOFF:3,driver_HEND:2,driver_HSTRT:0},{voltage:24,driver:"TMC2209",sense_resistor:.11,run_current:1,driver_TBL:2,driver_TOFF:3,driver_HEND:3,driver_HSTRT:0}]},{id:"LDO-42STH25-1004CL200E",title:"LDO-42STH25-1004CL200E",maxPeakCurrent:1},{id:"LDO-36STH20-1004AHG",title:"LDO-36STH20-1004AHG",maxPeakCurrent:1,presets:[{voltage:24,driver:"TMC2209",sense_resistor:.11,run_current:.707,driver_TBL:0,driver_HEND:6,driver_HSTRT:7,driver_TOFF:4}]},{id:"LDO-36STH17-1004AHG",title:"LDO-36STH17-1004AHG",maxPeakCurrent:1},{id:"LDO-35STH48-1684AH",title:"LDO-35STH48-1684AH",maxPeakCurrent:1.68}]),deserializeDriver=e=>eR.find(t=>t.id===e)??null,deserializeStepper=e=>eA.find(t=>t.id===e)??null,deserializePrinterRail=e=>{let t=deserializeStepper(e.stepper),r=deserializeDriver(e.driver);if(null==t)throw Error(`Stepper ${e.stepper} not found in database`);if(null==r)throw Error(`Driver ${e.driver} not found in database`);return m.g6.parse({...e,stepper:t,driver:r})},deserializePrinterRailDefinition=e=>{let t=deserializeStepper(e.stepper),r=deserializeDriver(e.driver);if(null==t)throw Error(`Stepper ${e.stepper} not found in database`);if(null==r)throw Error(`Driver ${e.driver} not found in database`);return m.P6.parse({...e,stepper:t,driver:r})},stringToTitleObject=e=>({id:e,title:e}),serializePrinterRail=e=>m.Ah.parse({...e,driver:e.driver.id,stepper:e.stepper.id}),serializeToolheadConfiguration=e=>({...e,toolboard:e.toolboard?.id,hotend:e.hotend.id,thermistor:e.thermistor,extruder:e.extruder.id,probe:e.probe?.id,xEndstop:e.xEndstop.id,yEndstop:e.yEndstop.id,partFan:e.partFan.id,hotendFan:e.hotendFan.id,xAccelerometer:e.xAccelerometer?.id,yAccelerometer:e.yAccelerometer?.id}),extractToolheadsFromPrinterConfiguration=e=>{let t=e?.toolheads?.map(e=>{if(null==e)throw Error("Toolhead can not be null");return new ToolheadHelper(ex.parse(e))}).filter(Boolean);if(null==t)throw Error("No toolheads found");return t},extractToolheadFromPrinterConfiguration=(e,t)=>{if(t?.toolheads==null||0===t.toolheads.length)throw Error("No toolheads preset in supplied printer config");let r=extractToolheadsFromPrinterConfiguration(t),o="number"==typeof e?r.find(t=>t.getTool()===e):r.find(t=>t.getExtruderAxis()===e||t.getMotionAxis()===e);return o};var eN=r(56988),eI=r.n(eN);let ToolheadHelper=class ToolheadHelper{constructor(e){this.config=e}hasToolboard(){return null!=this.config.toolboard}getToolboard(){return this.config.toolboard}getMotionStepperName(){return this.config.axis===m.po.dual_carriage?"dual_carriage":`stepper_${this.getMotionAxis()}`}getToolboardName(){if(null==this.config.toolboard)throw Error(`Toolhead T${this.getTool()} does not have a toolboard`);return`toolboard_${this.getShortToolName()}`}getShortToolName(){return`t${this.getTool()}`}getDescription(){return this.config.description??"the printer's toolhead"}getMotionAxis(){return this.config.axis===m.po.dual_carriage?m.po.dual_carriage:m.po.x}getExtruderAxis(){return this.config.axis===m.po.dual_carriage?m.po.extruder1:m.po.extruder}getToolCommand(){return`T${this.getTool()}`}getTool(){return this.config.axis===m.po.dual_carriage?1:0}getSerialSuffix(){return`t${this.getTool()}`}getExtruder(){return this.config.extruder}getHotend(){return this.config.hotend}getNozzle(){return this.config.nozzle??getDefaultNozzle()}getThermistor(){return this.config.thermistor}getXEndstop(){return this.config.xEndstop}getYEndstop(){return this.config.yEndstop}getXAccelerometer(){return this.config.xAccelerometer}getYAccelerometer(){return this.config.yAccelerometer}getXAccelerometerName(){switch(this.getXAccelerometer()?.id){case"controlboard":return"controlboard";case"toolboard":if(this.hasToolboard())return this.getToolboardName();case"sbc":return"rpi";case"beacon":return"beacon";default:return"controlboard"}}getYAccelerometerName(){switch(this.getYAccelerometer()?.id){case"controlboard":return"controlboard";case"toolboard":if(this.hasToolboard())return this.getToolboardName();case"sbc":return"rpi";case"beacon":return"beacon";default:return"controlboard"}}getChangeSet(e){if(null==e)return null;let t={};Object.keys(e).forEach(r=>{let o=this.getConfig()[r],i=e[r];if(null!=o&&null==i||null==o&&null!=i){t[r]=i;return}o&&i&&("object"==typeof o&&"id"in o&&"object"==typeof i&&"id"in i?o.id!==i.id&&(t[r]=i):eI()(o,i)||(t[r]=i))});let r=eP.safeParse(t);return r}getProbe(){return this.config.probe}getPartFan(){return this.config.partFan}getHotendFan(){return this.config.hotendFan}serialize(){return serializeToolheadConfiguration(this.config)}getConfig(){return{...this.config}}};let eO=s.z.union([eS,s.z.number(),s.z.string()]).nullable().optional(),ek=s.z.object({printer:e$,controlboard:F,toolheads:s.z.array(ex).min(1).max(2),size:eO,controllerFan:e_,performanceMode:s.z.boolean().default(!1),stealthchop:s.z.boolean().default(!1),standstillStealth:s.z.boolean().default(!1),rails:s.z.array(m.JQ)}).strict().transform((e,t)=>{if(null==e.size)e.size=e.printer.sizes[Object.keys(e.printer.sizes)[0]];else if("number"==typeof e.size||"string"==typeof e.size){let r=e.printer.sizes[e.size.toString()];if(null==r)return t.addIssue({code:s.z.ZodIssueCode.custom,message:`Size ${e.size} is not a valid size for a ${e.printer.name} config`}),s.z.NEVER;e.size=r}return e}),eF=ek.superRefine((e,t)=>{let r=e.toolheads.map(e=>e.toolboard).filter(Boolean).length;r+e.controlboard.driverCount<e.printer.driverCountRequired&&t.addIssue({code:s.z.ZodIssueCode.too_small,message:`Your combination of controlboard and toolboards do not have enough stepper drivers for a ${e.printer.name} config`,minimum:e.printer.driverCountRequired,inclusive:!0,type:"number"})}).superRefine((e,t)=>{let r=e.toolheads.map(e=>new ToolheadHelper(e)),o=e.rails.map((o,i)=>{let n=r.find(e=>e.getExtruderAxis()===o.axis);if(null!=o.motorSlot){let a=e.rails.filter(e=>{let t=r.find(t=>t.getExtruderAxis()===e.axis);return e.axis!==o.axis&&n?.hasToolboard()==null&&t?.hasToolboard==null&&e.motorSlot===o.motorSlot}),railName=e=>"extruder"===e?"Extruder T0":e===m.po.extruder1?"Extruder T1":"Stepper "+e.toLocaleUpperCase();return 1===a.length?t.addIssue({code:s.z.ZodIssueCode.custom,message:`Motor slot ${o.motorSlot} is already in use on ${railName(a[0].axis)}`,path:["rails",i,"motorSlot"]}):a.length>1&&t.addIssue({code:s.z.ZodIssueCode.custom,message:`Motor slot ${o.motorSlot} is already in use on ${a.slice(0,-1).map(e=>railName(e.axis)).join(", ")} and ${railName(a[a.length-1].axis)}`,path:["rails",i,"motorSlot"]}),a.length>0?{rail:o,conflicts:a}:0}return null}).filter(Boolean);o.length>0&&t.addIssue({code:s.z.ZodIssueCode.custom,message:"Motor slot conflicts detected"})}),eL=ek.innerType().extend({printer:e$.shape.id,controlboard:A,toolheads:s.z.array(ey).min(1).max(2),controllerFan:e_.shape.id,rails:s.z.array(m.Ah)}).strict(),eD=ek.innerType().extend({toolheads:s.z.array(eP).min(1).max(2)}).strict().partial().optional(),eM=eL.extend({toolheads:s.z.array(ev).min(1).max(2)}).strict().partial(),xEndstopOptions=(e,t)=>{let r=[];return t?.toolboard!=null&&r.push({id:"endstop-toolboard",title:"Physical Endstop",badge:[{color:"sky",children:`${t.toolboard.name}${null!=t.toolNumber&&` T${t.toolNumber}`}`}]}),t?.axis===m.po.x&&(r.push({id:"endstop",title:"Physical Endstop",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]}),r.push({id:"sensorless",title:"Sensorless Homing",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]})),r},yEndstopOptions=(e,t)=>[{id:"endstop",title:"Physical Endstop",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]},{id:"sensorless",title:"Sensorless Homing",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]}];var ej=r(24851);let getBoardSerialPath=(e,t)=>e.isHost&&"serialPath"in e&&null!=e.serialPath?e.serialPath:"/dev/RatOS/"+getBoardChipId(e,t),getBoardChipId=(e,t)=>{if(e.isHost)throw Error("Cannot get chip ID for a host board");return e.id+(t?`-${t.getSerialSuffix()}`:"")};let ToolheadGenerator=class ToolheadGenerator extends ToolheadHelper{static async fromConfig(e,t,r,o){let i=e.toolboard?await parseBoardPinConfig(e.toolboard):null;return new ToolheadGenerator(e,i,t,r,o)}constructor(e,t,r,o,i){super(e),this.toolboardPins=t,this.controlboardPins=r,this.printer=o,this.size=i}requireControlboardPin(e){if(this.controlboardPins?.[e]==null)throw Error(`Toolhead ${this.getTool()} is configured to use the controlboard for ${e}, but the controlboard does not define a pin with that name.`)}requireToolboardPin(e){if(this.toolboardPins?.[e]==null)throw Error(`Toolhead ${this.getTool()} is configured to use the toolboard for ${e}, but the toolboard does not define a pin with that name.`)}getExtruderToolAxisPinPrefix(){return 0===this.getTool()?"":this.getTool()}getToolboardPins(){if(null==this.toolboardPins)throw Error(`Toolboard pins not available for toolhead ${this.getToolCommand()}`);return this.toolboardPins}getToolheadPin(e,t){let r=e===this.getExtruderAxis()?this.getPinPrefix():"",o=e===m.po.z?"z0":e!==this.getExtruderAxis()?e:null!=this.getToolboard()?"e":"e"+this.getExtruderToolAxisPinPrefix(),i=o+t,n=null;try{n=this.getPinFromAlias(i)}catch(e){n=null}if(null==n)throw Error(`Pin name "${i}" constructed from axis "${e}" and alias "${t}" not found on toolhead ${this.getToolCommand()} with extruder axis ${this.getExtruderAxis()}. Resolved axis alias ${o}. Searched in ${this.getToolboard()?"toolboard":"controlboard"}`);return r+n}getPinFromAlias(e){let t=null;if(this.getToolboard()){if(this.toolboardPins?.[e]!=null)t=this.toolboardPins[e];else throw Error(`Alias "${e}" not found in toolboard pin definition.`)}else this.controlboardPins?.[e]!=null&&(t=this.controlboardPins[e]);if(null!=t)return t;throw Error(`Unknown pin alias ${e}`)}getPinFromToolboardAlias(e){let t=null,r="e1"===e.split("_")[0]?"e"+this.getExtruderToolAxisPinPrefix():e;if(!this.hasToolboard())throw Error(`Toolhead ${this.getTool()} is not configured to use a toolboard`);if(this.toolboardPins?.[r]!=null)t=this.toolboardPins[r];else throw Error(`Alias "${r}" not found in toolboard pin definition.`);if(null!=t)return t;throw Error(`Unknown pin alias ${r}`)}getXEndstopPin(){let e;switch(this.getXEndstop().id){case"endstop":if(this.controlboardPins?.x_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use the controlboard for the x endstop, but the controlboard has no x_endstop_pin`);e=this.controlboardPins.x_endstop_pin;break;case"endstop-toolboard":if(this.toolboardPins?.x_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use a toolboard for the x endstop, but the toolboard has no x_endstop_pin`);e=this.getPinPrefix()+this.toolboardPins.x_endstop_pin;break;default:throw Error(`Unknown endstop type ${this.getXEndstop().id}`)}return e}getYEndstopPin(){let e;switch(this.getYEndstop().id){case"endstop":if(this.controlboardPins?.y_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use the controlboard for the x endstop, but the controlboard has no y_endstop_pin`);e=this.controlboardPins.y_endstop_pin;break;case"endstop-toolboard":if(this.toolboardPins?.y_endstop_pin==null)throw Error(`Toolhead ${this.getTool()} is configured to use a toolboard for the x endstop, but the toolboard has no y_endstop_pin`);e=this.getPinPrefix()+this.toolboardPins.y_endstop_pin;break;default:throw Error(`Unknown endstop type ${this.getXEndstop().id}`)}return e}getPinPrefix(){return this.config.toolboard?`${this.getToolboardName()}:`:""}isToolboardPinInverted(e){return null!=e&&!!this.config.toolboard?.invertPinLogic.includes(e)}renderToolboard(e){let t=this.toolboardPins,r=this.config.toolboard;if(null==r||null==t)return"";if(null==e)throw Error("exportPinsFn is required when rendering toolboard");let o=["",e(this.getToolboardName(),r,this,this.getToolboardName()),"",`[mcu ${this.getToolboardName()}]`,`serial: ${getBoardSerialPath(r,this)}`];return r.hasMcuTempSensor&&(o.push(""),o.push(`[temperature_sensor ${r.name.replace(/\s/g,"_")}_${this.getToolCommand()}]`),o.push("sensor_type: temperature_mcu"),o.push(`sensor_mcu: ${this.getToolboardName()}`)),null!=r.ADXL345SPI&&(o.push(""),o.push(`[adxl345 ${this.getToolboardName()}]`),o.push("axes_map: x, z, y # Assumes back-facing vertical toolboard mounting"),o.push(`cs_pin: ${this.isToolboardPinInverted(r.ADXL345SPI.cs_pin)?"!":""}${this.getPinPrefix()}${r.ADXL345SPI.cs_pin}`),"hardware"in r.ADXL345SPI?o.push(`spi_bus: ${r.ADXL345SPI.hardware.bus}`):(o.push(`spi_software_mosi_pin: ${this.isToolboardPinInverted(r.ADXL345SPI.software.mosi)?"!":""}${this.getPinPrefix()}${r.ADXL345SPI.software.mosi}`),o.push(`spi_software_miso_pin: ${this.isToolboardPinInverted(r.ADXL345SPI.software.miso)?"!":""}${this.getPinPrefix()}${r.ADXL345SPI.software.miso}`),o.push(`spi_software_sclk_pin: ${this.isToolboardPinInverted(r.ADXL345SPI.software.sclk)?"!":""}${this.getPinPrefix()}${r.ADXL345SPI.software.sclk}`))),null!=r.LIS2DW&&(o.push(""),o.push(`[lis2dw ${this.getToolboardName()}]`),o.push("axes_map: x, z, y # Assumes back-facing vertical toolboard mounting"),o.push(`cs_pin: ${this.isToolboardPinInverted(r.LIS2DW.cs_pin)?"!":""}${this.getPinPrefix()}${r.LIS2DW.cs_pin}`),"hardware"in r.LIS2DW?o.push(`spi_bus: ${r.LIS2DW.hardware.bus}`):(o.push(`spi_software_mosi_pin: ${this.isToolboardPinInverted(r.LIS2DW.software.mosi)?"!":""}${this.getPinPrefix()}${r.LIS2DW.software.mosi}`),o.push(`spi_software_miso_pin: ${this.isToolboardPinInverted(r.LIS2DW.software.miso)?"!":""}${this.getPinPrefix()}${r.LIS2DW.software.miso}`),o.push(`spi_software_sclk_pin: ${this.isToolboardPinInverted(r.LIS2DW.software.sclk)?"!":""}${this.getPinPrefix()}${r.LIS2DW.software.sclk}`))),null!=r.outputPins&&r.outputPins.forEach(e=>{o.push(""),o.push(`[output_pin ${e.name}]`),o.push(`pin: ${this.isToolboardPinInverted(e.pin)?"!":""}${this.getPinPrefix()}${e.pin}`),o.push(`value: ${e.value}`)}),null!=r.customSections&&Object.keys(r.customSections).forEach(e=>{if(null==r.customSections)return;let t=r.customSections[e];o.push(""),o.push(`[${e}${t.name?` ${t.name}`:""}]`),null!=t.comments&&t.comments.forEach(e=>{o.push(`# ${e}`)}),Object.keys(t.parameters).forEach(r=>{if(null==this.toolboardPins)return;let i=t.parameters[r];if(null==i)throw Error(`Parameter "${r}" has no value in custom section "${e}"`);"string"==typeof i&&(r.endsWith("_pin")||"pin"===r||Object.values(this.toolboardPins).includes(i))?o.push(`${r}: ${this.isToolboardPinInverted(i)?"!":""}${this.getPinPrefix()}${i}`):"boolean"==typeof i||"true"===i.toString().trim().toLowerCase()||"false"===i.toString().trim().toLowerCase()?o.push(`${r}: ${!0===i||"true"===i.toString().trim().toLowerCase()?"True":"False"}`):o.push(`${r}: ${i}`)})}),o.join("\n")}renderHotend(e){let t=[],r=readInclude(`hotends/${this.getHotend().id}.cfg`);r=replaceLinesStartingWith(r=stripIncludes(r=stripCommentLines(r)),"[extruder]",`[${this.getExtruderAxis()}]`),r=replaceLinesStartingWith(r,"heater_pin",`heater_pin: ${this.getToolheadPin(this.getExtruderAxis(),"_heater_pin")}`),r=replaceLinesStartingWith(r,"sensor_pin",`sensor_pin: ${this.getToolheadPin(this.getExtruderAxis(),"_sensor_pin")}`);let o=this.getToolboard()?.alternativePT1000Resistor??e.alternativePT1000Resistor,i=this.getToolboard()?.thermistorPullup??e.thermistorPullup,n="PT1000"===this.getThermistor()&&null!=o?o:i;return r=r.split("\n").some(e=>e.trim().startsWith("pullup_resistor"))?replaceLinesStartingWith(r,"pullup_resistor",`pullup_resistor: ${n}`):replaceLinesStartingWith(r,"sensor_type",`sensor_type: ${this.getThermistor()}
pullup_resistor: ${n}`),4700===n&&(r=replaceLinesStartingWith(r,"pullup_resistor: 4700",null)),r=r.split("\n").some(e=>e.trim().startsWith("nozzle_diameter"))?replaceLinesStartingWith(r,"nozzle_diameter",`nozzle_diameter: ${this.getNozzle().diameter}`):replaceLinesStartingWith(r,`[${this.getExtruderAxis()}]`,`[${this.getExtruderAxis()}]
nozzle_diameter: ${this.getNozzle().diameter}`),t.push(`# ${this.getToolCommand()} ${this.getHotend().title} definition (from RatOS/hotends/${this.getHotend().id}.cfg)`),t.push(r.trim()),t.join("\n")}renderExtruder(){let e=[];e.push(`# ${this.getToolCommand()} ${this.getExtruder().title} definition (from RatOS/extruders/${this.getExtruder().id}.cfg)`);let t=stripCommentLines(stripIncludes(stripDriverSections(readInclude(`extruders/${this.getExtruder().id}.cfg`))));return e.push((t=replaceLinesStartingWith(t,"[extruder]",`[${this.getExtruderAxis()}]`)).trim()),e.join("\n")}renderPartFan(e=!1,t){let r=[];if(e){let e=`part_fan_${this.getShortToolName()}`;r.push(`[fan_generic ${e}]`)}else r.push("[fan]");switch(this.getPartFan().id){case"2pin":this.requireControlboardPin("fan_part_cooling_pin"),r.push(`# 2-pin fan connected to 2-pin header on ${t.name} - input voltage pwm`),r.push(`pin: ${this.controlboardPins?.fan_part_cooling_pin}`);break;case"4pin":this.requireControlboardPin("fan_part_cooling_pin"),r.push(`# 4-pin fan connected to 2-pin header on ${t.name} - digital pwm`),r.push(`pin: !${this.controlboardPins?.fan_part_cooling_pin}`),r.push("cycle_time:  0.00004");break;case"4pin-dedicated":this.requireControlboardPin("4p_fan_part_cooling_pin"),r.push(`# 4-pin fan connected to 4-pin header on ${t.name} - digital pwm`),r.push(`pin: ${this.controlboardPins?.["4p_fan_part_cooling_pin"]}`),r.push("cycle_time:  0.00004"),this.controlboardPins?.["4p_fan_part_cooling_tach_pin"]!=null&&(r.push(`tachometer_pin: ^${this.controlboardPins?.["4p_fan_part_cooling_tach_pin"]}`),r.push("tachometer_poll_interval: 0.0005"));break;case"2pin-toolboard":this.requireToolboardPin("fan_part_cooling_pin"),r.push(`# 2-pin fan connected to 2-pin header on T${this.getTool()} (${this.getToolboard()?.name}) - input voltage pwm`),r.push(`pin: ${this.isToolboardPinInverted(this.toolboardPins?.fan_part_cooling_pin)?"!":""}${this.getPinPrefix()}${this.toolboardPins?.fan_part_cooling_pin}`);break;case"4pin-toolboard":this.requireToolboardPin("fan_part_cooling_pin"),r.push(`# 4-pin fan connected to 2-pin header on T${this.getTool()} (${this.getToolboard()?.name}) - digital pwm`),r.push(`pin: ${this.isToolboardPinInverted(this.toolboardPins?.fan_part_cooling_pin)?"":"!"}${this.getPinPrefix()}${this.toolboardPins?.fan_part_cooling_pin}`),r.push("cycle_time:  0.00004");break;case"4pin-dedicated-toolboard":this.requireToolboardPin("4p_fan_part_cooling_pin"),r.push(`# 4-pin fan connected to 4-pin header on T${this.getTool()} (${this.getToolboard()?.name}) - digital pwm`),r.push(`pin: ${this.isToolboardPinInverted(this.toolboardPins?.["4p_fan_part_cooling_pin"])?"!":""}${this.getPinPrefix()}${this.toolboardPins?.["4p_fan_part_cooling_pin"]}`),r.push("cycle_time:  0.00004"),this.toolboardPins?.["4p_fan_part_cooling_tach_pin"]!=null&&(r.push(`tachometer_pin: ^${this.isToolboardPinInverted(this.toolboardPins?.["4p_fan_part_cooling_tach_pin"])?"!":""}${this.toolboardPins?.["4p_fan_part_cooling_tach_pin"]}`),r.push("tachometer_poll_interval: 0.0005"));break;default:throw Error(`Unsupported part cooling fan option "${this.getHotendFan().title}"`)}return r.join("\n")}renderHotendFan(e){let t=[`[heater_fan toolhead_cooling_fan${this.getTool()>0?`_${this.getShortToolName()}`:""}]`,`heater: ${this.getExtruderAxis().toLocaleLowerCase()}`];switch(this.getHotendFan().id){case"2pin":this.requireControlboardPin("fan_toolhead_cooling_pin"),t.push(`# 2-pin fan connected to 2-pin header on ${e.name} - input voltage pwm`),t.push(`pin: ${this.controlboardPins?.fan_toolhead_cooling_pin}`);break;case"4pin":this.requireControlboardPin("fan_toolhead_cooling_pin"),t.push(`# 4-pin fan connected to 2-pin header on ${e.name} - digital pwm`),t.push(`pin: !${this.controlboardPins?.fan_toolhead_cooling_pin}`),t.push("cycle_time:  0.00004");break;case"4pin-dedicated":this.requireControlboardPin("4p_toolhead_cooling_tach_pin"),t.push(`# 4-pin fan connected to 4-pin header on ${e.name} - digital pwm`),t.push(`pin: ${this.controlboardPins?.["4p_toolhead_cooling_tach_pin"]}`),t.push("cycle_time:  0.00004"),this.controlboardPins?.["4p_toolhead_cooling_tach_pin"]!=null&&(t.push(`tachometer_pin: ^${this.controlboardPins?.["4p_toolhead_cooling_tach_pin"]}`),t.push("tachometer_poll_interval: 0.0005"));break;case"2pin-toolboard":this.requireToolboardPin("fan_toolhead_cooling_pin"),t.push(`# 2-pin fan connected to 2-pin header on T${this.getTool()} (${this.getToolboard()?.name}) - input voltage pwm`),t.push(`pin: ${this.isToolboardPinInverted(this.toolboardPins?.fan_toolhead_cooling_pin)?"!":""}${this.getPinPrefix()}${this.toolboardPins?.fan_toolhead_cooling_pin}`);break;case"4pin-toolboard":this.requireToolboardPin("fan_toolhead_cooling_pin"),t.push(`# 4-pin fan connected to 2-pin header on T${this.getTool()} (${this.getToolboard()?.name}) - digital pwm`),t.push(`pin: ${this.isToolboardPinInverted(this.toolboardPins?.fan_toolhead_cooling_pin)?"":"!"}${this.getPinPrefix()}${this.toolboardPins?.fan_toolhead_cooling_pin}`),t.push("cycle_time:  0.00004");break;case"4pin-dedicated-toolboard":this.requireToolboardPin("4p_toolhead_cooling_pin"),t.push(`# 4-pin fan connected to 4-pin header on T${this.getTool()} (${this.getToolboard()?.name}) - digital pwm`),t.push(`pin: ${this.isToolboardPinInverted(this.toolboardPins?.["4p_toolhead_cooling_pin"])?"!":""}${this.getPinPrefix()}${this.toolboardPins?.["4p_toolhead_cooling_pin"]}`),t.push("cycle_time:  0.00004"),this.toolboardPins?.["4p_toolhead_cooling_tach_pin"]!=null&&(t.push(`tachometer_pin: ^${this.isToolboardPinInverted(this.toolboardPins?.["4p_toolhead_cooling_tach_pin"])?"!":""}${this.toolboardPins?.["4p_toolhead_cooling_tach_pin"]}`),t.push("tachometer_poll_interval: 0.0005"));break;default:throw Error(`Unsupported hotend fan option "${this.getHotendFan().title}"`)}return t.join("\n")}renderToolheadMacro(){let e=null;if(this.getMotionAxis()===m.po.x?e=-1*this.printer.bedMargin.x[0]+2:this.getMotionAxis()===m.po.dual_carriage&&(e=this.size.x+this.printer.bedMargin.x[1]-2),null==e||isNaN(e))throw(0,l.getLogger)().debug("renderToolheadMacro:",this.printer.bedMargin.x[0],this.size,this.printer.bedMargin.x[1]),Error(`Failed to generate parking position for toolhead ${this.getToolCommand()}. Generated: ${e}`);let t=[`[gcode_macro ${this.getToolCommand()}]`,"variable_join: 0","variable_remap: 0",'variable_alert: ""','variable_filament_name: ""','variable_filament_type: ""',"variable_filament_temp: 0",'variable_runout_sensor: ""',`variable_active: ${0===this.getTool()?"True":"False"}`,`variable_color: "${0===this.getTool()?"7bff33":"0ea5e9"}"              # Used in frontends`,`variable_hotend_type: "${this.getHotend().flowType.toUpperCase()}"`,`variable_has_cht_nozzle: ${"CHT"===this.getNozzle().type?"True":"False"}`,"variable_cooling_position_to_nozzle_distance: 40                             # heatbreak length from cold zone to nozzle","variable_tooolhead_sensor_to_extruder_gear_distance: 15                      # distance in mm from the sensor to the extruder gear","variable_extruder_gear_to_cooling_position_distance: 30                      # distance in mm from the extruder gear to the end of the hotend cold zone","variable_filament_loading_nozzle_offset: -5","variable_filament_grabbing_length: 5","variable_filament_grabbing_speed: 1","variable_enable_insert_detection: True                                       # enables filament sensor insert detection ","variable_enable_runout_detection: True                                       # enables filament sensor runout detection ","variable_enable_clog_detection: True                                         # enables filament sensor clog detection ","variable_unload_after_runout: True                                           # unload filament after a runout has been detected","variable_purge_after_load: 0","variable_purge_before_unload: 0","variable_extruder_load_speed: 60","variable_filament_load_speed: 10","variable_standby: False","variable_temperature_offset: 0                                               # hotend temperature offset","variable_has_oozeguard: False                                                # toolhead has a oozeguard","variable_has_front_arm_nozzle_wiper: False                                   # toolhead has front arm nozzle wipers"];return"hybrid-corexy-idex"==this.printer.kinematics?t.push(`variable_loading_position: ${0===this.getTool()?e+25:e-25} # filament load x position`,`variable_parking_position: ${e} # parking x position`,"variable_resume_after_insert: True                                           # resumes the print after inserting new filament"):t.push("variable_resume_after_insert: False                                          # resumes the print after inserting new filament"),t.push("gcode:",`	{% set x = params.X|default(-1.0)|float %}`,`	{% set y = params.Y|default(-1.0)|float %}`,`	{% set z = params.Z|default(0.0)|float %}`,`	{% set s = params.S|default(1)|int %}`,`	{% if printer["gcode_macro _SELECT_TOOL"] is defined %}`,`		_SELECT_TOOL T=${this.getTool()} X={x} Y={y} Z={z} TOOLSHIFT={s}`,`	{% endif %}`),t.join("\n")}};let constructKlipperConfigUtils=async e=>{let t=e.toolheads.reduce((e,t)=>e+(t.toolboard?.driverCount??0),0),r=null!=e.controlboard.extruderlessConfig?1:0,o=e.printer.driverCountRequired>e.controlboard.driverCount,i=await parseBoardPinConfig(e.controlboard,o),n=await Promise.all(e.toolheads.map(async t=>{if(null==t.toolboard&&o)throw Error("A toolboard is required when using an extruderless controlboard configuration (your controlboard alone does not have enough drivers for this printer). Please add a toolboard to your configuration.");return await ToolheadGenerator.fromConfig(t,i,e.printer,e.size)}));return{extruderLessConfigBonus:r,isExtruderlessBoard:o,toolboardDriverCount:t,getControlboardPins:()=>({...i}),requireControlboardPin(e){if(null==this.getControlboardPins()[e])throw Error(`The controlboard has no "${e}" defined in its config.`)},isExtruderToolheadAxis:e=>n.some(t=>t.getExtruderAxis()===e),getToolhead:e=>{let t="number"==typeof e?n.find(t=>t.getTool()===e):n.find(t=>t.getExtruderAxis()===e||t.getMotionAxis()===e);if(null==t)throw Error(`No toolhead found for tool/axis ${e}`);return t},renderCommentHeader(e,t=[]){let r="------------------------------------------------------------------------------------------------------------",o=(r.length-e.length-2)/2,i=`#${"-".repeat(Math.floor(o))} ${e} ${"-".repeat(Math.ceil(o))}`;return[i,...t.length?t.concat(`#${r}`):[]]},getToolheads:()=>n.slice(),getRail(t){let r=e.rails.find(e=>e.axis===t);if(null==r)throw Error(`No rail found for axis ${t}`);return r},getRailPinValue(t,r,o=["controlboard","toolboard"],n=!0){let a=this.printerAxisToPinAliasPrefix(t)+"_"+(r.startsWith("_")?r.substring(1):r),s=null,l=this.getRail(t),d=this.isExtruderToolheadAxis(t)?this.getToolhead(t):null;if(this.isExtruderToolheadAxis(t)&&o.includes("toolboard")&&d?.hasToolboard())s=n?d.getToolheadPin(t,r):d.getPinFromToolboardAlias(a);else if(o.includes("controlboard")){let t=r.startsWith("_")?r.substring(1):r;if(null!=e.controlboard.motorSlots&&null!=l.motorSlot&&t in e.controlboard.motorSlots[l.motorSlot]){if(null==(s=e.controlboard.motorSlots[l.motorSlot][t]))throw Error(`Motor slot was selected, but pin ${t} wasn't found in motor slot config.`)}else s=i[a]}if(null==s)throw Error(`Pin name "${a}" constructed from axis "${t}" and alias "${r}" not found in board pin configs.`);return s},getAxisStepperName:e=>e===m.po.extruder?"extruder":e===m.po.extruder1?"extruder1":e===m.po.dual_carriage?"dual_carriage":"stepper_"+e,getAxisDriverType(e){return this.getRail(e).driver.type.toLowerCase()},getAxisDriverVariables(t,r=!1,o=[]){let i=e.rails.filter(e=>(r?e.axis.startsWith(t):e.axis===t)||o.includes(e.axis)),n=[];return n.push(`variable_${t}_driver_types: [${i.map(e=>`"${e.driver.type.toLowerCase()}"`).join(", ")}]`),n.push(`variable_${t}_axes: [${i.map(e=>`"${e.axis}"`).join(", ")}]`),n.join("\n")},isSensorless:e=>n.find(t=>t.getMotionAxis()===e)?.getXEndstop().id==="sensorless"||e===m.po.y&&n.some(e=>"sensorless"===e.getYEndstop().id),getAxisHomingSpeed(e){let t=this.getRail(e),r=this.isSensorless(e)?50:t.homingSpeed;return r},getAxisDriverSectionName(e){return`${this.getAxisDriverType(e)} ${this.getAxisStepperName(e)}`},getAxisVirtualEndstop(e){return`${this.getAxisDriverType(e)}_${this.getAxisStepperName(e)}:virtual_endstop`},getAxisDriverStallGuardThreshold(e,t){let r=this.getRail(e);return(t=Math.max(0,Math.min(1,t)),["TMC2130","TMC5160","TMC2240"].includes(r.driver.type))?`driver_SGT: ${Math.round(127*t)-64} # Lower value = higher sensitity, range -64 to 63`:`driver_SGTHRS: ${Math.round(255*t)} # Lower value = lower sensitivity, range 0 to 255`},getAxisDriverDiagConfig(e){return"UART"===this.getRail(e).driver.protocol?`diag_pin: ^${this.printerAxisToPinAliasPrefix(e)}_diag_pin`:"SPI"===this.getRail(e).driver.protocol?`diag1_pin: ^!${this.printerAxisToPinAliasPrefix(e)}_diag_pin`:""},getAxisDriverHomingCurrent(e,t){let r=this.getRail(e);return t=Math.max(0,Math.min(1,t)),.71*r.stepper.maxPeakCurrent*t},getExtruderPinPrefix(e=0){let t=this.getToolhead(e);if(null==t)throw Error(`No toolhead found for tool ${e}`);return t.getPinPrefix()},formatInlineComments(e,t="#"){let r=e.reduce((e,r)=>Math.max(e,r.substring(0,r.indexOf(t)).trim().length),0);return e.map(e=>{let o=e.indexOf(t),i=e.lastIndexOf(t);if((-1===o||e.trim().startsWith(t))&&i===o)return e;o!==i&&(o=e.indexOf(t,o+1));let n=e.substring(o),a=e.substring(0,o).trim(),s=r-a.length+2;return a+" ".repeat(s)+" "+n})},isPrinterAxis:e=>Object.values(m.po).includes(e),pinAliasPrefixToPrinterAxis(e){let t=x.safeParse(e);return t.success?t.data:null},printerAxisToPinAliasPrefix(e){let t=P.safeParse(e);if(t.success){if("e1"===t.data){if(this.getToolhead(1).hasToolboard())return"e";throw Error("No toolboard found for T1, e1 prefix is not supported")}return t.data}return null},getMotorComments(t,r,o){let i="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==i)throw Error(`No rail found for axis ${t}`);let n=[`# ${i.axisDescription}`];if(!o){let t=this.isExtruderToolheadAxis(i.axis)?this.getToolhead(i.axis):null;t?.hasToolboard()?n.push(`# Connected to ${(t.getToolboard()||e.controlboard).name}`):i.motorSlot&&e.controlboard.motorSlots&&n.push(`# Connected to ${e.controlboard.motorSlots[i.motorSlot].title} on ${e.controlboard.manufacturer} ${e.controlboard.name}`),n.push(`# Driver: ${i.driver.title}`),n.push(`# Motor: ${i.stepper.title}`),n.push(`# Voltage: ${i.voltage}`)}return this.renderCommentHeader(r??i.axis.toUpperCase(),n)},getMotorPinComments(t,r,o){let i="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==i)throw Error(`No rail found for axis ${t}`);let n=[];return i.motorSlot&&r.motorSlots&&n.push(`# Assigned to slot: "${r.motorSlots[i.motorSlot].title}"`),this.renderCommentHeader(o??i.axis.toUpperCase(),n)},getAccelWithType(t){let r="adxl345";if("controlboard"===t&&(e.controlboard?.ADXL345SPI!=null&&(r="adxl345"),e.controlboard?.LIS2DW!=null&&(r="lis2dw")),"toolboard_t0"===t||"toolboard_t1"===t){let e=n.find(e=>e.getToolboardName()===t)?.getToolboard();if(null==e)throw Error("No toolboard found for T0");null!=e.ADXL345SPI&&(r="adxl345"),null!=e.LIS2DW&&(r="lis2dw")}return"beacon"===t&&(r="beacon"),ef.parse({name:t,type:r})}}},constructKlipperConfigExtrasGenerator=(e,t)=>{let r=[],o=[];return{getFilesToWrite:()=>r.slice(),addFileToRender(e){r.push(e)},getReminders:()=>o.slice(),generateSaveVariables(t){let r=_.serverSchema.parse(process.env),o=["[Variables]"];return o.push("idex_applied_offset = 1",`idex_xcontrolpoint = ${t?.xcontrolpoint??e.size.x/2}`,"idex_xoffset = 0.0",`idex_ycontrolpoint = ${t?.ycontrolpoint??50}`,"idex_yoffset = 0.0",`idex_zcontrolpoint = ${t?.zcontrolpoint??50}`,"idex_zoffset = 0.0",`idex_zoffsetcontrolpoint = ${t?.zoffsetcontrolpoint??25}`,"nozzle_expansion_applied_offset = 0","nozzle_expansion_coefficient_t0 = 0.06","nozzle_expansion_coefficient_t1 = 0.06"),[{fileName:"ratos-variables.cfg",content:o.join("\n"),overwrite:!1}].map(e=>(this.addFileToRender(e),`[save_variables]
filename: ${h().join(r.KLIPPER_CONFIG_PATH,e.fileName)}`))},generateSensorlessHomingIncludes(){let r=[];if(t.isSensorless(m.po.x)&&r.push({fileName:"sensorless-homing-x.cfg",content:(0,ej.i)(e,t),overwrite:!1}),t.isSensorless(m.po.y)&&r.push({fileName:"sensorless-homing-y.cfg",content:(0,ej.E)(e,t),overwrite:!1}),r.length>0){let e=[];e.push("# REMEMBER TO TUNE SENSORLESS HOMING BEFORE ATTEMPTING TO PRINT!"),e.push("# You'll find instructions in the generated sensorless-homing-*.cfg file(s),","# where you should keep your sensorless homing settings."),this.addReminder(e.join("\n"))}return r.map(e=>(this.addFileToRender(e),`[include ${e.fileName}]`)).join("\n")},addReminder(e){o.push(e)}}},constructKlipperConfigHelpers=async(e,t,r)=>({renderToolboards(){return r.getToolheads().map(e=>e.renderToolboard(this.renderBoardPinAlias)).join("\n")},renderControlboard(){let t=["",this.renderBoardPinAlias(e.controlboard.id,e.controlboard),"","[mcu]",`serial: ${getBoardSerialPath(e.controlboard)}`];return e.controlboard.hasMcuTempSensor&&(t.push(""),t.push(`[temperature_sensor ${e.controlboard.name.replace(/\s/g,"_")}]`),t.push("sensor_type: temperature_mcu")),null!=e.controlboard.ADXL345SPI&&(t.push(""),t.push("[adxl345 controlboard]"),t.push(`cs_pin: ${e.controlboard.ADXL345SPI.cs_pin}`),"hardware"in e.controlboard.ADXL345SPI?t.push(`spi_bus: ${e.controlboard.ADXL345SPI.hardware.bus}`):(t.push(`spi_software_mosi_pin: ${e.controlboard.ADXL345SPI.software.mosi}`),t.push(`spi_software_miso_pin: ${e.controlboard.ADXL345SPI.software.miso}`),t.push(`spi_software_sclk_pin: ${e.controlboard.ADXL345SPI.software.sclk}`))),null!=e.controlboard.LIS2DW&&(t.push(""),t.push("[lis2dw controlboard]"),t.push(`cs_pin: ${e.controlboard.LIS2DW.cs_pin}`),"hardware"in e.controlboard.LIS2DW?t.push(`spi_bus: ${e.controlboard.LIS2DW.hardware.bus}`):(t.push(`spi_software_mosi_pin: ${e.controlboard.LIS2DW.software.mosi}`),t.push(`spi_software_miso_pin: ${e.controlboard.LIS2DW.software.miso}`),t.push(`spi_software_sclk_pin: ${e.controlboard.LIS2DW.software.sclk}`))),null!=e.controlboard.outputPins&&e.controlboard.outputPins.forEach(e=>{t.push(""),t.push(`[output_pin ${e.name}]`),t.push(`pin: ${e.pin}`),t.push(`value: ${e.value}`)}),t.join("\n")},renderBoards(){if(e.printer.driverCountRequired>e.controlboard.driverCount&&e.controlboard.driverCount+r.toolboardDriverCount+r.extruderLessConfigBonus<e.printer.driverCountRequired)throw Error("Your control and toolboard combination does not make up enough drivers for this printer.");let t=["[include RatOS/boards/rpi/config.cfg]",this.renderControlboard(),this.renderToolboards()];return t.join("\n")},renderStepperSections(){return e.rails.map(e=>this.renderStepperSection(e)).join("\n")},renderMotorSections(){let t=e.rails.map(e=>r.getMotorComments(e).join("\n")+"\n"+this.renderDriverSection(e,!0)+"\n"+this.renderStepperSection(e,!0));return t.push(this.renderBoardQuirks()),t.join("\n")},renderStepperSection(t,o=!1){let i="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==i)throw Error(`No rail found for axis ${t}`);let n=o?[]:r.getMotorComments(i);if(n.push(`[${r.getAxisStepperName(i.axis)}]`,`step_pin: ${r.getRailPinValue(i.axis,"_step_pin")}`,`dir_pin: ${r.getRailPinValue(i.axis,"_dir_pin")}`,`enable_pin: !${r.getRailPinValue(i.axis,"_enable_pin")}`,`microsteps: ${i.microstepping}`,`full_steps_per_rotation: ${i.stepper.fullStepsPerRotation}`),i.axis===m.po.extruder||i.axis===m.po.extruder1){let e=r.getToolhead(i.axis);if(null==e)throw Error(`No toolhead found for ${i.axis}`);n.push(`rotation_distance: ${X(e.getExtruder().id)}`)}else n.push(`rotation_distance: ${i.rotationDistance}`);if(i.axis===m.po.z&&n.push("position_min: -5"),[m.po.x,m.po.y,m.po.z,m.po.dual_carriage].includes(i.axis)&&n.push(`homing_speed: ${r.getAxisHomingSpeed(i.axis)}`),null!=i.gearRatio&&n.push(`gear_ratio: ${i.gearRatio}`),i.axis===m.po.z){let t=e.toolheads.find(e=>null!=e.probe);t?.probe!=null&&n.push("endstop_pin: probe:z_virtual_endstop")}return n.join("\n")+"\n"},renderUserStepperSections(t){return r.formatInlineComments(e.rails.map(e=>{let r=t[e.axis],{directionInverted:o,rotationComment:i,additionalLines:n}=r??{},a=null!=r&&"limits"in r?r.limits:null,s=null!=r&&"safeDistance"in r?r.safeDistance:void 0;return this.renderUserStepperSection(e.axis,o,a,s,i,n)}).join("\n").split("\n")).join("\n")},renderUserStepperSection(t,o=!1,i,n,a,s){let l="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==l)throw Error(`No rail found for axis ${t}`);let d=o?`# Remove ! in front of pin name to reverse the direction of ${r.getAxisStepperName(l.axis)}`:`# Add ! in front of pin name to reverse the direction of ${r.getAxisStepperName(l.axis)}`,p="";(l.axis===m.po.extruder||l.axis===m.po.extruder1)&&(p=r.getExtruderPinPrefix(l.axis));let c=r.getMotorComments(l,void 0,!0).concat([`[${r.getAxisStepperName(l.axis)}]`,`dir_pin: ${o?"!":""}${p}${r.printerAxisToPinAliasPrefix(l.axis)}_dir_pin ${d}`]);if(l.axis===m.po.extruder||l.axis===m.po.extruder1){let e=r.getToolhead(l.axis);if(null==e)throw Error(`No toolhead found for ${l.axis}`);c.push(`rotation_distance: ${X(e.getExtruder().id)} # ${e.getExtruder().title} default`)}else c.push(`rotation_distance: ${l.rotationDistance} ${a?`# ${a}`:""}`);if([m.po.x,m.po.y,m.po.z].includes(l.axis)&&c.push(`homing_speed: ${r.getAxisHomingSpeed(l.axis)}`),i){let t=l.axis!==m.po.y?e.printer.bedMargin.x[0]:e.printer.bedMargin.y[0],r=l.axis!==m.po.y?e.printer.bedMargin.x[1]:e.printer.bedMargin.y[1];Object.entries("function"==typeof i?i({min:t,max:r}):i).forEach(([e,t])=>{c.push(`position_${e}: ${l.axis===m.po.z&&"min"===e?Math.min(t,-5):t}`)})}return n&&c.push(`safe_distance: ${n}`),null!=s&&c.push(...s),c.join("\n")+"\n"},renderDriverSections(){let t=e.rails.map(e=>this.renderDriverSection(e));return t.push(this.renderBoardQuirks()),t.join("\n")},renderDriverSection(t,o=!1){let i="object"==typeof t?t:e.rails.find(e=>e.axis===t);if(null==i)throw Error(`No rail found for axis ${t}`);let n=findPreset(i.stepper,i.driver,i.voltage,i.current),a=o?[]:r.getMotorComments(i);if(a.push(`[${r.getAxisDriverSectionName(i.axis)}]`,`stealthchop_threshold: ${e.stealthchop?"9999999":e.standstillStealth?"1":"0"}`,`interpolate: ${i.microstepping<64||e.stealthchop?"True":"False"}`),"UART"===i.driver.protocol){if(i.motorSlot&&!(r.isExtruderToolheadAxis(i.axis)&&r.getToolhead(i.axis).hasToolboard())){let t=e.controlboard.motorSlots?.[i.motorSlot];if(null==t||!hasUART(e.controlboard.motorSlots?.[i.motorSlot]))throw Error(`No controlboard motor slot UART pins defined for motor slot ${i.motorSlot}`);Object.entries(C.parse(t)).forEach(([e,t])=>{a.push(`${e}: ${t}`)})}else a.push(`uart_pin: ${r.getRailPinValue(i.axis,"_uart_pin")}`)}if("SPI"===i.driver.protocol){if(i.motorSlot){let t=e.controlboard.motorSlots?.[i.motorSlot];if(null==t||!hasSPI(e.controlboard.motorSlots?.[i.motorSlot]))throw Error(`No controlboard motor slot SPI pins defined for motor slot ${i.motorSlot}`);Object.entries(S.parse(t)).forEach(([e,t])=>{a.push(`${e}: ${t}`)})}else{let t=r.getRailPinValue(i.axis,"_uart_pin");try{t=r.getRailPinValue(i.axis,"_cs_pin")}catch{}if(a.push(`cs_pin: ${t}`),r.isExtruderToolheadAxis(i.axis)){let e=r.getToolhead(i.axis).getToolboard();e?.stepperSPI!=null?"hardware"in e.stepperSPI?a.push(`spi_bus: ${e.stepperSPI.hardware.bus}`):(a.push(`spi_software_mosi_pin: ${r.getToolhead(i.axis).getPinPrefix()}${e.stepperSPI.software.mosi}`),a.push(`spi_software_miso_pin: ${r.getToolhead(i.axis).getPinPrefix()}${e.stepperSPI.software.miso}`),a.push(`spi_software_sclk_pin: ${r.getToolhead(i.axis).getPinPrefix()}${e.stepperSPI.software.sclk}`)):(a.push(`spi_software_mosi_pin: ${r.getToolhead(i.axis).getPinPrefix()}stepper_spi_mosi_pin`),a.push(`spi_software_miso_pin: ${r.getToolhead(i.axis).getPinPrefix()}stepper_spi_miso_pin`),a.push(`spi_software_sclk_pin: ${r.getToolhead(i.axis).getPinPrefix()}stepper_spi_sclk_pin`))}else null!=e.controlboard.stepperSPI?"hardware"in e.controlboard.stepperSPI?a.push(`spi_bus: ${e.controlboard.stepperSPI.hardware.bus}`):(a.push(`spi_software_mosi_pin: ${e.controlboard.stepperSPI.software.mosi}`),a.push(`spi_software_miso_pin: ${e.controlboard.stepperSPI.software.miso}`),a.push(`spi_software_sclk_pin: ${e.controlboard.stepperSPI.software.sclk}`)):(a.push("spi_software_mosi_pin: stepper_spi_mosi_pin"),a.push("spi_software_miso_pin: stepper_spi_miso_pin"),a.push("spi_software_sclk_pin: stepper_spi_sclk_pin"))}}if(n){let{driver:e,voltage:t,...r}=n;Object.entries(r).forEach(([e,t])=>{a.push(`${e}: ${t}`)})}else a.push(`run_current: ${i.current}`),"senseResistor"in i.driver&&a.push(`sense_resistor: ${i.driver.senseResistor}`);return a.join("\n")+"\n"},renderSpeedLimits(){let t=e.performanceMode&&e.printer.speedLimits.performance&&!e.stealthchop?e.printer.speedLimits.performance:e.printer.speedLimits.basic;return`[printer]
max_velocity: ${e.stealthchop?135:t.velocity}
max_accel: ${t.accel/(e.stealthchop?2:1)}
minimum_cruise_ratio: ${e.stealthchop?.25:.5}
max_z_velocity: ${e.stealthchop?10:t.z_velocity}
max_z_accel: ${t.z_accel}
square_corner_velocity: ${t.square_corner_velocity}

[gcode_macro RatOS]
variable_macro_travel_speed: ${this.getMacroTravelSpeed()}
variable_macro_travel_accel: ${this.getMacroTravelAccel()}`},getMacroTravelSpeed(){let t=e.performanceMode&&e.printer.speedLimits.performance?e.printer.speedLimits.performance:e.printer.speedLimits.basic;return e.stealthchop?"135":t.travel_velocity},getMacroTravelAccel(){let t=e.performanceMode&&e.printer.speedLimits.performance?e.printer.speedLimits.performance:e.printer.speedLimits.basic;return e.stealthchop?"1000":t.travel_accel},renderBoardQuirks(){let t=[];return e.controlboard.hasQuirksFiles&&(t.push("# Include controlboard quirk file"),r.getToolhead(m.po.extruder)?.getToolboard()!=null?t.push(`[include RatOS/boards/${e.controlboard.id}/quirks-toolboard.cfg]`):t.push(`[include RatOS/boards/${e.controlboard.id}/quirks.cfg]`)),r.getToolheads().forEach(e=>{let r=e.getToolboard();r?.hasQuirksFiles&&(t.push("# Include toolboard quirk file"),t.push(`[include RatOS/boards/${r.id}/quirks.cfg]`))}),t.join("\n")},renderHotend:()=>r.getToolheads().map(t=>t.renderHotend(e.controlboard)).join("\n"),renderExtruder:()=>r.getToolheads().map(e=>e.renderExtruder()).join("\n"),renderInputShaper(e){let t=[],o=r.getToolhead(m.po.x);[o.getYAccelerometerName(),o.getXAccelerometerName()].includes("rpi")&&(t.push("[include RatOS/sensors/rpi-adxl345.cfg]"),t.push(""));let i=r.getAccelWithType(o.getXAccelerometerName()),n=r.getAccelWithType(o.getYAccelerometerName());return t.push("[resonance_tester]"),"beacon"===i.type?t.push(`accel_chip_x: ${i.type}`):t.push(`accel_chip_x: ${i.type} ${i.name}`),"beacon"===n.type?t.push(`accel_chip_y: ${n.type}`):t.push(`accel_chip_y: ${n.type} ${n.name}`),t.push("probe_points:"),t.push(`	${e.x/2},${e.y/2},20`),t.join("\n")},renderProbeIncludes(){let e=[],t=r.getToolheads().find(e=>null!=e.getProbe());return t&&e.push(`[include RatOS/z-probe/${t.getProbe()?.id+".cfg"}]`),e.push(this.renderProbePinSection(!0)),e.join("\n")},renderProbePinSection(e=!1){let o=[],i=r.getToolheads().find(e=>null!=e.getProbe());if(i)switch(i.getProbe()?.id){case"bltouch":let n=i.getPinPrefix()+(e?i.getPinFromAlias("bltouch_control_pin"):"bltouch_control_pin"),a=i.getPinPrefix()+(e?i.getPinFromAlias("bltouch_sensor_pin"):"bltouch_sensor_pin");o.push("# BLTouch configuration"),o.push("[bltouch]"),o.push("control_pin: "+n),o.push("sensor_pin: ^"+a),e||o.push("z_offset: 0");break;case"beacon":if(!e){let e=[];e.push("# REMEMBER TO CALIBRATE YOUR BEACON!"),e.push("# Run BEACON_RATOS_CALIBRATE for automatic calibration."),t.addReminder(e.join("\n"))}break;default:let s=i.getPinPrefix()+(e?i.getPinFromAlias("probe_pin"):"probe_pin");o.push("# Probe configuration"),o.push("[probe]"),e||o.push("z_offset: 0.0 # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG"),o.push(`pin: ^${s}# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.`),e||(o.push(`#pin: ^!${s} # NPN NO (refer to the specs of your probe)`),o.push(`#pin: ${s} # PNP NO (refer to the specs of your probe)`),o.push(`#pin: !${s} # PNP NC (refer to the specs of your probe)`))}return o.join("\n")},renderZOffsetGuidance(t=""){let r=[];return e.toolheads.some(e=>e.probe?.id==="beacon")?(r.push("Z-offset calibration: run BEACON_RATOS_CALIBRATE to automatically calibrate your beacon for scan and contact."),r.push(`${t}IMPORTANT: Ensure the beacon is properly mounted and the nozzle and meltzone is clean by unloading`),r.push(`${t}the filament (if it's loaded) and make sure there's no ooze or gunk on the nozzle when the hotend is at printing temperature.`)):r.push("Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset"),r.join("\n")},renderEndstopSection(o){let i=[],n=r.getToolheads(),a="sensorless";if(n.forEach(e=>{if("sensorless"!==e.getXEndstop().id&&(i.push(""),i.push("# Physical X endstop configuration"),i.push(`[${e.getMotionStepperName()}]`),i.push(`endstop_pin: ${e.getXEndstopPin()}`),i.push("[gcode_macro RatOS]"),i.push('variable_homing_x: "endstop"')),"sensorless"!==e.getYEndstop().id){if("sensorless"==a)a=e.getYEndstopPin();else if(a!==e.getYEndstopPin())throw Error("Multiple toolheads configured with different y endstops is currently not supported.")}}),"sensorless"!==a&&(i.push(""),i.push("# Physical Y endstop configuration"),i.push("[stepper_y]"),i.push(`endstop_pin: ${a}`),i.push("[gcode_macro RatOS]"),i.push('variable_homing_y: "endstop"')),n.some(e=>"sensorless"===e.getXEndstop().id||"sensorless"===e.getYEndstop().id)){let n=e.printer.defaults.rails.find(e=>e.axis===m.po.x),a=e.printer.defaults.rails.find(e=>e.axis===m.po.dual_carriage),s=e.printer.defaults.rails.find(e=>e.axis===m.po.y);i.push(""),n&&s&&null!=o&&(0,m.R_)(r.getRail(m.po.x),deserializePrinterRailDefinition(n),e.performanceMode)&&(0,m.R_)(r.getRail(m.po.y),deserializePrinterRailDefinition(s),e.performanceMode)&&(null==a||(0,m.R_)(r.getRail(m.po.dual_carriage),deserializePrinterRailDefinition(a),e.performanceMode))?i.push(`[include ${o}]`):i.push(t.generateSensorlessHomingIncludes())}if(r.getToolheads().every(e=>null==e.getProbe())){i.push(""),i.push("# Physical Z endstop configuration"),i.push("[stepper_z]");try{i.push(`endstop_pin: ${r.getRailPinValue(m.po.z,"_endstop_pin")}`)}catch(e){try{i.push(`endstop_pin: ${r.getRailPinValue(m.po.z,"_diag_pin")}`)}catch(e){i.push("# endstop_pin: <pin> # Override this with the correct pin in printer.cfg")}}i.push("position_endstop: -0.1"),i.push("second_homing_speed: 3.0"),i.push("homing_retract_dist: 3.0")}return i.join("\n")},renderMacroVariableOverrides(t){let o=[`variable_bed_margin_x: [${e.printer.bedMargin.x[0]}, ${e.printer.bedMargin.x[1]}]`,`variable_bed_margin_y: [${e.printer.bedMargin.y[0]}, ${e.printer.bedMargin.y[1]}]`],i=r.getToolheads(),n=i.some(e=>e.getMotionAxis()===m.po.dual_carriage);if(n){let e=i.find(e=>null!=e.getProbe())?.getTool();o.push(`variable_default_toolhead: ${e}                             # the toolhead with the z-probe, 0=left 1=right toolhead`);let t=`${r.getToolhead(0).getXAccelerometer()?.accelerometerType??"adxl345"} ${r.getToolhead(0).getYAccelerometerName()}`,n=`${r.getToolhead(1).getXAccelerometer()?.accelerometerType??"adxl345"} ${r.getToolhead(1).getYAccelerometerName()}`;o.push(`variable_adxl_chip: ["${t}", "${n}"]           # toolheads adxl chip names`),o.push(`variable_toolchange_travel_speed: ${this.getMacroTravelSpeed()}     # parking travel speed`),o.push(`variable_toolchange_travel_accel: ${this.getMacroTravelAccel()}     # parking travel accel`),o.push("variable_shaper_x_freq: [0, 0, 0, 0]                    # shaper frequency [T0, T1, COPY, MIRROR]"),o.push("variable_shaper_y_freq: [0, 0, 0, 0]                    # shaper frequency [T0, T1, COPY, MIRROR]"),o.push('variable_shaper_x_type: ["mzv", "mzv", "mzv", "mzv"]    # shaper frequency algorythm [T0, T1, COPY, MIRROR]'),o.push('variable_shaper_y_type: ["mzv", "mzv", "mzv", "mzv"]    # shaper frequency algorythm [T0, T1, COPY, MIRROR]')}return o.push(r.getAxisDriverVariables(m.po.x,"hybrid-corexy"!==e.printer.kinematics)),o.push(r.getAxisDriverVariables(m.po.y,!0,"hybrid-corexy"===e.printer.kinematics?[m.po.x1]:[])),o.push(r.getAxisDriverVariables(m.po.z,!0)),r.formatInlineComments(o).join("\n")},renderSaveVariables:e=>t.generateSaveVariables(e).join("\n"),renderControllerFan(){let t=[];if("none"===e.controllerFan.id)return t.push("# No controller fan configured"),t.join("\n");switch(t.push("[controller_fan controller_fan]"),e.controllerFan.id){case"2pin":r.requireControlboardPin("fan_controller_board_pin"),t.push(`# 2-pin fan connected to 2-pin header on ${e.controlboard.name} - input voltage pwm`),t.push(`pin: ${r.getControlboardPins().fan_controller_board_pin}`);break;case"4pin":r.requireControlboardPin("fan_controller_board_pin"),t.push(`# 4-pin fan connected to 2-pin header on ${e.controlboard.name} - digital pwm`),t.push(`pin: !${r.getControlboardPins().fan_controller_board_pin}`),t.push("cycle_time:  0.00004");break;case"4pin-dedicated":r.requireControlboardPin("4p_controller_board_pin"),t.push(`# 4-pin fan connected to 4-pin header on ${e.controlboard.name} - digital pwm`),t.push(`pin: ${r.getControlboardPins()["4p_controller_board_pin"]}`),t.push("cycle_time:  0.00004"),null!=r.getControlboardPins()["4p_controller_board_tach_pin"]&&(t.push(`tachometer_pin: ^${r.getControlboardPins()["4p_controller_board_tach_pin"]}`),t.push("tachometer_poll_interval: 0.0005"));break;default:throw Error(`Unsupported controller fan option "${e.controllerFan.title}"`)}return t.join("\n")},renderFans(){let t=[],o=r.getToolheads().filter(e=>e.getPartFan()).length>1;return t.push("# Part cooling fan"),o&&(t.push("# Multiple toolheads with part cooling fans configured"),t.push("# [fan] will use an unused io pin, proxy m106 settings to active toolhead via macro."),t.push("[fan]"),t.push("pin: rpi:gpio4         # sacrifical part fan, use this to independently control your both toolhead part fans")),t.push(r.getToolheads().map(t=>t.renderPartFan(o,e.controlboard)).join("\n")),t.push(""),t.push("# Hotend cooling fan"),t.push(r.getToolheads().map(t=>t.renderHotendFan(e.controlboard)).join("\n")),t.push(""),t.push("# Controller cooling fan"),t.push(this.renderControllerFan()),t.join("\n")},renderBoardPinAlias(e,t,o,i){let n=t.isToolboard?"toolboard":"controlboard",a=t.isToolboard?o?.getToolboardPins():r.getControlboardPins();if(null==a)throw Error(`No pins found for ${t.name}.`);let s={},l=Object.keys(b).map(e=>{let t=e.split("_"),o="dual"===t[0]?t[0]+"_"+t[1]:t[0],i=r.pinAliasPrefixToPrinterAxis(o);if(r.isPrinterAxis(i)&&-1!==Object.keys($.shape).indexOf(e.replace(o+"_","")))try{let t=r.getRailPinValue(i,e.replace(o,""),[n],!1);return null==s[i]&&(s[i]=[]),s[i]?.push(`${e}=${t}`),null}catch(e){return null}return null==a[e]?e+"=null":e+"="+a[e]}).filter(Boolean),d=[`[board_pins ${e}]`];null!=i&&d.push(`mcu: ${i}`);let p=[];return Object.entries(s).forEach(([e,o])=>{null!=o&&r.isPrinterAxis(e)&&(p.push(r.getMotorPinComments(e,t,`${e.toUpperCase()} motor pins`).join("\n	")),p.push(o.join(",\n	")+","))}),d.push("aliases:",`	${p.join("\n	")}
	${r.renderCommentHeader("GENERAL PINS")}
	${l.join(",\n	")}`),d.join("\n")},renderBase:()=>"[include RatOS/homing.cfg]\n[include RatOS/macros.cfg]\n[include RatOS/shell-macros.cfg]",renderReminders:()=>t.getReminders().join("\n"),renderMacros:()=>r.formatInlineComments(r.getToolheads().flatMap(e=>e.renderToolheadMacro().split("\n"))).join("\n"),uncommentIf:e=>!0===e?"":"#"});var eH=r(68103),eB=r(16689),eW=r.n(eB);let eq=eW().forwardRef(({className:e,...t},r)=>Y.jsx("strong",{ref:r,className:function(...e){return(0,J.twMerge)((0,eH.clsx)(e))}("font-semibold",e),...t}));eq.displayName="Strong",Y.Fragment;let partFanOptions=(e,t)=>{let r=[];return(null==t||t?.axis===m.po.x||t?.axis===null)&&(r.push({id:"2pin",title:"Input Voltage PWM",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]}),r.push({id:"4pin",title:"Digital PWM on 2-pin port",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]})),e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated",title:"Digital PWM on 4-pin port",badge:[{color:"purple",children:e.controlboard.name}]}),t?.toolboard!=null&&(r.push({id:"2pin-toolboard",title:"Input Voltage PWM",badge:[{color:"sky",children:`${t.toolboard.name}${null!=t.toolNumber&&` T${t.toolNumber}`}`}]}),r.push({id:"4pin-toolboard",title:"Digital PWM on 2-pin port",badge:[{color:"sky",children:`${t.toolboard.name}${null!=t.toolNumber&&` T${t.toolNumber}`}`}]}),t?.toolboard.fourPinFanConnectorCount!=null&&t.toolboard.fourPinFanConnectorCount>0&&r.push({id:"4pin-dedicated-toolboard",title:"Digital PWM on 4-pin port",badge:[{color:"sky",children:`${t.toolboard.name}${null!=t.toolNumber&&` T${t.toolNumber}`}`}]})),r},hotendFanOptions=(e,t)=>{let r=[];return(null==t||t?.axis===m.po.x)&&(r.push({id:"2pin",title:"Input Voltage PWM",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]}),r.push({id:"4pin",title:"Digital PWM on 2-pin port",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]})),(e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>2||e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>1&&e.controllerFan?.id!=="4pin-dedicated")&&r.push({id:"4pin-dedicated",title:"Digital PWM on 4-pin port",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]}),t?.toolboard!=null&&(r.push({id:"2pin-toolboard",title:"Input Voltage PWM",badge:[{color:"sky",children:`${t.toolboard.name}${null!=t.toolNumber&&` T${t.toolNumber}`}`}]}),r.push({id:"4pin-toolboard",title:"Digital PWM on 2-pin port",badge:[{color:"sky",children:`${t.toolboard.name}${null!=t.toolNumber&&` T${t.toolNumber}`}`}]}),t?.toolboard.fourPinFanConnectorCount!=null&&t.toolboard.fourPinFanConnectorCount>1&&r.push({id:"4pin-dedicated-toolboard",title:"Digital PWM on 4-pin port",badge:[{color:"sky",children:`${t.toolboard.name}${null!=t.toolNumber&&` T${t.toolNumber}`}`}]})),r},controllerFanOptions=(e,t)=>{let r=[{id:"2pin",title:"Input Voltage PWM",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]},{id:"4pin",title:"Digital PWM on 2-pin port",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]}];return(e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>2||e?.controlboard?.fourPinFanConnectorCount!=null&&e.controlboard.fourPinFanConnectorCount>1&&!t?.some(e=>e?.hotendFan?.id==="4pin-dedicated"))&&r.push({id:"4pin-dedicated",title:"Digital PWM on 4-pin port",badge:[{color:"purple",children:e?.controlboard?.name??"Control Board"}]}),r.push({id:"none",title:"No fan"}),r};var eU=r(56368);let runSudoScript=(e,...t)=>{let r=(0,H.xg)();return new Promise((o,i)=>{try{let n=(0,d.spawn)("sudo",[h().join(r,e),...t]),a="",s="";n.stdout.on("data",e=>{a+=e}),n.stderr.on("data",e=>{s+=e}),n.on("error",e=>{i(e)}),n.on("exit",e=>{0===e?o({stdout:a,stderr:s}):i("An error occured while attempting to run script: \n"+a+"\n"+s)}),n.on("close",e=>{0===e?o({stderr:s,stdout:a}):i(s)})}catch(e){if(e instanceof Error)return i(e.message);i("An error occured while attempting to run script")}})};var eV=r(98765),eG=r(54230),eK=r(73292);let eX=_.serverSchema.parse(process.env),eY=h().join(eX.RATOS_DATA_DIR,"last-printer-settings.json"),getLastPrinterSettings=async(e,t)=>{let r=e??eY;if(!(0,p.existsSync)(r))throw Error("Couldn't find printer settings file: "+r);return t?await readSerializedConfig(r):await loadSerializedConfig(r)},savePrinterSettings=async e=>await (0,eK.writeFile)(h().join(eX.RATOS_DATA_DIR,"last-printer-settings.json"),JSON.stringify(e)),hasLastPrinterSettings=()=>(0,p.existsSync)(eY);var eZ=r(51517);let eJ=s.z.object({boardPath:s.z.string().optional(),toolhead:ey.optional(),controlboard:A.optional()}),detect=(e,t)=>c().existsSync(getBoardSerialPath(e,t)),getBoards=async()=>{let e=q.get("boards");if(null!=e&&e.length>0)return e.map(e=>(e.detected=detect(e),e));let t=await (0,eG.glob)(`${process.env.RATOS_CONFIGURATION_PATH}/boards/*/board-definition.json`),r=t.map(e=>""===e.trim()?null:{...JSON.parse(c().readFileSync(e).toString()),path:N.parse(e.replace("board-definition.json",""))}).filter(Boolean).map(e=>{e.detected=detect(e);try{return L.parse(e)}catch(t){throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Invalid board definition for ${e.name} in ${e.path}`,cause:t})}});return q.set("boards",r),r},updateDetectionStatus=async(e,t)=>e.map(e=>(e.detected=detect(e,t),e)),compileFirmware=async(e,t,r)=>{let o=null,i=_.serverSchema.parse(process.env);try{let n=h().join(i.KLIPPER_DIR,".config");if(await (0,eK.copyFile)(h().join(e.path,"firmware.config"),n),e.isHost||await (0,H.u5)(n,/CONFIG_USB_SERIAL_NUMBER=".+"/g,`CONFIG_USB_SERIAL_NUMBER="${getBoardChipId(e,t)}"`),r)return(0,p.readFileSync)(n).toString();let a=e.firmwareBinaryName,s=h().extname(a),l=h().join(i.KLIPPER_DIR,"out",`klipper${s}`),d=h().join(i.RATOS_DATA_DIR,a);if((0,p.existsSync)(d)&&await (0,eK.unlink)(d),o=await runSudoScript("klipper-compile.sh"),(0,p.existsSync)(l))await (0,eK.copyFile)(l,d);else if(!e.isHost)throw Error(`Could not find compiled firmware at ${l}`);return o}catch(r){let t=r instanceof Error?r.message:r;throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Could not compile firmware for ${e.name}: ${t} 

 ${o?.stdout}`,cause:r})}},getBoardsWithoutHost=e=>e.filter(e=>!e.isHost),getToolboards=e=>s.z.array(j).parse(e.filter(e=>e.isToolboard)),getBoardsWithDriverCount=(e,t)=>e.filter(e=>e.driverCount>=t||null!=e.extruderlessConfig&&e.driverCount>=t-1),eQ=(0,eV.qR)(async({ctx:e,next:t,meta:r,rawInput:o})=>{let i=null,n=null,a=eJ.safeParse(o);try{i=await getBoards();try{n=a.success&&a.data.toolhead?new ToolheadHelper(await deserializeToolheadConfiguration(a.data.toolhead,{controlboard:a.data.controlboard},i)):void 0,i=await updateDetectionStatus(i,n)}catch(e){if(e instanceof s.ZodError)throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Toolhead configuration cannot be deserialized, please check the configuration.
${Object.entries(e.flatten().fieldErrors).map(([e,t])=>`${e}: ${t}`).join("\n")}`,cause:e});throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:"Toolhead configuration cannot be deserialized, please check the configuration.",cause:e})}r?.includeHost!==!0&&(i=getBoardsWithoutHost(i))}catch(e){if(e instanceof eU.TRPCError)throw e;throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Invalid board definition(s) in ${process.env.RATOS_CONFIGURATION_PATH}/boards.`,cause:e})}let l=null;if(r?.boardRequired&&(!a.success||null==a.data.boardPath))throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:"boardPath parameter missing."});if(a.success&&null!=a.data.boardPath&&null==(l=i.find(e=>e.path===a.data.boardPath)))throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${a.data.boardPath}`});return t({ctx:{...e,boards:i,board:l,toolhead:n}})}),e0=eV.$y.use(eQ);(0,eV.Nd)({boards:e0.input(s.z.object({boardFilters:s.z.object({toolboard:s.z.boolean().optional(),driverCountRequired:s.z.number().optional()}).optional(),toolhead:ey.optional(),controlboard:A.optional()})).output(s.z.array(L)).query(({ctx:e,input:t})=>{let r=e.boards;return t.boardFilters?.toolboard===!0&&(r=getToolboards(r)),t.boardFilters?.driverCountRequired!=null&&(r=getBoardsWithDriverCount(r,t.boardFilters.driverCountRequired)),r}),detect:e0.input(eJ).meta({boardRequired:!0}).query(({ctx:e,input:t})=>{if(null==e.board)throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});return detect(e.board,e.toolhead)}),unidentifiedDevices:e0.input(eJ).query(async({ctx:e})=>{let t=e.boards.filter(e=>e.detected).map(t=>c().realpathSync(getBoardSerialPath(t,e.toolhead)));return(await (0,eG.glob)("/dev/serial/by-id/usb-Klipper*")).filter(e=>!t.includes(c().realpathSync(e)))}),boardVersion:e0.input(eJ).meta({boardRequired:!0}).query(async({ctx:e,input:t})=>{if(null==e.board)throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});if(null==process.env.KLIPPER_ENV||""===process.env.KLIPPER_ENV.trim())throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:"Environment variable KLIPPER_ENV is missing"});if(null==process.env.KLIPPER_DIR||""===process.env.KLIPPER_DIR.trim())throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:"Environment variable KLIPPER_DIR is missing"});let r=await (0,eZ.z)();if(!["error","complete","canceled","standby",void 0].includes(r))throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`Printer is busy, board cannot be queried at this time without interrupting operations. Klipper print state reported as "${r}".`});let o=(0,H.xg)(),i={stdout:""},n=null;try{await fetch("http://127.0.0.1:7125/machine/services/stop?service=klipper",{method:"POST"}),i=await (0,f.promisify)(d.exec)(`${h().join(process.env.KLIPPER_ENV,"bin","python")} ${h().join(o,"check-version.py")} ${getBoardSerialPath(e.board,e.toolhead)}`,{env:{KLIPPER_DIR:process.env.KLIPPER_DIR,NODE_ENV:"production"}})}catch(e){n=e}finally{await fetch("http://127.0.0.1:7125/machine/services/start?service=klipper",{method:"POST"})}if(n)throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",cause:n});return i.stdout.match(/Version:\s(v\d+\.\d+\.\d+-\d+-\w+)/)?.[1]}),compile:e0.input(s.z.object({boardPath:s.z.string(),toolhead:ey.optional()})).meta({boardRequired:!0}).mutation(async({ctx:e,input:t})=>{if(null==e.board)throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});return await compileFirmware(e.board,e.toolhead),"success"}),reversePinLookup:e0.meta({boardRequired:!0}).input(s.z.object({axis:s.z.nativeEnum(m.po),canUseExtruderlessConfigs:s.z.boolean(),boardPath:s.z.string()})).query(async({ctx:e,input:t})=>{if(null==e.board)return;let r=null!=e.board.extruderlessConfig&&t.canUseExtruderlessConfigs,o=await parseBoardPinConfig(e.board,r),i=t.axis===m.po.z?"z0":t.axis===m.po.extruder?"e":m.po.extruder1===t.axis?"e1":t.axis;return reversePinLookup({step_pin:o[`${i}_step_pin`],dir_pin:o[`${i}_dir_pin`]},e.board)??null}),flashAllConnected:e0.meta({boardRequired:!1,includeHost:!0}).mutation(async({ctx:e})=>{let t=await getLastPrinterSettings(),r=t.toolheads.map(e=>new ToolheadHelper(e)),o=e.boards.flatMap(e=>{if(e.flashScript&&e.compileScript&&!0!==e.disableAutoFlash){if(detect(e))return{board:e,toolhead:null};let t=r.map(t=>detect(e,t)?{board:e,toolhead:t}:null).filter(Boolean);return t}return null}).filter(Boolean),i=[];for(let e of o)try{let t=D.parse(e.board);await compileFirmware(e.board,e.toolhead);let r=null;try{let o=h().join(t.path.replace(`${process.env.RATOS_CONFIGURATION_PATH}/boards/`,""),t.flashScript);r=e.toolhead?await runSudoScript("flash-path.sh",getBoardSerialPath(e.board,e.toolhead)):await runSudoScript("board-script.sh",o)}catch(o){let t=o instanceof Error?o.message:o;throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Could not flash firmware to ${e.board.name}: 

 ${r?.stdout??t}`,cause:o})}i.push({board:e.board,result:"success",message:`${e.board.manufacturer} ${e.board.name} on ${e.toolhead?` ${e.toolhead.getToolCommand()}`:""} was successfully flashed.`})}catch(r){let t=r instanceof Error?r.message:r;i.push({board:e.board,result:"error",message:"string"==typeof t?t:`Unknown error occured while flashing ${e.board.manufacturer} ${e.board.name} on ${e.toolhead?` ${e.toolhead.getToolCommand}`:""}`})}let n=i.filter(e=>"success"===e.result).length,a=`${n}/${o.length} connected board(s) flashed successfully.
`;return i.map(e=>{"error"===e.result?a+=`${e.board.manufacturer} ${e.board.name} failed to flash: ${e.message}
`:a+=`${e.board.manufacturer} ${e.board.name} was successfully flashed.
`}),{report:a,flashResults:i}}),flashViaPath:e0.input(s.z.object({boardPath:s.z.string(),flashPath:s.z.string().optional(),toolhead:ey.optional()})).meta({boardRequired:!0}).mutation(async({ctx:e,input:t})=>{if(null==e.board)throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`No supported board exists for the path ${t.boardPath}`});if(null==e.board.flashScript)throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`${e.board.name} does not support automatic flashing via serial path.`});if(t.flashPath&&!c().existsSync(t.flashPath))throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:`The path ${t.flashPath} does not exist.`});await compileFirmware(e.board,e.toolhead);let r=null;try{let o=h().join(e.board.path.replace(`${process.env.RATOS_CONFIGURATION_PATH}/boards/`,""),e.board.flashScript);r=t.flashPath?await runSudoScript("flash-path.sh",getBoardSerialPath(e.board,e.toolhead),t.flashPath):e.toolhead?await runSudoScript("flash-path.sh",getBoardSerialPath(e.board,e.toolhead)):await runSudoScript("board-script.sh",o)}catch(o){let t=o instanceof Error?o.message:o;throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Could not flash firmware to ${e.board.name}: 

 ${r?.stdout??t}`,cause:o})}if(!detect(e.board,e.toolhead))throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Could not flash firmware to ${e.board.name}, device did not show up at expected path.: 

 ${r.stdout}`});return"success"}),dfuDetect:e0.input(eJ).meta({boardRequired:!0}).query(async({ctx:e,input:t})=>{let r=parseInt((await (0,f.promisify)(d.exec)('lsusb | grep "0483:df11" | wc -l')).stdout,10);if(1===r)return!0;if(r>1)throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:"Multiple DFU devices detected, please disconnect the other devices."});return!1}),dfuFlash:e0.input(eJ).meta({boardRequired:!0}).mutation(async({ctx:e,input:t})=>{if(null!=e.board){if(null==e.board.dfu)throw new eU.TRPCError({code:"PRECONDITION_FAILED",message:"Board does not support DFU."});try{await compileFirmware(e.board,e.toolhead)}catch(r){let t=r instanceof Error?r.message:r;throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:`Could not compile firmware for ${e.board.name}: 

 ${t}`,cause:r})}try{let t=await runSudoScript("dfu-flash.sh",getBoardSerialPath(e.board,e.toolhead));return t.stdout}catch(e){throw new eU.TRPCError({code:"INTERNAL_SERVER_ERROR",message:"Failed to flash device",cause:e})}}})});let hasBeaconAccel=()=>{try{let e=(0,p.existsSync)("/dev/beacon")?(0,d.execSync)('udevadm info /dev/beacon | grep "ID_MODEL="').toString().trim():null;if(e&&e.endsWith("RevH"))return!0}catch(e){}return!1},xAccelerometerOptions=(e,t)=>{let r=[{id:"none",title:"None"},{id:"sbc",title:"Wired to Host Computer"}];return(e?.controlboard?.ADXL345SPI!=null||e?.controlboard?.LIS2DW!=null)&&r.push({id:"controlboard",title:"Wired to Controlboard"}),t?.toolboard!=null&&(null!=t.toolboard.ADXL345SPI||null!=t.toolboard.LIS2DW)&&r.push({id:"toolboard",title:"Integrated on toolboard"}),hasBeaconAccel()&&r.push({id:"beacon",title:"Beacon"}),r},yAccelerometerOptions=(e,t)=>{let r=[{id:"none",title:"None"},{id:"sbc",title:"Wired to Host Computer"}];return(e?.controlboard?.ADXL345SPI!=null||e?.controlboard?.LIS2DW!=null)&&r.push({id:"controlboard",title:"Wired to Controlboard"}),t?.toolboard!=null&&(null!=t.toolboard.ADXL345SPI||null!=t.toolboard.LIS2DW)&&r.push({id:"toolboard",title:"Integrated on toolboard"}),hasBeaconAccel()&&r.push({id:"beacon",title:"Beacon"}),r};var e1=r(29755),e2=r(44101),e4=r(15140),e5=r(85337);function getBaseUrl(){return process.env.RENDER_INTERNAL_HOSTNAME?`http://${process.env.RENDER_INTERNAL_HOSTNAME}:${process.env.PORT}/configure`:`http://127.0.0.1:${process.env.PORT??3e3}/configure`}(0,r(4129).createTRPCNext)({config:()=>({links:[(0,e5.httpBatchLink)({url:`${getBaseUrl()}/api/trpc`,maxURLLength:2083})]}),overrides:{useMutation:{async onSuccess(e){await e.originalFn(),await e.queryClient.invalidateQueries()}}},ssr:!1});let e3=(0,e5.createTRPCProxyClient)({links:[(0,e5.httpBatchLink)({url:`${getBaseUrl()}/api/trpc`,maxURLLength:2083})]});r(18910),r(7636),r(53489);var e6=r(58545),e9=r.n(e6),e8=r(45488);let e7=s.z.enum(["trace","debug","info","warn","error","fatal"]),te=s.z.object({ts:s.z.number(),messages:s.z.array(s.z.any()),bindings:s.z.array(s.z.record(s.z.string(),s.z.any())),level:s.z.object({label:e7,value:s.z.number()})}),send=async function(e,t){e3.clientLog.mutate({level:e,logEvent:te.parse(t)})},tt=null,logger_getLogger=()=>null!=tt?tt:tt=e9()({...e8.N,browser:{transmit:{send}}}),tr=new EventTarget,DispatchSaveAtomEvent=(e,t)=>{tr.dispatchEvent(new CustomEvent("saveAtom",{detail:{itemKey:e,value:t}}))},moonrakerWriteEffect=()=>e=>{e.onSet(t=>{DispatchSaveAtomEvent(e.node.key,null==t?"null":t)})},to={},readPrinterAtom=async({read:e})=>{let t=await e(ti.key);if(null!=t){let e=s.z.object({id:eE.shape.id}).safeParse(t);if(e.success||(e=s.z.object({id:eE.shape.id}).safeParse({id:t})),e.success){let t=to[e.data.id];return null==t&&(t=await e3.printer.printer.query(e.data.id,{}))&&(to[e.data.id]=t),t??null}}return null},readPrinterRailAtom=e=>async({read:t})=>{let r=await t(ts(e).key);if(null!=r){let o=m.Ah.safeParse(r);if(o.success)return o.data;let i=await readPrinterAtom({read:t}),n=i?.defaults.rails.find(t=>t.axis===e);if(null!=n){let e=m.Ah.safeParse({...n,...r});if(e.success)return e.data}}return null},ti=(0,e1.atom)({key:"Printer",default:null,effects:[moonrakerWriteEffect(),(0,e2.syncEffect)({read:readPrinterAtom,write:async({write:e},t)=>{await new Promise(r=>{t instanceof e1.DefaultValue?e(ti.key,null):e(ti.key,t??null),setTimeout(()=>{},500)})},refine:(0,e4.getRefineCheckerForZodSchema)(eE.nullable())})]});(0,e1.selector)({key:"LoadablePrinterState",get:async({get:e})=>{let t=e((0,e1.noWait)(ti));return({hasValue:()=>t.contents,hasError:()=>[],loading:()=>[]})[t.state]()}});let tn=(0,e1.atom)({key:"PrinterOption",default:null,effects:[moonrakerWriteEffect(),(0,e2.syncEffect)({refine:(0,e4.getRefineCheckerForZodSchema)(eO.nullable())})]}),ta=(0,e1.atom)({key:"Controlboard",default:null,effects:[moonrakerWriteEffect(),(0,e2.syncEffect)({read:async({read:e})=>{let t=await e(ta.key);if(null!=t){let e=s.z.object({id:A}).safeParse(t);if(e.success){let t=await e3.mcu.boards.query({boardFilters:{toolboard:!1}}),r=t.find(t=>t.id===e.data.id);return r??null}}return null},refine:(0,e4.getRefineCheckerForZodSchema)(F.nullable())})]}),ts=(0,e1.atomFamily)({key:"PrinterRail",default:null,effects:e=>[moonrakerWriteEffect(),(0,e2.syncEffect)({read:readPrinterRailAtom(e),refine:(0,e4.getRefineCheckerForZodSchema)(m.Ah.nullable())})]}),tl=(0,e1.selector)({key:"PrinterRails",get:({get:e})=>{let t=e(ti),r=t?.defaults.rails.map(t=>{let r=e(ts(t.axis));return deserializePrinterRail(r??t)});return r??[]},set:({set:e},t)=>{if(t instanceof e1.DefaultValue){Object.values(m.po).forEach(t=>{e(ts(t),null)});return}t.forEach(t=>{e(ts(t.axis),serializePrinterRail(t))})}});(0,e1.selector)({key:"LoadablePrinterRailsState",get:async({get:e})=>{let t=e((0,e1.noWait)(tl));return({hasValue:()=>t.contents,hasError:()=>[],loading:()=>[]})[t.state]()}});let td=(0,e1.atomFamily)({key:"PrinterToolhead",default:null,effects:e=>[moonrakerWriteEffect(),(0,e2.syncEffect)({read:async({read:t})=>{let r=await t(td(e).key);if("object"!=typeof r||null==r)return null;let{toolNumber:o,...i}=r;if(null!=i){let t=ex.safeParse(i);if(t.success){let r=t.data.toolboard;if(r&&null!=r){let e=s.z.object({id:A}).safeParse(r);if(e.success){let t=await e3.mcu.boards.query({boardFilters:{toolboard:!0}}),o=t.find(t=>t.id===e.data.id);o&&(r=M.parse(o))}}return{...t.data,toolboard:r,toolNumber:e}}logger_getLogger().debug("RecoilSync: failed to read toolhead!",td(e).key,t.error,i)}return null},refine:(0,e4.getRefineCheckerForZodSchema)(em.extend({toolNumber:eb}).nullable())})]});(0,e1.selectorFamily)({key:"DeserializeToolheadQuery",get:e=>async({get:t})=>{let r=ex.safeParse(await e3.printer.deserializeToolheadConfiguration.query({config:e.th,printerConfig:{controlboard:e.boardId}}));return r.success?{...r.data,toolNumber:e.toolNumber}:null}});let tp=(0,e1.selector)({key:"PrinterToolheadsState",get:({get:e})=>{let t=e(ti);return null==t?[]:e((0,e1.waitForAll)(t.defaults.toolheads.map((e,t)=>td(t)))).filter(Boolean)},set:({set:e,reset:t},r)=>{if(r instanceof e1.DefaultValue)throw Error("ToolheadsState cannot be reset, please reset the individual ToolheadState instead");r.forEach(t=>{e(td(t.toolNumber),{...t,toolNumber:t.toolNumber})})}});(0,e1.selector)({key:"LoadablePrinterToolheadsState",get:async({get:e})=>{let t=e((0,e1.noWait)(tp));return({hasValue:()=>t.contents,hasError:()=>[],loading:()=>[]})[t.state]()}});let tc=(0,e1.atom)({key:"PerformanceMode",default:!1,effects:[moonrakerWriteEffect(),(0,e2.syncEffect)({refine:(0,e4.getRefineCheckerForZodSchema)(s.z.boolean().optional().nullable())})]}),tu=(0,e1.atom)({key:"Stealchop",default:!1,effects:[moonrakerWriteEffect(),(0,e2.syncEffect)({refine:(0,e4.getRefineCheckerForZodSchema)(s.z.boolean().optional().nullable())})]}),th=(0,e1.atom)({key:"StandstillStealth",default:!1,effects:[moonrakerWriteEffect(),(0,e2.syncEffect)({refine:(0,e4.getRefineCheckerForZodSchema)(s.z.boolean().optional().nullable())})]}),tg=(0,e1.atom)({key:"ControllerFan",default:{id:"2pin",title:"Input Voltage PWM",badge:[{color:"purple",children:"Control Board"}]},effects:[moonrakerWriteEffect(),(0,e2.syncEffect)({refine:(0,e4.getRefineCheckerForZodSchema)(e_.nullable())})]}),tf=(0,e1.selector)({key:"PrinterConfiguration",get:async({get:e})=>{let{printer:t,printerSize:r,performanceMode:o,stealthchop:i,standstillStealth:n,rails:a,controlboard:s,controllerFan:l,toolheads:d}=e((0,e1.waitForAll)({printer:ti,printerSize:tn,performanceMode:tc,stealthchop:tu,standstillStealth:th,rails:tl,controlboard:ta,controllerFan:tg,toolheads:tp})),p={printer:null==t?null:{...t,defaults:{...t.defaults,toolheads:t?.defaults.toolheads.map(e=>serializeToolheadConfiguration(e))}},size:r,performanceMode:o,stealthchop:i,standstillStealth:n,rails:a,controlboard:s,controllerFan:l,toolheads:d.length>0?d:void 0},c=eD.safeParse(p);return!1===c.success&&logger_getLogger().error({errors:c.error.flatten().fieldErrors,data:p},"Couldn't parse printer configuration"),c.success?c.data:null}});(0,e1.selector)({key:"LoadablePrinterConfigurationState",get:async({get:e})=>{let t=e((0,e1.noWait)(tf));return({hasValue:()=>t.contents,hasError:()=>null,loading:()=>null})[t.state]()}});let serializePrinterConfiguration=e=>{let t={printer:e.printer.id,toolheads:e.toolheads.map(e=>serializeToolheadConfiguration(e)),size:e.size,controlboard:e.controlboard.id,controllerFan:e.controllerFan.id,performanceMode:e.performanceMode,stealthchop:e.stealthchop,standstillStealth:e.standstillStealth,rails:e.rails.map(e=>serializePrinterRail(e))};return eL.parse(t)};var t_=r(71569),tm=r.n(t_);function isNodeError(e){return e instanceof Error}let tb=(n=async(e,t)=>{let r=q.get(e);if(null!=r)return s.z.array(t).parse(r);let o=await (0,eG.glob)(`${process.env.RATOS_CONFIGURATION_PATH}/${e}/*.cfg`),i=(await Promise.all(o.map(e=>e.trim()).filter(e=>""!==e).map(async e=>{let r=await parseMetadata(e,t);return null==r?((0,l.getLogger)().warn(`No metadata present in ${e} skipping..`),null):r}))).filter(e=>null!=e);return q.set(e,i),i},async(e,t)=>{let r=q.get(`${e}`);if(null==r){let r=U.get(`${e}`);null==r&&(r=n(e,t),U.set(`${e}`,r));let o=await r;return q.set(`${e}`,o),o}return r}),serializedPartialConfigFromPrinterDefinition=e=>eM.parse({printer:e.id,controlboard:e.defaults.board}),getPrinters=async(e=!1)=>{let t=(0,eG.glob)(`${process.env.RATOS_CONFIGURATION_PATH}/printers/*/printer-definition.json`),r=await tb("hotends",es),o=await getBoards(),i={},n=(await Promise.all((await t).map(async e=>""===e.trim()?null:{...JSON.parse((await (0,eK.readFile)(e)).toString()),path:e.replace("printer-definition.json",""),id:e.replace("/printer-definition.json","").split("/").pop()}))).filter(Boolean);n.forEach(t=>{let n=serializedPartialConfigFromPrinterDefinition(t);i[t.id]=t.defaults.toolheads.map(async t=>{let i=(await r).find(e=>e.id===t.hotend);if(null==t.thermistor&&null!=i&&(t.thermistor=i.thermistor),null==t.nozzle&&(t.nozzle=getDefaultNozzle()),e){let e=await deserializeToolheadConfiguration(t,n,o);t=e}return t})});let a={};return await Promise.all(Object.keys(i).map(async e=>{let t=i[e];a[e]=await Promise.all(t)})),s.z.array(e?eE:e$).parse(n.map(e=>(e.defaults.toolheads=a[e.id],e)))},isPrinterCfgInitialized=async()=>{let e=_.serverSchema.parse(process.env);try{await (0,eK.access)(h().join(e.KLIPPER_CONFIG_PATH,"printer.cfg"),p.constants.F_OK)}catch(e){if(isNodeError(e)&&"ENOENT"===e.code)return!1;throw e}let t=await (0,eK.readFile)(h().join(e.KLIPPER_CONFIG_PATH,"printer.cfg"));return -1===t.indexOf("[include RatOS/printers/initial-setup.cfg]")},deserializeToolheadConfiguration=async(e,t,r)=>{let o=null==r?await getBoards():r,i=o.find(e=>e.id===t.controlboard),n=getToolboards(o),a=await tb("hotends",es),s=await tb("extruders",ed),l=await tb("z-probe",ep),d=n.find(t=>t.id===e.toolboard)??null,p=xAccelerometerOptions({controlboard:i},{toolboard:d}),c=yAccelerometerOptions({controlboard:i},{toolboard:d}),u={...e,toolboard:d,hotend:a.find(t=>t.id===e.hotend),extruder:s.find(t=>t.id===e.extruder),probe:l.find(t=>t.id===e.probe),thermistor:eo.find(t=>t===e.thermistor),xEndstop:xEndstopOptions({controlboard:i},{toolboard:d,axis:e.axis}).find(t=>t.id===e.xEndstop),yEndstop:yEndstopOptions({controlboard:i},{toolboard:d,axis:e.axis}).find(t=>t.id===e.yEndstop),xAccelerometer:p.find(t=>t.id===e.xAccelerometer)??(d&&(null!=d.ADXL345SPI||d.LIS2DW)?p.find(e=>"toolboard"===e.id):null),yAccelerometer:c.find(t=>t.id===e.yAccelerometer)??(d&&(null!=d.ADXL345SPI||d.LIS2DW)?c.find(e=>"toolboard"===e.id):null),partFan:partFanOptions({controlboard:i},{toolboard:d,axis:e.axis}).find(t=>t.id===e.partFan),hotendFan:hotendFanOptions({controlboard:i},{toolboard:d,axis:e.axis}).find(t=>t.id===e.hotendFan)};return ex.parse(u)},deserializePartialToolheadConfiguration=async(e,t,r)=>{r=r??await getBoards();let o=r.find(e=>e.id===t?.controlboard),i=getToolboards(r),n=await tb("hotends",es),a=await tb("extruders",ed),s=await tb("z-probe",ep),l=i.find(t=>t.id===e?.toolboard);return eP.parse({...e,toolboard:l??null,hotend:n.find(t=>t.id===e?.hotend),extruder:a.find(t=>t.id===e?.extruder),probe:s.find(t=>t.id===e?.probe),thermistor:eo.find(t=>t===e?.thermistor),xEndstop:xEndstopOptions({controlboard:o},{toolboard:l,axis:e?.axis??m.po.x}).find(t=>t.id===e?.xEndstop),yEndstop:yEndstopOptions({controlboard:o},{toolboard:l,axis:e?.axis??m.po.x}).find(t=>t.id===e?.yEndstop),xAccelerometer:xAccelerometerOptions({controlboard:o},{toolboard:l}).find(t=>t.id===e?.xAccelerometer),yAccelerometer:yAccelerometerOptions({controlboard:o},{toolboard:l}).find(t=>t.id===e?.yAccelerometer),partFan:partFanOptions({controlboard:o},{toolboard:l,axis:e?.axis??m.po.x}).find(t=>t.id===e?.partFan),hotendFan:hotendFanOptions({controlboard:o},{toolboard:l,axis:e?.axis??m.po.x}).find(t=>t.id===e?.hotendFan)})},deserializePartialPrinterConfiguration=async e=>{let t=await getBoards(),r=t.find(t=>t.id===e?.controlboard),o=e?.toolheads==null?void 0:await Promise.all(e.toolheads.map(async r=>await deserializePartialToolheadConfiguration(r,e,t)));return eD.parse({toolheads:o,printer:(await getPrinters()).find(t=>t.id===e?.printer),size:e?.size,controllerFan:controllerFanOptions({controlboard:r}).find(t=>t.id===e?.controllerFan),controlboard:r,performanceMode:e?.performanceMode,stealthchop:e?.stealthchop,standstillStealth:e?.standstillStealth,rails:e?.rails?.map(e=>deserializePrinterRail(e))})},deserializePrinterConfiguration=async e=>{let t=await getBoards(),r=t.find(t=>t.id===e?.controlboard),o=null==e.toolheads?void 0:await Promise.all(e.toolheads.map(r=>deserializeToolheadConfiguration(r,e,t)));return eF.parse({toolheads:o,printer:(await getPrinters()).find(t=>t.id===e?.printer),size:e?.size,controllerFan:controllerFanOptions({controlboard:r}).find(t=>t.id===e?.controllerFan),controlboard:r,performanceMode:e?.performanceMode,stealthchop:e?.stealthchop,standstillStealth:e?.standstillStealth,rails:e?.rails.map(e=>deserializePrinterRail(e))})},getTimeStamp=()=>{let e=new Date,t=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear(),i=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");return`${o}${r}${t}_${i}${n}${a}`},portModifications=async(e,t)=>{if((0,p.existsSync)(e)){let r=await (0,H.M_)(e,"#*# <---------------------- SAVE_CONFIG ---------------------->");!1!==r&&(t+="\n\n"+await (0,H.Sw)(e,r)+"\n")}return t},getFilesToWrite=async(e,t)=>{let o=await constructKlipperConfigUtils(e),i=constructKlipperConfigExtrasGenerator(e,o),n=await constructKlipperConfigHelpers(e,i,o),a=_.serverSchema.parse(process.env),{template:s,initialPrinterCfg:l}=await r(26004)(`./${e.printer.template.replace("-printer.template.cfg",".ts")}`),d=s(e,n).trim(),c=await portModifications(h().join(a.KLIPPER_CONFIG_PATH,"printer.cfg"),l(e,n).trim()),u=i.getFilesToWrite();return[{fileName:"RatOS.cfg",content:d,overwrite:!0,order:0},{fileName:"printer.cfg",order:1,content:c,overwrite:!await isPrinterCfgInitialized()}].concat(u).map(e=>{let r={...e,exists:!1,diskContent:null};return(t?.includes(r.fileName)||t?.includes("*"))&&(r.overwrite=!0),r.exists=(0,p.existsSync)(h().join(a.KLIPPER_CONFIG_PATH,r.fileName)),r.exists&&(r.diskContent=(0,p.readFileSync)(h().join(a.KLIPPER_CONFIG_PATH,r.fileName),"utf-8"),(0,p.existsSync)(h().join(a.RATOS_DATA_DIR,`last-${r.fileName}`))&&(r.lastSavedContent=(0,p.readFileSync)(h().join(a.RATOS_DATA_DIR,`last-${r.fileName}`),"utf-8"))),r})},generateKlipperConfiguration=async(e,t,r)=>{let o=_.serverSchema.parse(process.env),i=await getFilesToWrite(e,t),n=await Promise.all(i.map(async e=>{let t="created",i=h().join(o.KLIPPER_CONFIG_PATH,e.fileName),n=h().join(o.RATOS_DATA_DIR,`last-${e.fileName}`);try{if(await (0,eK.access)(i,p.constants.F_OK),!e.overwrite)return{fileName:e.fileName,action:"skipped"};{if(e.exists&&e.diskContent===e.content)return{fileName:e.fileName,action:"unchanged"};let r=`${e.fileName.split(".").slice(0,-1).join(".")}-${getTimeStamp()}.cfg`;try{await (0,eK.copyFile)(i,h().join(o.KLIPPER_CONFIG_PATH,r));let t=await (0,eG.glob)(h().join(o.KLIPPER_CONFIG_PATH,`${e.fileName.split(".").slice(0,-1).join(".")}-+([0-9])_+([0-9]).cfg`));if(t.length>0){let e=t.sort((e,t)=>{let r=new Date(e.split("-").slice(-1)[0].split(".cfg")[0]),o=new Date(t.split("-").slice(-1)[0].split(".cfg")[0]);return r.getTime()-o.getTime()});e.length>5&&await Promise.all(e.reverse().slice(0,e.length-5).map(e=>((0,l.getLogger)().info(`Removing old backup: ${e}`),(0,eK.unlink)(e))))}}catch(t){return{fileName:e.fileName,action:"error",err:t}}t="overwritten"}}catch(t){if(!isNodeError(t)||"ENOENT"!==t.code)return{fileName:e.fileName,action:"error",err:t}}try{if(r?.includes(e.fileName))return{fileName:e.fileName,action:"skipped"};return await (0,eK.writeFile)(i,e.content),await (0,eK.writeFile)(n,e.content),{fileName:e.fileName,action:t}}catch(t){return{fileName:e.fileName,action:"error",err:t}}})),a=n.filter(e=>"error"===e.action);if(a.length>0)throw a.map(e=>(0,l.getLogger)().error(e)),Error("Something went wrong when saving the configuration. The following files couldn't be written: "+a.map(e=>e.fileName).join(", "));try{await savePrinterSettings(serializePrinterConfiguration(e))}catch(e){throw Error("Couldn't backup your current printer settings to disk, but your klipper configuration has been generated.")}return n},compareSettings=async e=>{let t=_.serverSchema.parse(process.env),r=hasLastPrinterSettings()?await getFilesToWrite(await getLastPrinterSettings()):[],o=await getFilesToWrite(await deserializePrinterConfiguration(e)),i=await Promise.all(o.filter(e=>!e.exists||!r.some(t=>t.fileName===e.fileName)).map(async e=>{let t=new Date().getTime()+tm()(e);await (0,eK.writeFile)(`/tmp/ratos-added-new-${t}.cfg`,e.content);let r=await new Promise((e,r)=>{(0,d.exec)(`git diff --minimal --no-index /dev/null /tmp/ratos-added-new-${t}.cfg`,(t,o,i)=>{""==o.trim()&&r(i),e(o)})});return{fileName:e.fileName,diff:r,exists:e.exists,diskContent:e.diskContent??null,overwrite:e.overwrite,order:e.order,state:"created"}})),n=await Promise.all(r.filter(e=>e.exists&&!o.some(t=>t.fileName===e.fileName)).map(async e=>{let t=new Date().getTime()+tm()(e);await (0,eK.writeFile)(`/tmp/ratos-removed-old-${t}.cfg`,e.content);let r=await new Promise((e,r)=>{(0,d.exec)(`git diff --minimal --no-index /tmp/ratos-removed-old-${t}.cfg /dev/null`,(t,o,i)=>{""==o.trim()&&r(i),e(o)})});return{fileName:e.fileName,diff:r,exists:e.exists,diskContent:e.diskContent??null,overwrite:e.overwrite,order:e.order,state:"removed"}})),a=await Promise.all(o.filter(e=>e.exists&&r.some(t=>t.fileName===e.fileName&&(t.content!==e.content||null!=e.lastSavedContent&&t.content!==e.lastSavedContent))).map(async e=>{let o=r.find(t=>t.fileName===e.fileName);if(null==o)throw Error("This should never happen.");let i=new Date().getTime()+tm()(e),n=h().resolve(h().join(t.KLIPPER_CONFIG_PATH,o.fileName));o.exists||(n=`/tmp/ratos-changed-old-${i}.cfg`,await (0,eK.writeFile)(n,o.content)),await (0,eK.writeFile)(`/tmp/ratos-changed-new-${i}.cfg`,e.content);let a=await new Promise((e,t)=>{(0,d.exec)(`git diff --minimal --no-index ${n} /tmp/ratos-changed-new-${i}.cfg`,(r,o,i)=>{""==o.trim()&&t(i),e(o)})});return{fileName:e.fileName,diff:a,exists:e.exists,overwrite:e.overwrite,diskContent:e.diskContent??null,changedOnDisk:o.diskContent!==o.content,changedFromConfig:o.content!==e.content||null!=e.lastSavedContent&&o.content!==e.lastSavedContent,order:e.order,state:"changed"}})),s=await Promise.all(o.filter(e=>e.exists&&r.some(t=>t.fileName===e.fileName&&t.content===e.content&&(null==e.lastSavedContent||t.content===e.lastSavedContent))).map(async e=>{let o=r.find(t=>t.fileName===e.fileName);if(null==o)throw Error("This should never happen.");let i=null;if(o.diskContent!==o.content){let r=new Date().getTime()+tm()(e),n=h().resolve(h().join(t.KLIPPER_CONFIG_PATH,o.fileName));o.exists||(n=`/tmp/ratos-changed-old-${r}.cfg`,await (0,eK.writeFile)(n,o.content)),await (0,eK.writeFile)(`/tmp/ratos-changed-new-${r}.cfg`,e.content),i=await new Promise((e,t)=>{(0,d.exec)(`git diff --minimal --no-index ${n} /tmp/ratos-changed-new-${r}.cfg`,(r,o,i)=>{""==o.trim()&&t(i),e(o)})})}return{fileName:e.fileName,diff:i,exists:e.exists,overwrite:e.overwrite,diskContent:e.diskContent??null,changedOnDisk:o.diskContent!==o.content,changedFromConfig:o.content!==e.content||null!=e.lastSavedContent&&o.content!==e.lastSavedContent,order:e.order,state:"unchanged"}})),l=i.concat(n).concat(a).concat(s).sort((e,t)=>{if(null!=e.order||null!=t.order){if((e.order??9999)>(t.order??9999))return 1;if((e.order??9999)<(t.order??9999))return -1}return o.findIndex(t=>t.fileName===e.fileName)<o.findIndex(e=>e.fileName===t.fileName)?-1:o.findIndex(t=>t.fileName===e.fileName)>o.findIndex(e=>e.fileName===t.fileName)?1:e.fileName<t.fileName?-1:e.fileName>t.fileName?1:0});return l},loadSerializedConfig=async e=>{let t=await deserializePrinterConfiguration(await readSerializedConfig(e));return t},readSerializedConfig=async e=>{let t=await (0,eK.readFile)(e),r=eL.parse(JSON.parse(t.toString()));return r},regenerateKlipperConfiguration=async(e,t,r)=>await generateKlipperConfiguration(await getLastPrinterSettings(e),t,r),getToolhead=async(e,t,r)=>{let o=extractToolheadFromPrinterConfiguration(t,await deserializePartialPrinterConfiguration(e??{}))??null;return null==o?null:!0===r?o.serialize():o},getToolheads=async(e,t)=>{let r=extractToolheadsFromPrinterConfiguration(await deserializePartialPrinterConfiguration(e??{}))??null;return null==r?null:!0===t?r.map(e=>e.serialize()):r};(0,eV.Nd)({getSavedConfig:eV.$y.output(eL.nullable()).query(async e=>{let t=await getLastPrinterSettings(void 0,!0);return t}),getSavedPrinterName:eV.$y.output(s.z.string().nullable()).query(async e=>{let t=await getLastPrinterSettings(void 0,!0),r=(await getPrinters()).find(e=>e.id===t.printer);return null==r?null:r.manufacturer+" "+r.name}),printers:eV.$y.output(s.z.array(eE)).query(async()=>(await getPrinters(!0)).sort((e,t)=>"Rat Rig"===e.manufacturer&&("Rat Rig"!==t.manufacturer||t.description.indexOf("Discontinued")>-1)?-1:e.name.localeCompare(t.name))),printer:eV.$y.input(s.z.string()).output(eE.nullable()).query(async e=>{let t=(await getPrinters()).find(t=>t.id===e.input);return t?(t.defaults.toolheads=await Promise.all(t.defaults.toolheads.map(e=>deserializeToolheadConfiguration(e,serializedPartialConfigFromPrinterDefinition(t)))),eE.parse(t)):null}),hotends:eV.$y.output(s.z.array(es)).query(()=>tb("hotends",es)),extruders:eV.$y.output(s.z.array(ed)).query(()=>tb("extruders",ed)),probes:eV.$y.output(s.z.array(ep)).query(()=>tb("z-probe",ep)),thermistors:eV.$y.query(()=>eo.map(stringToTitleObject)),xEndstops:eV.$y.input(s.z.object({config:eM.nullable(),toolOrAxis:eT})).output(s.z.array(ec)).query(async e=>xEndstopOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),yEndstops:eV.$y.input(s.z.object({config:eM.nullable(),toolOrAxis:eT})).output(s.z.array(ec)).query(async e=>yEndstopOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),partFanOptions:eV.$y.input(s.z.object({config:eM.nullable(),toolOrAxis:eT})).output(s.z.array(e_)).query(async e=>partFanOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),hotendFanOptions:eV.$y.input(s.z.object({config:eM.nullable(),toolOrAxis:eT})).output(s.z.array(e_)).query(async e=>hotendFanOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),controllerFanOptions:eV.$y.input(s.z.object({config:eM.nullable()})).output(s.z.array(e_)).query(async e=>controllerFanOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolheads(e.input.config))?.map(e=>e.getConfig()))),xAccelerometerOptions:eV.$y.input(s.z.object({config:eM.nullable(),toolOrAxis:eT})).output(s.z.array(eg)).query(async e=>xAccelerometerOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),yAccelerometerOptions:eV.$y.input(s.z.object({config:eM.nullable(),toolOrAxis:eT})).output(s.z.array(eg)).query(async e=>yAccelerometerOptions(await deserializePartialPrinterConfiguration(e.input.config??{}),(await getToolhead(e.input.config,e.input.toolOrAxis))?.getConfig())),deserializeToolheadConfiguration:eV.$y.input(s.z.object({config:ey,printerConfig:eM.optional()})).query(async e=>await deserializeToolheadConfiguration(e.input.config,e.input.printerConfig??{})),printercfgStatus:eV.$y.query(async()=>({isInitialized:await isPrinterCfgInitialized()})),regenerateConfiguration:eV.$y.input(s.z.object({overwriteFiles:s.z.array(s.z.string()).optional(),skipFiles:s.z.array(s.z.string()).optional()})).mutation(async({input:e})=>{let t=await regenerateKlipperConfiguration(void 0,e.overwriteFiles,e.skipFiles);return t.some(e=>"created"===e.action||"overwritten"===e.action)&&(0,eZ.klipperRestart)(),t}),getFilesToWrite:eV.$y.input(s.z.object({config:eL})).mutation(async e=>{let{config:t}=e.input;return await compareSettings(t)}),saveConfiguration:eV.$y.input(s.z.object({config:eL,overwriteFiles:s.z.array(s.z.string()).optional(),skipFiles:s.z.array(s.z.string()).optional()})).mutation(async e=>{let{config:t,overwriteFiles:r,skipFiles:o}=e.input,i=await deserializePrinterConfiguration(t),n=await generateKlipperConfiguration(i,r,o);return(0,eZ.klipperRestart)(),n}),flashBeacon:eV.$y.mutation(async()=>{let e=_.serverSchema.parse(process.env),t=await runSudoScript(h().relative((0,H.xg)(),h().join(e.RATOS_CONFIGURATION_PATH,"scripts","beacon-update.sh")));if(t.stderr)throw Error(t.stderr);return t.stdout})})},26004:(e,t,r)=>{var o={"./extras/sensorless-homing":[24851,4851],"./extras/sensorless-homing.ts":[24851,4851],"./prusa-mini":[35224,5224],"./prusa-mini.ts":[35224,5224],"./prusa-mk3s":[5155,5155],"./prusa-mk3s.ts":[5155,5155],"./v-chonk":[2422,2422],"./v-chonk-3z":[5309,5309],"./v-chonk-3z.ts":[5309,5309],"./v-chonk.ts":[2422,2422],"./v-core-3":[89321,9321],"./v-core-3-idex":[35085,5085],"./v-core-3-idex.ts":[35085,5085],"./v-core-3.ts":[89321,9321],"./v-core-4":[94231,4231],"./v-core-4-hybrid":[95024,5024],"./v-core-4-hybrid.ts":[95024,5024],"./v-core-4-idex":[40589,589],"./v-core-4-idex.ts":[40589,589],"./v-core-4.ts":[94231,4231],"./v-core-pro":[16264,6264],"./v-core-pro.ts":[16264,6264],"./v-minion":[93751,3751],"./v-minion.ts":[93751,3751],"./voron-v01":[19884,9884],"./voron-v01.ts":[19884,9884],"./voron-v24":[21788,1788],"./voron-v24.ts":[21788,1788]};function webpackAsyncContext(e){if(!r.o(o,e))return Promise.resolve().then(()=>{var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t});var t=o[e],i=t[0];return r.e(t[1]).then(()=>r(i))}webpackAsyncContext.keys=()=>Object.keys(o),webpackAsyncContext.id=26004,e.exports=webpackAsyncContext}};