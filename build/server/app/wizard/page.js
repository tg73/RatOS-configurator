(()=>{var e={};e.id=363,e.ids=[363],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},38316:e=>{"use strict";e.exports=require("zod")},39491:e=>{"use strict";e.exports=require("assert")},50852:e=>{"use strict";e.exports=require("async_hooks")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},73292:e=>{"use strict";e.exports=require("fs/promises")},98188:e=>{"use strict";e.exports=require("module")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},14521:e=>{"use strict";e.exports=require("readline")},12781:e=>{"use strict";e.exports=require("stream")},71576:e=>{"use strict";e.exports=require("string_decoder")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},26144:e=>{"use strict";e.exports=require("vm")},71267:e=>{"use strict";e.exports=require("worker_threads")},69515:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>n.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>c,routeModule:()=>x,tree:()=>d});var r=s(30584),a=s(72023),i=s(16443),n=s.n(i),l=s(32055),o={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>l[e]);s.d(t,o);let d=["",{children:["wizard",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,11559)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/wizard/page.tsx"]}]},{layout:[()=>Promise.resolve().then(s.bind(s,28912)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/wizard/layout.tsx"],metadata:{icon:[async e=>(await Promise.resolve().then(s.bind(s,33374))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}]},{layout:[()=>Promise.resolve().then(s.bind(s,69113)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/layout.tsx"],template:[()=>Promise.resolve().then(s.bind(s,4278)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/template.tsx"],error:[()=>Promise.resolve().then(s.bind(s,43086)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/error.tsx"],loading:[()=>Promise.resolve().then(s.bind(s,43962)),"/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/loading.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,10540,23)),"next/dist/client/components/not-found-error"],metadata:{icon:[async e=>(await Promise.resolve().then(s.bind(s,33374))).default(e)],apple:[],openGraph:[],twitter:[],manifest:void 0}}],c=["/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/wizard/page.tsx"],m="/wizard/page",u={require:s,loadChunk:()=>Promise.resolve()},x=new r.AppPageRouteModule({definition:{kind:a.x.APP_PAGE,page:"/wizard/page",pathname:"/wizard",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},40721:(e,t,s)=>{Promise.resolve().then(s.bind(s,86953)),Promise.resolve().then(s.bind(s,41891))},86953:(e,t,s)=>{"use strict";s.r(t),s.d(t,{Wizard:()=>Wizard});var r=s(96603),a=s(99027),i=s(51495),n=s.n(i),l=s(36986),o=s(45041);let useSteps=e=>{let{onStepChange:t}=e,[s,r]=(0,i.useState)(null==e.step||isNaN(e.step)||null==e.steps[e.step]?0:e.step),a=e.steps[s],n=(0,i.useRef)(s);n.current=s;let l=(0,i.useCallback)(e=>{t?.(e,"set"),r(e)},[t]);(0,i.useEffect)(()=>{e.step&&!isNaN(e.step)&&e.step!==n.current&&null!=e.steps[e.step]&&r(e.step)},[e.step,e.steps]);let o=s<e.steps.length-1,d=s>0,c=(0,i.useCallback)(()=>{r(e=>(t?.(e+1,"increment"),e+1))},[t]),m=(0,i.useCallback)(()=>{r(e=>(t?.(e-1,"decrement"),e-1))},[t]),u={..."extraScreenProps"in e?e.extraScreenProps:{},key:"step-"+s,hasNextScreen:o||(e.parentScreenProps?.hasNextScreen??!1),hasPreviousScreen:d||(e.parentScreenProps?.hasNextScreen??!1),nextScreen:o?c:e.parentScreenProps?.hasNextScreen?e.parentScreenProps.nextScreen:void 0,previousScreen:d?m:e.parentScreenProps?.hasPreviousScreen?e.parentScreenProps.previousScreen:void 0,skipSteps:e.parentScreenProps&&e.parentScreenProps.hasNextScreen?e.parentScreenProps.nextScreen:void 0},x="function"==typeof a.name?a.name(u):a.name,h="function"==typeof a.description?a.description(u):a.description,p={...u,name:x,description:h};return{screenProps:p,currentStepIndex:s,setCurrentStepIndex:l,currentStep:e.steps[s]}};var d=s(86128),c=s(24240),m=s(61418),u=s(55428);let VerticalSteps=e=>r.jsx("nav",{"aria-label":"Progress",children:r.jsx("ol",{role:"list",className:"overflow-hidden",children:e.steps.map((t,s)=>{let a="function"==typeof t.name?t.name(e.screenProps):t.name,i="function"==typeof t.description?t.description(e.screenProps):t.description;return r.jsx("li",{className:(0,m.dV)(s!==e.steps.length-1?"pb-10":"","relative"),children:e.currentStepIndex>s?(0,r.jsxs)(r.Fragment,{children:[s!==e.steps.length-1?r.jsx("div",{className:"absolute left-4 top-4 -ml-px mt-0.5 h-full w-0.5 bg-brand-600 dark:bg-brand-500","aria-hidden":"true"}):null,(0,r.jsxs)("span",{className:"group relative flex cursor-pointer items-start",onClick:()=>e.setCurrentStepIndex(s),children:[r.jsx("span",{className:"flex h-9 items-center",children:r.jsx("span",{className:"relative z-10 flex h-8 w-8 items-center justify-center rounded-full bg-brand-600 dark:bg-brand-500",children:r.jsx(u.Z,{className:"h-5 w-5 text-brand-100 dark:text-brand-900",strokeWidth:3,"aria-hidden":"true"})})}),(0,r.jsxs)("span",{className:"ml-4 flex min-w-0 flex-col",children:[r.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide dark:text-zinc-200",children:a}),r.jsx("span",{className:"text-sm text-zinc-500 dark:text-zinc-400",children:i})]})]})]}):e.currentStepIndex===s?(0,r.jsxs)(r.Fragment,{children:[s!==e.steps.length-1?r.jsx("div",{className:"absolute left-4 top-4 -ml-px mt-0.5 h-full w-0.5 bg-zinc-300 dark:bg-zinc-700","aria-hidden":"true"}):null,(0,r.jsxs)("span",{className:(0,m.m6)("group relative flex items-start",t.canBeSkippedTo&&"cursor-pointer"),"aria-current":"step",onClick:t.canBeSkippedTo?()=>e.setCurrentStepIndex(s):void 0,children:[r.jsx("span",{className:"flex h-9 items-center","aria-hidden":"true",children:r.jsx("span",{className:"relative z-10 flex h-8 w-8 items-center justify-center rounded-full border-2 border-brand-600 bg-white dark:border-brand-500 dark:bg-zinc-800",children:r.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-brand-600 dark:bg-brand-500"})})}),(0,r.jsxs)("span",{className:"ml-4 flex min-w-0 flex-col",children:[r.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide text-brand-600 dark:text-brand-500",children:a}),r.jsx("span",{className:"text-sm text-zinc-500 dark:text-zinc-400",children:i})]})]})]}):(0,r.jsxs)(r.Fragment,{children:[s!==e.steps.length-1?r.jsx("div",{className:"absolute left-4 top-4 -ml-px mt-0.5 h-full w-0.5 bg-zinc-300 dark:bg-zinc-700","aria-hidden":"true"}):null,(0,r.jsxs)("span",{className:(0,m.m6)("group relative flex items-start",t.canBeSkippedTo&&"cursor-pointer"),"aria-current":"step",onClick:t.canBeSkippedTo?()=>e.setCurrentStepIndex(s):void 0,children:[r.jsx("span",{className:"flex h-9 items-center","aria-hidden":"true",children:r.jsx("span",{className:"relative z-10 flex h-8 w-8 items-center justify-center rounded-full border-2 border-zinc-300 bg-white dark:border-zinc-700 dark:bg-zinc-800",children:r.jsx("span",{className:"h-2.5 w-2.5 rounded-full bg-transparent"})})}),(0,r.jsxs)("span",{className:"ml-4 flex min-w-0 flex-col",children:[r.jsx("span",{className:"text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-200",children:a}),r.jsx("span",{className:"text-sm text-zinc-500 dark:text-zinc-400",children:i})]})]})]})},a)})})});var x=s(19623),h=s(10291),p=s(57450),g=s(1047);let StepNavButtons=e=>{let t=e.left?.isLoading?r.jsx(c.$,{noMargin:!0,className:"dark:text-black"}):r.jsx(h.Z,{className:"-ml-2 h-5 w-5","aria-hidden":"true"}),s=e.left?.onClick?r.jsx("div",{className:"flex flex-1 justify-start",children:(0,r.jsxs)(x.z,{variant:"indeterminate",disabled:e.left.disabled,onClick:e.left.isLoading?void 0:e.left.onClick,title:e.left.title,className:e.left.isLoading?"cursor-wait":"cursor-pointer",children:[t,e.left.label??"Back"]})}):null,a=e.right.isLoading?r.jsx(c.$,{noMargin:!0,className:"dark:text-black"}):r.jsx(p.Z,{className:"-mr-2 h-5 w-5","aria-hidden":"true"}),i=e.right.onClick?(0,r.jsxs)("div",{className:"flex flex-1 justify-end gap-4",children:[e.skip&&(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:e.skip.onClick,disabled:e.skip.disabled,title:e.skip.title,children:[e.skip.label??"Skip",r.jsx(g.Z,{className:"-mr-1.5 h-5 w-5","aria-hidden":"true"})]}),(0,r.jsxs)(x.z,{variant:"primary",disabled:e.right.disabled,onClick:e.right.isLoading?void 0:e.right.onClick,title:e.right.title,className:e.right.isLoading?"cursor-wait":void 0,children:[e.right.label??"Next",a]})]}):null;return r.jsx("div",{className:(0,m.dV)(e.inTitle?"":"px-8 pb-5"),children:(0,r.jsxs)("nav",{className:(0,m.dV)("flex items-center justify-between border-zinc-200 py-3 dark:border-zinc-700",e.inTitle?"":" border-t"),"aria-label":"Pagination",children:[s,i]})})};var f=s(30006),b=s(78303),j=s(50089),v=s(64933),N=s(75310),k=s(79030),y=s(66416),z=s(30819),S=s(30413),w=s(39238),C=s(21118),P=s(78438),F=s(89909);let HardwareSelection=e=>{let[t,s]=(0,i.useState)(!1),{selectedControllerFan:a,selectedBoard:l,selectedPrinter:o,performanceMode:d,setPerformanceMode:m,stealthchop:u,setStealthchop:x,standstillStealth:h,setStandstillStealth:p,selectedPrinterRails:g,setSelectedControllerFan:T,serializedPrinterConfiguration:E,parsedPrinterConfiguration:O,partialPrinterConfiguration:$}=(0,b.usePrinterConfiguration)(),R=[],I=!1===O.success?O.error.format():null,D={};return $?.rails?.forEach((e,t)=>{let s=[];[z.po.extruder,z.po.extruder1].includes(e.axis)||null!=e.motorSlot||(R.push(`Motor slot for ${e.axis.toUpperCase()} is not set`),s=[`Motor slot for ${e.axis.toUpperCase()} is not set`]),D[t]={...I?.rails?.[t]??{},_errors:I?.rails?.[t]?._errors?.concat(s??[])??s}}),null!=$&&!1===O.success&&O.error.flatten().formErrors.forEach(e=>{R.push(e)}),(0,i.useEffect)(()=>{!1===O.success&&O.error.errors.some(e=>"rails"===e.path[0])&&(0,i.startTransition)(()=>{s(!0)})},[O]),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"p-4 @sm:p-8",children:[(0,r.jsxs)("div",{className:"mb-5 border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Select your printer hardware"}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:"If your hardware isn't listed, pick the one closest to it and override as necessary in printer.cfg later"})]}),(0,r.jsxs)(P.i,{children:[R.length>0&&r.jsx(j.B,{className:"mb-4",children:r.jsx(S.M,{children:R.map(e=>r.jsx(w.E.div,{className:"mt-2",exit:{opacity:0,scale:.9,y:-40},initial:{opacity:1,scale:1,y:0},animate:{opacity:1,scale:1,y:0},children:e},e))})}),E?.toolheads!=null&&r.jsx(S.M,{children:E?.toolheads?.map((e,t)=>null==e||null==e.axis?null:r.jsx(w.E.div,{exit:{opacity:0,scale:.9,y:-40},initial:{opacity:1,scale:1,y:0},animate:{opacity:1,scale:1,y:0},children:r.jsx(n().Suspense,{fallback:r.jsx(c.$,{}),children:r.jsx(y.Y,{toolOrAxis:e.axis})})},e.axis))}),(0,r.jsxs)("div",{className:"mt-4 border-t border-zinc-100 pt-8 dark:border-zinc-700",children:[r.jsx("div",{className:"flex",children:r.jsx("h3",{className:"flex-1 text-base font-medium leading-7 text-zinc-900 dark:text-zinc-100",children:"Electronics"})}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:"Configure miscellaneous electronics settings"})]}),r.jsx("div",{className:"mt-4 grid grid-cols-1 gap-4 border-t border-zinc-100 pt-4 dark:border-zinc-700 sm:grid-cols-2",children:r.jsx("div",{children:r.jsx(f.LV,{label:"Controller fan",query:"controllerFanOptions",vars:{config:E},help:F.Ie,onSelect:T,value:a})})}),(0,r.jsxs)("div",{className:"mt-4 border-t border-zinc-100 pt-8 dark:border-zinc-700",children:[(0,r.jsxs)("div",{className:"flex",children:[r.jsx("h3",{className:"flex-1 text-base font-medium leading-7 text-zinc-900 dark:text-zinc-100",children:"Motion"}),r.jsx("div",{children:r.jsx(v.Z,{label:"Simple",onLabel:"Advanced",onChange:s,value:!!t})})]}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:"Configure your stepper motor and driver settings"})]}),(0,r.jsxs)("div",{className:"mt-4 grid grid-cols-1 gap-4 border-t border-zinc-100 pt-4 dark:border-zinc-700 sm:grid-cols-2",children:[o?.speedLimits.performance&&r.jsx("div",{className:"col-span-2",children:r.jsx(v.Z,{label:"Performance mode",description:"Increases the stepper power, max acceleration and velocity. Not recommended for initial setup. Requires actively cooled drivers (controller fan).",onChange:m,value:!!d})}),r.jsx("div",{className:"col-span-2",children:r.jsx(v.Z,{label:"Stealthchop",description:"Silent operation at the cost of a 135 mm/s velocity limit and less positional accuracy. Not recommended unless quiteness is absolutely necessary.",onChange:x,value:!!u})}),r.jsx("div",{className:"col-span-2",children:r.jsx(v.Z,{label:"Standstill Stealth",description:"Makes steppers silent when idling, but can cause unpredictable behavior on some drivers. Can result in skipped steps and positional errors, use with caution.",onChange:p,value:!!h})})]})]}),r.jsx("div",{children:o&&r.jsx(C.S,{id:"rails",children:r.jsx(P.i,{className:"grid gap-4 py-4 sm:grid-cols-2",children:g.map((e,s)=>{let a=o.defaults.rails.find(t=>t.axis===e.axis);if(null==a)throw Error("No printer default for axis "+e.axis);let i=null==D[s]?0:Object.keys(D[s]).reduce((e,t)=>{let r=D[s][t];if(null==r)return e;let a=Array.isArray(r)?r.length:r._errors?.length??0;return e+a},0);return r.jsx(n().Suspense,{fallback:r.jsx(c.$,{}),children:r.jsx(N.l,{errors:D[s],selectedBoard:l,printerRail:e,printerRailDefault:(0,k.Oj)(a),performanceMode:d,isVisible:t||i>0},e.axis)},e.axis)})})})})]}),r.jsx(StepNavButtons,{left:{onClick:e.previousScreen},right:{onClick:e.nextScreen,disabled:!O.success||R.length>0,title:!1===O.success||R.length>0?"Invalid printer configuration selected":void 0}})]})};var T=s(49614),E=s(78765),O=s(34070),$=s(56886);let MutationStatus=e=>e.isError?r.jsx("div",{className:"mb-4 h-48",children:r.jsx(j.B,{children:e.error?.message})}):!e.isLoading||e.isIdle||e.isPaused?null:r.jsx("div",{className:"absolute right-5 top-9 mb-4 flex items-center",children:r.jsx(c.$,{})});var R=s(96303),I=s(67415);let DFUFlash=e=>{let{data:t,error:s}=a.S.mcu.dfuDetect.useQuery({boardPath:e.board.path,toolhead:e.toolhead?.serialize()},{refetchInterval:1e3}),n=a.S.mcu.dfuFlash.useMutation({onSuccess:e.onSuccess}),[l,o]=(0,i.useState)(!1),d=(0,i.useCallback)(async()=>{o(!0),n.mutate({boardPath:e.board.path,toolhead:e.toolhead?.serialize()},{onSettled:()=>o(!1)})},[n,e.board.path,e.toolhead]),c=s?r.jsx(j.B,{children:s.message}):null,m="boardPath="+encodeURIComponent(e.board.path),u=e.board.dfu?.instructions.map((e,t)=>r.jsx("li",{children:e},t)),h=t&&e.board.dfu?.hasBoot0Jumper?r.jsx(R.$,{title:"Reminder",children:"Make sure to remove the BOOT0 jumper from the board before flashing."}):null;return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("h3",{className:"text-xl font-medium text-zinc-900 dark:text-zinc-100",children:["Flashing ",e.board.name," via DFU"]}),c,(0,r.jsxs)("p",{className:"mt-4 text-zinc-500 dark:text-zinc-400",children:["Status: ",t?"DFU device detected":"DFU not detected"]}),h,r.jsx(x.z,{variant:"primary",disabled:!t||l,onClick:d,children:l?"Flashing...":t?"Flash":"Waiting for DFU..."}),r.jsx("h4",{className:"text-sm font-medium text-zinc-900 dark:text-zinc-100",children:"DFU Boot Instructions"}),(0,r.jsxs)("div",{className:"prose mt-4 text-base text-zinc-500 dark:text-zinc-400",children:[r.jsx("ol",{className:"mb-4 list-decimal pl-4",children:u}),r.jsx("img",{src:"/configure/api/dfu-image?"+m,alt:"DFU boot buttons and/or jumper visualization"})]})]})};var D=s(32801),M=s(20342),q=s(7786),L=s(71521),V=s(99234),B=s(29340),A=s(75919);let SDCardFlashing=e=>{let[t,s]=(0,i.useState)(!1),{query:n,isReady:l}=(0,V.oK)(),[o,d]=(0,i.useState)(!1),m=a.S.mcu.compile.useMutation({onSuccess:()=>d(!0),onError:()=>d(!1)}),u=(0,q.D)({mutationFn:()=>(l&&n("machine.shutdown"),Promise.reject("Cannot reboot raspberry pi: No connection to moonraker"))}),h=m.isLoading?(0,r.jsxs)("span",{children:["Compiling... ",r.jsx(c.$,{className:"ml-1 inline",noMargin:!0})]}):(0,r.jsxs)("span",{children:["Compile firmware ",r.jsx(D,{className:"inline h-5 w-5"})]});return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("h3",{className:"text-xl font-medium text-zinc-900 dark:text-zinc-100",children:[e.board.manufacturer," ",e.board.name," was not detected"]}),r.jsx(x.z,{variant:"primary",onClick:o?void 0:()=>m.mutate({boardPath:e.board.path,toolhead:e.toolhead?.serialize()}),className:"w-52 justify-center",disabled:m.isLoading&&!o,href:o?`/api/download-firmware?boardPath=${encodeURIComponent(e.board.path)}`:void 0,children:o?(0,r.jsxs)("span",{children:["Download firmware ",r.jsx(M,{className:"inline h-5 w-5"})]}):h}),m.error?.message?r.jsx(j.B,{children:m.error?.message}):null,(0,r.jsxs)("div",{className:"prose mt-4 text-base text-zinc-500 dark:text-zinc-400",children:[(0,r.jsxs)("ol",{className:"mb-4 list-decimal pl-4",children:[r.jsx("li",{children:"Disconnect all wires except Power and USB, and make sure your jumpers are set correctly."}),r.jsx("li",{children:"Format the sd card for your board to FAT16 (sometimes just called FAT), or FAT32 with a clustersize of 8kb or 4kb."}),r.jsx("li",{children:"If you're reusing a card you've used for flashing before, be sure to delete ALL files on the card (or reformat it)."}),r.jsx("li",{children:"Copy the firmware binary onto the sd card for your board"}),r.jsx("li",{children:'Make sure the firmware file is called firmware.bin on the sd card (enable "display file extensions" in your file explorer). The file you downloaded will already have the correct name.'}),r.jsx("li",{children:"Safely eject the SD card through your operating system."}),r.jsx("li",{children:"Physically take out the sd card and insert it into your control board."}),r.jsx("li",{children:"Click the reset button on the board, or turn it off and back on again. NOTE: if the Raspberry Pi running RatOS is currently powered by your control board or the same power source, please shut it down safely first by using the button below. When the green light stops blinking and is turned off, you can cut the power."}),r.jsx("li",{children:'Click "Check board status" below.'})]}),(0,r.jsxs)("div",{className:"flex gap-x-4",children:[r.jsx(x.z,{variant:"indeterminate",onClick:()=>{s(!0)},children:"Shutdown RatOS"}),r.jsx(x.z,{variant:"primary",onClick:e.onSuccess,children:"Check board status"})]})]}),t?r.jsx(L.u,{title:"Shutdown RatOS?",body:"You raspberry pi will shutdown and this page will become unresponsive until it's powered back on.",content:r.jsx(B.j,{color:"yellow",title:"Premature power removal can cause SD card corruption",Icon:A.Z,children:"Do not remove power before the green light on the Rasperry Pi has stopped blinking."}),buttonLabel:"Shutdown",onClick:()=>{u.mutate()},onClose:()=>setTimeout(()=>s(!1),500)}):null]})};var Z=s(47994),W=s(73367),_=s(60965),U=s(64338),H=s(45481),Y=s(30300),Q=s(72651),G=s(61331);let MCUFlashing=e=>{let[t,s]=(0,i.useState)(!1),[n,l]=(0,i.useState)(null),[o,d]=(0,i.useState)(null),{selectedControlboard:m,selectedToolboard:u,toolhead:h}=e,p=h?u:m,g=a.S.mcu.detect.useQuery({boardPath:p?.path??"",toolhead:h?.serialize()},{refetchInterval:e=>!0!==e&&1e3,enabled:null!==p}),f=a.S.mcu.unidentifiedDevices.useQuery({toolhead:h?.serialize()}),b=a.S.mcu.boardVersion.useQuery({boardPath:p?.path??"",toolhead:h?.serialize()},{enabled:null!==p&&!!g.data&&!1===t,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),{data:j}=a.S.klipperVersion.useQuery(void 0,{refetchInterval:6e4}),v=a.S.mcu.flashViaPath.useMutation({onSuccess:()=>s(!1)}),N=(0,i.useCallback)(()=>{l(null),s(!0),d(null),g.remove(),b.remove()},[b,g]),k=(0,i.useCallback)(()=>{b.refetch()},[b]),y={onClick:e.nextScreen,label:"Next",disabled:!g.data||t},z={onClick:e.previousScreen},S=(0,i.useCallback)(()=>{null!=p&&(l("path"),v.mutate({boardPath:p.path,toolhead:h?.serialize()}))},[v,p,h]),w=null;if(b.error&&!t)w=(0,r.jsxs)(i.Fragment,{children:[(0,r.jsxs)("h3",{className:"text-xl font-medium text-zinc-900 dark:text-zinc-100",children:[p?.name," detected but is unresponsive."]}),r.jsx("p",{children:'Klipper doesn\'t seem to be running on your board, which may indicate faulty firmware or a faulty board. Try hitting the reset button on your board, and click "Check Again" below.'}),r.jsx("p",{children:"If it keeps failing, please check your board and try flashing it again."}),(0,r.jsxs)("p",{className:"flex justify-start gap-4",children:[(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:k,children:[r.jsx(_.Z,{className:"h-5 w-5"}),r.jsx("span",{children:"Check again"})]}),(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:N,children:[r.jsx(U.Z,{className:"h-5 w-5"}),r.jsx("span",{children:"Flash again"})]})]})]});else if(b.isFetching)w=(0,r.jsxs)(i.Fragment,{children:[(0,r.jsxs)("h3",{className:"text-xl font-medium text-zinc-900 dark:text-zinc-100",children:[r.jsx(c.$,{className:"relative -top-0.5 mr-2 inline",noMargin:!0})," ",p?.name," detected, checking version..."]}),r.jsx("p",{children:"Please wait while RatOS queries your board.."})]});else if(b.data||g.data&&!t){let e="dfu"===n&&p?.dfu?.reminder?r.jsx(R.$,{title:"Reminder",children:p?.dfu?.reminder}):null,t=null!=b.data&&null!=j&&b.data!==j?(0,r.jsxs)(I.j,{title:"Version mismatch",children:["The board is running version ",b.data," but you your pi is on version ",j,". If you want to update your board click 'flash again' below."]}):null;w=(0,r.jsxs)(i.Fragment,{children:[(0,r.jsxs)("h3",{className:"text-xl font-medium text-zinc-900 dark:text-zinc-100",children:[r.jsx(O,{className:"relative -top-0.5 inline h-7 w-7 text-brand-700 dark:text-brand-500"})," ",p?.name," detected"]}),e,t,(0,r.jsxs)("p",{children:["Proceed to the next step or"," ",(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:N,children:[r.jsx("span",{children:"Flash again"})," ",r.jsx($,{className:"inline h-5 w-5"})]})]})]})}else if(null==n){let e=p?.dfu!=null,t=!p?.isToolboard,s=g.data&&p?.flashScript!=null,a=f.data?.length,n=(0,r.jsxs)(Z.Card,{className:"flex flex-col justify-between",children:[(0,r.jsxs)(W.Ol,{children:[(0,r.jsxs)(W.ll,{className:"flex items-center justify-between gap-2",children:["Manual flashing using DFU",e?!s&&e?r.jsx(G.Ct,{color:"lime",children:"Recommended"}):null:r.jsx(G.Ct,{color:"yellow",children:"Unavailable"})]}),r.jsx(W.SZ,{children:"Flash the board by manually placing a boot jumper or clicking boot and reset buttons on your board. Instructions will be provided on the next page."})]}),r.jsx(W.aY,{className:"text-right xl:text-left",children:(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:()=>l("dfu"),disabled:!e,className:"justify-endt",title:e?void 0:"This board does not support DFU flashing.",children:[r.jsx(H.Z,{className:"size-4"}),"Flash manually via DFU"]})})]}),o=(0,r.jsxs)(Z.Card,{className:"flex flex-col justify-between",children:[(0,r.jsxs)(W.Ol,{children:[r.jsx(W.ll,{children:"Manual flashing using an SD-card"}),r.jsx(W.SZ,{children:"Flash the board by placing the firmware on an SD-card and inserting it into the board. Instructions will be provided on the next page."}),r.jsx(W.SZ,{className:"text-sky-300/50",children:"This method is generally not recommended unless other methods aren't available."})]}),r.jsx(W.aY,{className:"text-right xl:text-left",children:(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:()=>l("sdcard"),disabled:!t,className:"justify-center",title:t?void 0:"This board does not support SD card flashing.",children:[r.jsx(Y.Z,{className:"size-4"}),"Flash manually via SD card"]})})]}),c=(0,r.jsxs)(Z.Card,{className:"flex flex-col justify-between",children:[(0,r.jsxs)(W.Ol,{children:[(0,r.jsxs)(W.ll,{className:"flex items-center justify-between gap-2",children:["Automated flashing",s?r.jsx(G.Ct,{color:"lime",children:"Recommended"}):r.jsx(G.Ct,{color:"yellow",children:"Unavailable"})]}),r.jsx(W.SZ,{children:"If RatOS has already detected your board, it can be flashed automatically. This is the fastest and easiest method."})]}),r.jsx(W.aY,{className:"text-right xl:text-left",children:(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:S,disabled:!s,className:"justify-center",title:s?void 0:"Board was not detected.",children:[r.jsx(U.Z,{className:"size-4"}),"Flash automatically"]})})]}),m=(0,r.jsxs)(Z.Card,{className:"flex flex-col justify-between",children:[(0,r.jsxs)(W.Ol,{children:[(0,r.jsxs)(W.ll,{className:"flex items-center justify-between gap-2",children:["Flash unidentified board",!a&&r.jsx(G.Ct,{color:"yellow",className:"mr-1",children:"Unavailable"})]}),r.jsx(W.SZ,{children:"If RatOS detects any boards that are already running klipper but not managed by RatOS, their device path will be listed here. These will flash automatically, but make sure you pick the right one. If you're unsure what to pick, choose one of the other methods."})]}),r.jsx(W.aY,{className:"text-right xl:text-left",children:(0,r.jsxs)(x.z,{variant:"indeterminate",className:"justify-center",disabled:!a,title:a?void 0:"No unidentified boards detected.",dropdownItems:f.data?.map(e=>({onClick:()=>{null!=p&&(l("path"),d(e),v.mutate({boardPath:p.path,flashPath:e,toolhead:h?.serialize()}))},title:e})),children:[r.jsx(Q.Z,{className:"size-4"}),"Flash unidentified board"]})})]});w=(0,r.jsxs)(i.Fragment,{children:[(0,r.jsxs)("h3",{className:"text-xl font-medium text-zinc-900 dark:text-zinc-100",children:["How do you want to flash your ",p?.name,"?"]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-1 xl:grid-cols-2",children:[c,n,o,m]})]})}else if(null==p)w=r.jsx("div",{children:r.jsx("div",{className:"prose mt-4 text-base text-red-700",children:"You have to select a board before navigating to this screen."})});else switch(n){case"dfu":w=r.jsx(DFUFlash,{board:p,onSuccess:()=>s(!1),toolhead:h});break;case"sdcard":w=r.jsx(SDCardFlashing,{board:p,onSuccess:()=>s(!1),toolhead:h});break;case"path":w=(0,r.jsxs)("div",{children:[(0,r.jsxs)("h3",{className:"text-xl font-medium text-zinc-900 dark:text-zinc-100",children:["Flashing ",p.name,o?` at ${o}`:"","..."]}),r.jsx("div",{className:"prose mt-4 text-base text-zinc-500",children:"Please wait while RatOS flashes your board."}),r.jsx(MutationStatus,{...v})]})}return(0,r.jsxs)(i.Fragment,{children:[(0,r.jsxs)("div",{className:"p-4 @sm:p-8",children:[" ",(0,r.jsxs)("div",{className:"mb-5 border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:e.name}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:e.description})]}),(0,r.jsxs)("div",{className:"space-y-4 text-zinc-700 dark:text-zinc-300",children:[e.children,w]})]}),r.jsx(StepNavButtons,{right:y,left:z})]})};var X=s(86181);let CardSelector=e=>{let[t,s]=(0,i.useState)(null),{onSelect:a}=e,n=(0,i.useCallback)(t=>{void 0===e.value&&s(t),a?.(t)},[a,e.value]);return(0,i.useEffect)(()=>{void 0!==e.value&&s(e.value)},[e.value]),r.jsx(X.E,{value:t,onChange:n,children:r.jsx(w.E.div,{className:"grid grid-cols-1 gap-4 2xl:grid-cols-2",children:e.cards.map((t,s)=>r.jsx(X.E.Option,{value:t,className:({checked:e,active:t})=>(0,m.dV)(e?"border-transparent":"border-zinc-300 dark:border-zinc-700","relative flex cursor-pointer items-stretch rounded-lg border bg-white px-4 py-4 shadow-sm focus:outline-none active:ring-0 dark:bg-zinc-800/70"),children:({active:s,checked:a})=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex flex-1 flex-col items-stretch justify-between gap-4",children:[t.left&&r.jsx(X.E.Description,{as:"div",className:"mr-4 mt-2 flex text-sm sm:mt-0 sm:block sm:text-left",children:t.left}),(0,r.jsxs)("div",{className:"flex flex-shrink-0 flex-col",children:[r.jsx(X.E.Label,{as:"div",className:"flex items-center space-x-2 text-sm font-bold text-zinc-900 dark:text-zinc-100",children:e.title?e.title(t):t.name}),r.jsx(X.E.Description,{as:"div",className:"mt-1 flex-1 text-xs font-medium text-zinc-500 dark:text-zinc-400",children:r.jsx("div",{className:"sm:inline",children:t.details})})]})]}),t.right&&r.jsx(X.E.Description,{as:"div",className:"ml-4 mt-2 flex text-sm sm:mt-0 sm:block sm:text-right",children:t.right}),r.jsx("div",{className:(0,m.dV)(a?"border-brand-600":"border-transparent","pointer-events-none absolute -inset-px rounded-lg border-2"),"aria-hidden":"true"})]})},t.id))})})};var K=s(4854);let categorizeList=(e,t)=>{let s={};return e.forEach(e=>{let r=t(e);s[r]||(s[r]=[]),s[r].push(e)}),s};var J=s(55277),ee=s(10814);let MCUPicker=e=>{let{toolhead:t,skipSteps:s,setSelectedBoard:a,selectedControlboard:l,selectedToolboard:o,selectedPrinter:d,cards:c}=e,[m,u]=n().useState(null),h=(0,i.useCallback)((e=l)=>null!=d&&(e?.driverCount??0)<d.driverCountRequired,[l,d]),p=t?o?.detected:l?.detected,g=categorizeList(c.filter(e=>{if(null==m||m?.trim()==="")return!0;let t=m.toLowerCase(),s=[e.board.name.toLowerCase(),e.board.manufacturer.toLowerCase(),...e.board.driverVoltages.map(e=>e.toString()),...e.board.integratedDrivers?Object.values(e.board.integratedDrivers).map(e=>e.toString().toLowerCase()):[],e.board.flashScript&&!e.board.disableAutoFlash?"automatic flashing":"manual flashing",e.board.integratedDrivers?"integrated drivers":"step sticks"];return t.split(" ").every(e=>s.some(t=>t.includes(e)||e.includes(t)))}),e=>e.board.manufacturer),f=Object.keys(g).sort((e,t)=>g[t].length-g[e].length).map(e=>(0,r.jsxs)("div",{className:"mb-8",children:[r.jsx("h3",{className:"font-display font-bold tracking-tight text-zinc-300",children:e}),(0,r.jsxs)("p",{className:"mb-4 max-w-4xl text-sm font-medium text-zinc-500 dark:text-zinc-500",children:["Supported boards from ",e]}),r.jsx(CardSelector,{cards:g[e],value:c.find(e=>e.id===(t?o:l)?.id),onSelect:a})]},e)),b={onClick:e.nextScreen,label:"Next",disabled:!0},j={onClick:e.previousScreen},v=(0,i.useCallback)(()=>{s?.()},[s]),N=(t&&!h()||p)&&s&&v?{onClick:v,label:"Skip"}:void 0;return(!t||h()&&null==o)&&(t||null==l)||(b={onClick:e.nextScreen,label:"Next"}),(0,r.jsxs)(i.Fragment,{children:[(0,r.jsxs)("div",{className:"p-4 @sm:p-8",children:[" ",(0,r.jsxs)("div",{className:"mb-5 flex border-b border-zinc-200 pb-2 dark:border-zinc-700",children:[(0,r.jsxs)("div",{className:"flex-1",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:e.name}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:e.description})]}),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[r.jsx("div",{children:t&&t.getMotionAxis()===z.po.x&&null!=o&&r.jsx(x.z,{onClick:()=>a(null),variant:"danger",children:"Clear selection"})}),r.jsx(StepNavButtons,{right:b,skip:N,inTitle:!0})]})]}),(0,r.jsxs)("div",{className:"mb-6 border-b border-zinc-200 pb-2 dark:border-zinc-800",children:[r.jsx("h3",{className:"mb-1 text-base font-bold text-zinc-900 dark:text-zinc-300",children:"Search boards"}),(0,r.jsxs)("div",{className:"relative",children:[r.jsx(K.I,{placeholder:"Filter boards...",value:m??"",onChange:e=>u(e.target.value),className:"mb-4 h-8 w-full pr-8"}),null!=m&&m?.trim()!=""?r.jsx(J.Z,{onClick:()=>{u(null)},className:"absolute right-2 top-1.5 h-5 w-5 cursor-pointer text-zinc-400 hover:text-rose-400"}):r.jsx(ee.Z,{className:"absolute right-2 top-1.5 h-5 w-5 text-zinc-400"})]})]}),(0,r.jsxs)(P.i,{containerClassName:"overflow-hidden",children:[e.children,f]})]}),r.jsx(StepNavButtons,{right:b,left:j,skip:N})]})};var et=s(82251),es=s(36815),er=s.n(es),ea=s(68587),ei=s(77532),en=s(86053);let el=[{id:"01",name:e=>`Pick ${e.toolhead?`${e.toolhead.getToolCommand()} Toolboard`:"Control board"}`,description:e=>`Pick the ${e.toolhead?`toolboard for ${e.toolhead.getDescription()}. If you don't use a toolboard you can skip this step.`:"control board. Toolboard(s) can be added in a later step."}`,href:"#",renderScreen:e=>(0,i.createElement)(MCUPicker,{...e,key:e.key})},{id:"02",name:e=>`${e.toolhead?`${e.toolhead.getToolCommand()} Toolboard`:"Control board"} flashing`,description:e=>`Make sure your ${e.toolhead?`toolboard for ${e.toolhead.getDescription()}`:"control board"} is flashed and up to date.`,href:"#",renderScreen:e=>(0,i.createElement)(MCUFlashing,{...e,key:e.key})}],MCUPreparation=e=>{let{selectedPrinter:t,selectedBoard:s,setSelectedBoard:n}=(0,b.usePrinterConfiguration)(),{toolhead:o,setToolhead:d}=(0,et.yk)(e.toolOrAxis,!1),c=a.S.mcu.boards.useQuery({boardFilters:{driverCountRequired:null!=o?void 0:(t?.driverCountRequired??0)-(t?.defaults.toolheads.length??1)},toolhead:o?.serialize(),controlboard:s?.id},{keepPreviousData:!0}),m=c.data?.find(e=>e.id==s?.id)??null,u=c.data?.find(e=>e.id==o?.getToolboard()?.id)??null,x=(0,i.useCallback)((e=m)=>null!=t&&(e?.driverCount??0)<t.driverCountRequired,[m,t]),h=(0,i.useMemo)(()=>c.isError||null==c.data?[]:c.data.filter(e=>e.isToolboard==(null!=o||null)).map(e=>{let t="";if(e.integratedDrivers&&Object.keys(e.integratedDrivers).length){let s=Object.entries(e.integratedDrivers).reduce((e,[t,s])=>{let r=k.Df(s)?.title;return r&&(null==e[r]&&(e[r]=0),e[r]+=1),e},{}),r=Object.entries(s).map(([e,t])=>`${1==t?"an":t} integrated ${e} driver${t>1?"s":""}`);t=`A ${e.isToolboard?"tool board":"control board"} with ${r.length>1?r.slice(0,-1).join(", ")+" and "+r[r.length-1]:r.join("")} ${e.driverCount>Object.keys(e.integratedDrivers).length?`(${e.driverCount} total driver${e.driverCount>1?"s":""})`:""} and`}else t=`${e.driverCount}-driver ${e.isToolboard?"tool board":"control board"} with`;t+=` ${e.flashScript&&!e.disableAutoFlash?"support for automatic flashing":"manual flashing"}.`;let s=e.driverVoltages.length>1?`${e.driverVoltages.slice(0,-1).join("V, ")}V and ${e.driverVoltages[e.driverVoltages.length-1]}V`:`${e.driverVoltages[0]}V`;(e.driverVoltages.length>1||24!=e.driverVoltages[0])&&(t+=` Supports running steppers at ${s}${e.driverVoltages.length>1?" via a dedicated motor power input port":""}.`);let a=e.boardImageFileName?"/configure/api/mcu-image?boardId="+encodeURIComponent(e.id):"/configure/img/missing-board-img.webp";return{id:e.id,board:e,name:(0,r.jsxs)("h3",{className:"flex gap-2",children:[e.name,!o&&x(e)&&r.jsx(G.Ct,{color:"yellow",size:"sm",children:"Toolboard required"})]}),details:(0,r.jsxs)("div",{className:"flex-col justify-between",children:[r.jsx("p",{className:"mt-1 flex-1 text-xs font-medium text-zinc-500 dark:text-zinc-400",children:t}),(0,r.jsxs)("div",{className:"mt-4 flex gap-2",children:[r.jsx(G.Ct,{color:e.detected?"lime":"gray",size:"sm",children:r.jsx(ea.Z,{className:"h-4 w-4"})}),r.jsx(G.Ct,{size:"md",color:e.flashScript&&!e.disableAutoFlash?"lime":"rose",title:"Automatic flashing",children:e.flashScript&&!e.disableAutoFlash?r.jsx(U.Z,{className:"h-4 w-4"}):r.jsx(ei.Z,{className:"h-4 w-4"})}),(0,r.jsxs)(G.Ct,{color:"gray",size:"sm",className:"text-base/5",children:[r.jsx(Y.Z,{className:"h-4 w-4"}),e.driverCount]})]})]}),right:r.jsx("div",{className:"relative",children:r.jsx(er(),{src:a,className:"aspect-auto rounded-lg object-contain object-right",width:100,height:100,alt:`${e.manufacturer} ${e.name}`})})}}),[c.isError,c.data,o,x]),p=(0,l.useRecoilCallback)(({reset:e,snapshot:t})=>async s=>{if(o)d({...o.getConfig(),toolboard:null==s?null:T.MG.parse(s.board)});else if(null!=s){n(T.$l.parse(s.board));let r=await t.getPromise(en.OS);null!=r&&r.id!=s.board.id&&e(en.q7)}},[n,d,o]),g={selectedControlboard:m,selectedToolboard:u,cards:h,setSelectedBoard:p,selectedPrinter:t,toolhead:o},{currentStep:f,screenProps:j}=useSteps({steps:el,parentScreenProps:e,extraScreenProps:g});return f.renderScreen({...j,...g,children:r.jsx(E.o,{...c})})};var eo=s(15611);let CardSelectorWithOptions=e=>{let[t,s]=(0,i.useState)(null),[a,n]=(0,i.useState)(null),l=(0,i.useRef)({selected:t,selectedOption:a}),{onSelect:o}=e,[d]=(0,eo.u)(),c=(0,i.useCallback)(t=>{l.current.selected!==t&&(void 0===e.value&&(s(t),void 0===e.optionValue&&n(t.options?.[0]??null)),l.current.selected=t,l.current.selectedOption=t.options?.[0]??null,o?.(t,t.options?.[0]??null))},[o,e.value,e.optionValue]),u=(0,i.useCallback)((t,r)=>{void 0===e.value&&(s(t),n(r)),l.current.selected=t,l.current.selectedOption=r,o?.(t,r)},[o,e.value]);return(0,i.useEffect)(()=>{void 0!==e.value&&e.value!==l.current.selected&&s(e.value),void 0!==e.optionValue&&e.optionValue!==l.current.selectedOption&&n(e.optionValue)},[e.value,e.optionValue]),r.jsx(X.E,{value:t,onChange:c,children:r.jsx("div",{className:"grid grid-cols-1 gap-4 xl:grid-cols-2",ref:d,children:e.cards.map((e,s)=>r.jsx(X.E.Option,{value:e,className:({checked:e,active:t})=>(0,m.dV)(e?"border-transparent":"border-zinc-300 dark:border-zinc-700","relative flex cursor-pointer items-stretch rounded-lg border bg-white px-4 py-4 shadow-sm  focus:outline-none active:ring-0 dark:bg-zinc-800/70"),children:({active:s,checked:i})=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex flex-1 items-stretch justify-between gap-4",children:[(0,r.jsxs)("div",{className:"flex flex-1 flex-col",children:[r.jsx(X.E.Label,{as:"p",className:"text-sm font-bold text-zinc-900 dark:text-zinc-100",children:e.name}),r.jsx(X.E.Description,{as:"div",className:"mt-1 flex-1 text-xs font-medium text-zinc-500 dark:text-zinc-400",children:r.jsx("div",{className:"sm:inline",children:e.details})}),null!=e.options&&(0,r.jsxs)(X.E,{value:t?.id===e.id?a:null,onChange:t=>u(e,t),className:"mt-2 w-full",children:[r.jsx(X.E.Label,{className:"sr-only",children:" Choose a size option "}),r.jsx("div",{className:"grid grid-cols-3 gap-1 2xl:grid-cols-4",children:e.options.map(e=>r.jsx(X.E.Option,{value:e,className:({active:e,checked:t})=>(0,m.m6)(e||t?"ring-2":"ring-1","flex items-center justify-center rounded-md px-3 py-3 text-sm font-semibold uppercase ring-inset sm:flex-1 xl:text-xs 2xl:text-sm",(0,G.xU)({color:t?"brand":"gray"}),(0,G.iA)({color:e||t?"brand":"gray"}),(0,G._1)({color:e||t?"brand":"gray"}),e||t?"":"dark:hover:bg-zinc-400/30"),children:r.jsx(X.E.Label,{as:"span",children:e.name})},e.name))})]})]}),r.jsx(X.E.Description,{as:"div",className:"flex-0 relative flex text-sm sm:block sm:text-right",children:e.right})]}),r.jsx("div",{className:(0,m.dV)(i?"border-brand-600":"border-transparent","pointer-events-none absolute -inset-px rounded-lg border-2"),"aria-hidden":"true"})]})},e.id))})})},ShowWhenReady=e=>e.queryErrors.length>0&&e.showErrors?r.jsx(j.B,{className:"mb-4",children:e.queryErrors.map(e=>r.jsx("div",{className:"mt-2",children:e},e))}):e.isReady||0!==e.queryErrors.length?r.jsx(P.i,{children:e.children}):r.jsx("div",{className:"flex min-h-12 flex-1 items-center justify-center",children:r.jsx(c.$,{})});var ed=s(83926),ec=s(90431);let PrinterSelection=e=>{let t=a.S.printer.printers.useQuery(),s=a.S.mcu.boards.useQuery({}),n=a.S.printer.getSavedConfig.useQuery(),c=(0,l.useRecoilValue)(en.Xu),m=(0,l.useRecoilValue)(en.hq),u=t.data?t.data.slice().filter(e=>"Rat Rig"===e.manufacturer).sort((e,t)=>e.releaseDate?.localeCompare(t.name)??e.name.localeCompare(t.name)).map(e=>{let t="printerId="+encodeURIComponent(e.id);return{id:e.id,name:`${e.manufacturer} ${e.name}`,details:e.description,printer:e,right:r.jsx("div",{className:"relative",children:r.jsx(er(),{src:"/configure/api/printer-image?"+t,className:"aspect-auto rounded-lg object-contain object-right",width:100,height:100,alt:`${e.manufacturer} ${e.name}`})}),options:Object.values(e.sizes).length>1?Object.entries(e.sizes).map(([e,t])=>({id:e,name:e+"",volume:t})):void 0}}):[],x=t.data?t.data.slice().filter(e=>"Rat Rig"!==e.manufacturer).sort((e,t)=>(e.manufacturer+e.name).localeCompare(t.manufacturer+t.name)).map(e=>{let t="printerId="+encodeURIComponent(e.id);return{id:e.id,name:`${e.manufacturer} ${e.name}`,details:e.description,printer:e,right:r.jsx("div",{className:"relative",children:r.jsx(er(),{src:"/configure/api/printer-image?"+t,className:"aspect-auto rounded-lg object-contain object-right",width:100,height:100,alt:`${e.manufacturer} ${e.name}`})}),options:Object.values(e.sizes).length>1?Object.entries(e.sizes).map(([e,t])=>({id:e,name:e+"",volume:t})):void 0}}):[],h=u.find(e=>e.id===c?.id)??x.find(e=>e.id===c?.id),p=h?.options?.find(e=>"string"!=typeof m&&"number"!=typeof m?m?.x===e.volume.x&&m?.y===e.volume.y&&m?.z===e.volume.z:e.id===m),g=(0,l.useRecoilCallback)(({set:e,reset:t,snapshot:r})=>async(a,i,n)=>{let l=a.printer;if(null==l){(0,ed.j)().error(a,"No printer found matching the criteria");return}let c=await r.getPromise(en.H6);if(c?.id!==l.id&&e(en.H6,l),Object.values(l.sizes).length>1){if(null==i||"string"!=typeof i.id)throw Error("An option must be selected for printers that come in different size configurations");e(en.hq,l.sizes[i.id])}else e(en.hq,l.sizes[Object.keys(l.sizes)[0]]);if(c?.id===l.id)return;let m=await r.getPromise(d.$T),u=await r.getPromise(en.q7);if(n)m.length>l.defaults.toolheads.length&&m.slice(l.defaults.toolheads.length).forEach(e=>{t((0,d.AF)(e.toolNumber))}),m.length<l.defaults.toolheads.length&&l.defaults.toolheads.slice(m.length).forEach(t=>{let s=new o.D(t).getTool();e((0,d.AF)(s),{...m[0],toolNumber:s})}),e(en.q7,u.map(e=>{let t=l.defaults.rails.find(t=>t.axis===e.axis);if(null!=t){let s=(0,k.Ak)(t);return{...s,driver:e.driver,current:e.current,motorSlot:e.motorSlot,voltage:e.voltage,microstepping:e.microstepping,invertStepperDirection:e.invertStepperDirection,stepper:e.stepper,axisMaximum:e.axisMaximum,axisMinimum:e.axisMinimum,axisEndstop:e.axisEndstop}}return e}));else{m.forEach(e=>{t((0,d.AF)(e.toolNumber))}),e(d.$T,l.defaults.toolheads.map(e=>({...e,toolNumber:new o.D(e).getTool()}))),t(b.PerformanceModeState),t(b.StealthchopState),t(b.StandstillStealthState),t(b.ControllerFanState),t(en.q7);let r=s.data?.find(e=>e.id===l.defaults.board);null!=r&&e(en.OS,r),l.defaults.controllerFan?e(b.ControllerFanState,{id:l.defaults.controllerFan,title:l.defaults.controllerFan}):t(b.ControllerFanState)}},[t.data]),f=(0,i.useRef)(null),[j,v]=(0,i.useState)(!1),N=(0,i.useCallback)((e,t)=>{if(null==c){g(e,t,!1),v(!1);return}let s=e.printer;if(null==s){(0,ed.j)().error(e,"No printer found matching the criteria"),v(!1);return}if(c.id===s.id){if(m===t)return;g(e,t,!0);return}f.current={card:e,option:t},v(!0)},[g,c,m]),y=t.error?[t.error?.message]:[];return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"p-4 @sm:p-8",children:[(0,r.jsxs)("div",{className:"mb-5 border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Select your printer"}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:"This will determine the template used for printer.cfg"})]}),(0,r.jsxs)(ShowWhenReady,{isReady:t.isFetched,queryErrors:y,children:[r.jsx("h3",{className:"font-display font-bold tracking-tight text-zinc-300",children:"Official Support"}),r.jsx("p",{className:"mb-4 max-w-4xl text-sm font-medium text-zinc-500 dark:text-zinc-500",children:"These printers are officially supported by Rat Rig and the RatOS team."}),r.jsx(CardSelectorWithOptions,{cards:u,onSelect:N,value:h,optionValue:p}),r.jsx("h3",{className:"font-display mt-8 font-bold tracking-tight text-zinc-300",children:"Community Support"}),r.jsx("p",{className:"mb-4 max-w-4xl text-sm font-medium text-zinc-500 dark:text-zinc-500",children:"These printers are supported through community contributions and may not be as well tested."}),r.jsx(CardSelectorWithOptions,{cards:x,onSelect:N,value:h,optionValue:p})]})]}),j&&r.jsx(L.u,{title:"How do you want to proceed?",buttonLabel:"Reuse configuration",secondButtonLabel:"Start fresh",onClickSecondButton:()=>g(f.current.card,f.current.option,!1),onClick:()=>g(f.current.card,f.current.option,!0),body:`You already configured a printer, do you want to reuse your existing hardware configuration or start fresh from the ${f.current?.card.printer.name} defaults?`,content:r.jsx(P.i,{children:n.data&&r.jsx(B.j,{color:"sky",Icon:ec.Z,title:"Your klipper configuration is safe!",children:"Your existing klipper configuration will be safe until you explicitly save a new hardware configuration at the end of the wizard."})}),onClose:()=>setTimeout(()=>{v(!1),f.current=null},500)}),r.jsx(StepNavButtons,{left:{onClick:e.previousScreen},right:{onClick:e.nextScreen,disabled:null==c,title:null==c?"You have to select a printer":void 0}})]})};var em=s(55260),eu=s(98947),ex=s(14472),eh=s(40535),ep=s(39587),eg=s(14835);let parseSignal=e=>e>=-40?r.jsx("span",{className:"font-semibold text-green-700",children:"Excellent"}):e>=-67?r.jsx("span",{className:"font-semibold text-lime-600",children:"Very good"}):e>=-70?r.jsx("span",{className:"font-semibold text-yellow-600",children:"Okay"}):e>=-80?r.jsx("span",{className:"font-semibold text-orange-500",children:"Not good"}):e>=-100?r.jsx("span",{className:"font-semibold text-red-600",children:"Unusable"}):void 0,signalIcon=(e,t)=>{let s=r.jsx(r.Fragment,{});return e>=-100&&(s=r.jsx(eu.Z,{className:"absolute inset-0 h-full w-full text-red-600"})),e>=-80&&(s=r.jsx(ex.Z,{className:"absolute inset-0 h-full w-full text-orange-500"})),e>=-70&&(s=r.jsx(eh.Z,{className:"absolute inset-0 h-full w-full text-yellow-600"})),e>=-67&&(s=r.jsx(ep.Z,{className:"absolute inset-0 h-full w-full text-lime-600"})),e>=-40&&(s=r.jsx(eg.Z,{className:"absolute inset-0 h-full w-full text-green-700"})),(0,r.jsxs)("div",{className:(0,m.m6)("relative inline-block h-8 w-8",t),children:[r.jsx(eg.Z,{className:"absolute inset-0 h-full w-full text-zinc-700"}),s]})};var ef=s(13728);let eb=ef.z.object({hostname:ef.z.string().min(2).regex(/^([a-zA-Z0-9]|-)+$/,"Hostname can only include a-Z, 0-9 and dashes.")}),ej=ef.z.object({ssid:ef.z.string().min(1).max(32),passphrase:ef.z.string().min(8).max(63),frequencies:ef.z.string(),country:ef.z.string().optional(),hidden:ef.z.boolean().optional()});var ev=s(90469),eN=s(73531);let WifiSetup=e=>{let t=n().useRef(null),[s,l]=(0,i.useState)(!0),[o,d]=(0,i.useState)({}),[m,u]=(0,i.useState)(null),[h,p]=(0,i.useState)(""),[g,f]=(0,i.useState)("RatOS"),[b,v]=(0,i.useState)(!1),[N,k]=(0,i.useState)(!1),[y,z]=(0,i.useState)(null),{isError:S,error:w,data:C}=a.S.wifi.scan.useQuery({showHidden:N},{refetchInterval:(e,t)=>!t.state.error&&1e3,retry:!1,enabled:s&&null==m}),P=a.S.wifi.hostname.useMutation(),F=a.S.wifi.join.useMutation();(0,i.useEffect)(()=>()=>{null!=t.current&&clearTimeout(t.current)},[]),(0,i.useEffect)(()=>{d(e=>{let t={...e};return C?.forEach(e=>{t[e.address]=e}),t})},[C]);let T=(0,i.useMemo)(()=>Object.values(o).filter(e=>null!=m&&e.ssid===m.ssid&&1e3>Math.abs(e.frequency-m?.frequency)).map(e=>e.frequency).join(" "),[o,m]),E=m?.ssid==null||m?.ssid.trim()==="",O=E?y:m?.ssid,$=eb.safeParse({hostname:g}),I=ej.safeParse({passphrase:h,ssid:O,country:m?.country,frequencies:T,hidden:E}),D=(0,i.useMemo)(()=>S?[]:Object.keys(o).filter(e=>null!=o[e].ssid||N).map(e=>({name:o[e].ssid?.trim()==""?"Hidden SSID":o[e].ssid??"Hidden SSID",id:e,details:(0,r.jsxs)("div",{className:"gap-4 md:grid md:grid-cols-2",children:[(0,r.jsxs)("div",{className:"md:col-span-1 2xl:flex 2xl:flex-col",children:[r.jsx("span",{className:"font-semibold",children:"Signal Strength:"})," ",r.jsx("span",{className:"whitespace-nowrap font-medium",children:parseSignal(o[e].signal)})]}),(0,r.jsxs)("div",{className:"md:col-span-1 2xl:flex 2xl:flex-col",children:[r.jsx("span",{className:"font-semibold",children:"Frequency:"})," ",(0,r.jsxs)("span",{className:"whitespace-nowrap font-medium text-zinc-300",children:[Math.round(o[e].frequency/100)/10,"GHz"]})]})]}),right:signalIcon(o[e].signal)})).sort((e,t)=>o[e.id].signal>o[t.id].signal?-1:o[e.id].signal<o[t.id].signal?1:0),[S,o,N]),M=(0,i.useCallback)(e=>{u(o[e.id])},[o]),q=(0,i.useCallback)(()=>{if(null==m)throw Error("Cannot join wifi without selecting a network");I.success&&F.mutate(I.data)},[I,m,F]),V=a.S.reboot.useMutation(),A=(0,i.useCallback)(async()=>{await V.mutateAsync(),window.close()},[V]),Z=(0,i.useCallback)(async()=>{await P.mutateAsync({hostname:g}),v(!0)},[P,g]),W=m&&F.isSuccess&&b&&!V.isSuccess&&!V.isError?r.jsx(L.u,{title:"Settings saved!",body:`RatOS is now setup to connect to ${m.ssid}! Your raspberry pi will now reboot, and join your local wifi network. Click the button below to reboot the pi and close this window. You can then reconnect to your local network where http://${g}.local/ should be available in a few minutes. If RatOS fails to join ${m.ssid}, it will recreate the "ratos" hotspot and you'll have to try again.`,content:(0,r.jsxs)(B.j,{color:"yellow",title:"Premature power removal can cause SD card corruption",Icon:_.Z,children:["Make sure to go to ",r.jsx("a",{href:"http://${hostname}.local/config",children:"the machine tab in mainsail"})," and update all your packages before you continue with the setup."]}),buttonLabel:"Got it!",onClick:A}):V.isError?r.jsx("div",{className:"mb-4 h-48",children:r.jsx(j.B,{children:V.error.message})}):V.isLoading||V.isSuccess?(0,r.jsxs)("div",{className:"mb-4 h-48",children:[r.jsx("div",{className:"mb-4 flex items-center justify-center font-bold text-zinc-900 dark:text-zinc-100",children:"Rebooting..."}),r.jsx("div",{className:"mb-4 flex items-center justify-center  text-zinc-600 dark:text-zinc-400",children:(0,r.jsxs)("div",{children:["Please reconnect to ",m?.ssid??"your local network"," and visit"," ",(0,r.jsxs)("a",{href:`http://${g}.local/configure?step=1`,className:"text-brand-600 dark:text-brand-400",children:["http://",g,".local/configure?step=1"]})," ","in a few minutes."]})})]}):m&&F.isSuccess?r.jsx(em.o,{label:"Printer hostname",type:"text",value:g,error:P.isError?P.error.message:$.success?void 0:$.error.issues[0].message,onChange:e=>f(e),help:'Only use characters from a-Z and dashes. For example, entering "RatOS" will make your printer available at http://RatOS.local/'},"hostname"):m?(0,r.jsxs)("div",{className:"grid gap-4",children:[E?r.jsx("div",{className:"mb-4",children:r.jsx(R.$,{title:"Hidden SSID",children:"You have selected a hidden SSID. Please enter the SSID and password manually."})}):r.jsx("div",{children:(0,r.jsxs)("div",{className:"mb-4 inline-flex gap-4 rounded-md border-2 border-brand-400/45 bg-brand-400/5 p-4",children:[r.jsx("div",{className:"",children:signalIcon(m.signal,"h-12 w-12")}),(0,r.jsxs)("div",{className:"flex flex-col gap-2 text-sm text-zinc-500 dark:text-zinc-400",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:m.ssid}),m.country," - ",Math.round(m.frequency/100)/10,"GHz"]})]})}),E&&r.jsx(em.o,{label:"SSID",type:"text",value:y??"",error:F.isError?F.error.message:I.success?void 0:I.error.formErrors.fieldErrors.ssid?.join("\n"),onChange:z},"ssid"),r.jsx(em.o,{label:m.security.toLocaleUpperCase()+" Password",type:"password",value:h,error:F.isError?F.error.message:I.success?void 0:I.error.formErrors.fieldErrors.passphrase?.join("\n"),onChange:e=>p(e+"")},"password")]}):S?r.jsx("div",{className:"mb-4 h-48",children:r.jsx(j.B,{title:"Unable to scan for wifi access points",children:w?.message})}):0!==Object.keys(o).length&&s?r.jsx(CardSelector,{cards:D,onSelect:M}):r.jsx("div",{className:"mb-4 flex h-48 items-center justify-center",children:r.jsx(c.$,{})}),U={onClick:e.nextScreen,label:"Skip"},H={onClick:e.previousScreen},Y="Pick an access point to join";return m&&(U={label:"Submit",disabled:!I.success||F.isLoading,isLoading:F.isLoading,title:I.success?void 0:I.error.errors.map(e=>["ssid","password"].includes(e.path.pop()+"")?null:`${e.path}: ${e.message}`).filter(Boolean).join("\n"),onClick:q},H={onClick:()=>u(null),label:"Back",disabled:F.isLoading},Y="Enter password for "+m.ssid,F.isSuccess&&(U={label:"Save and Connect",disabled:!$.success||P.isLoading,onClick:Z},H={onClick:()=>F.reset(),label:"Back",disabled:F.isLoading},Y="Enter the hostname you want to use for the printer",b&&(U={onClick:e.nextScreen},H={},Y="Proceed to next step"))),(0,r.jsxs)(i.Fragment,{children:[(0,r.jsxs)("div",{className:"p-4 @sm:p-8",children:[(0,r.jsxs)("div",{className:"mb-5 flex border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[(0,r.jsxs)("div",{className:"flex-1",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Configure Wifi Setup"}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:Y})]}),null==m&&r.jsx("div",{children:(0,r.jsxs)(x.z,{variant:"indeterminate",onClick:()=>{l(!1),k(e=>!e),null!=t.current&&clearTimeout(t.current),t.current=window.setTimeout(()=>{d({}),l(!0),t.current=null},4e3)},children:[N?r.jsx(ev.Z,{className:"h-4 w-4"}):r.jsx(eN.Z,{className:"h-4 w-4"})," ",N?"Hide Hidden SSIDs":"Show Hidden SSIDs"]})})]}),r.jsx(MutationStatus,{...F}),r.jsx(MutationStatus,{...P}),W]}),r.jsx(StepNavButtons,{right:U,left:H})]})};var ek=s(48722),ey=s(68797),ez=s(18303),eS=s(9655),ew=s(3729);let eC=[{id:"01",name:"Confirm configuration",description:"Confirm your printer configuration",href:"#",renderScreen:e=>(0,i.createElement)(ConfirmConfig,{...e,key:e.key})},{id:"02",name:"Setup complete",description:"You've completed the initial setup, congratulations!",href:"#",renderScreen:e=>(0,i.createElement)(ProceedToMainsail,{...e,key:e.key})}],ConfirmToolhead=e=>{let{toolhead:t,setToolhead:s}=(0,et.yk)(e.toolOrAxis),n=a.S.mcu.detect.useQuery({boardPath:t.getToolboard()?.path??"",toolhead:t.serialize()},{enabled:null!=t.getToolboard()}),[o,d]=(0,i.useState)(!1),u=(0,l.useRecoilCallback)(({snapshot:e,set:r})=>async()=>{let r=await e.getPromise(b.PrinterConfigurationState);if(null==r)return;let a=(0,ek.uo)(r,t.getConfig()).find(e=>"endstop-toolboard"===e.id);null!=a&&null!=t&&s({...t.getConfig(),xEndstop:a})},[]);if(null==t)return r.jsx("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 border-t border-zinc-100 py-4 dark:border-zinc-700 sm:grid-cols-2",children:r.jsx("div",{className:"sm:col-span-2",children:r.jsx("div",{className:"space-x-2 text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:r.jsx(c.$,{})})})});let h=null!=t.getToolboard()&&!n.data||t.getToolboard()?.alternativePT1000Resistor&&"PT1000"===t.getThermistor();return r.jsx(eS.p,{as:"div",className:"",defaultOpen:!!h,children:({open:e})=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(eS.p.Button,{as:"div",className:"cursor-pointer border-b border-zinc-100 py-4 dark:border-zinc-800",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("h3",{className:"flex items-center space-x-2 text-base font-bold leading-7 text-zinc-900 dark:text-zinc-100",children:[(0,r.jsxs)("span",{children:["Toolhead ",t.getToolCommand()]}),h&&r.jsx(G.Ct,{color:"yellow",size:"md",children:"Has Warnings"})]}),r.jsx("button",{children:r.jsx(ew,{className:(0,m.dV)("h-6 w-6 transition-all duration-200 ease-in-out",e?"rotate-90":"rotate-0")})})]}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm",children:t.getDescription()})]}),r.jsx(P.i,{children:(0,r.jsxs)(eS.p.Panel,{className:"pt-4",children:[(0,r.jsxs)("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2",children:[(0,r.jsxs)("div",{className:"sm:col-span-1",children:[(0,r.jsxs)("dt",{className:"space-x-2 text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:[r.jsx("span",{children:"Toolboard"})," ",t.getConfig().toolboard&&r.jsx(G.Ct,{color:!0===n.data?"green":"red",children:!0===n.data?"Detected":"Not detected"})]}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:null==t.getConfig().toolboard?"None selected":`${t.getConfig().toolboard?.manufacturer} ${t.getConfig().toolboard?.name}`})]}),null!=t.getToolboard()&&!n.data&&r.jsx("div",{className:"sm:col-span-2",children:r.jsx(I.j,{children:r.jsx("div",{className:"space-y-2",children:r.jsx("div",{children:"The toolboard you have selected does not seem to be connected, you can still save the config and proceed to mainsail, but you will get an 'mcu' connection error."})})})}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Extruder"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.getConfig().extruder?.title??"None selected"})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Hotend"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.getConfig().hotend?.title??"None selected"})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Thermistor"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.getConfig().thermistor??"None selected"})]}),t.getToolboard()?.alternativePT1000Resistor&&"PT1000"===t.getThermistor()&&r.jsx("div",{className:"col-span-2",children:r.jsx(I.j,{title:"RatOS uses your toolboards alternate pullup resistor setting",children:"Your toolboard has an option to use a separate pullup resistor for PT1000 sensors. This is usually done by inserting a jumper. Make sure you read the documentation for your board on how to enable the alternative resistor or you'll get ADC temperature errors in klipper."})})]}),(0,r.jsxs)("dl",{className:"mt-4 grid grid-cols-1 gap-x-4 gap-y-4 border-t border-zinc-100 py-4 dark:border-zinc-800 sm:grid-cols-2",children:[(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"X Endstop"}),(0,r.jsxs)("dd",{className:"mt-1 flex gap-2 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:[t.getConfig().xEndstop?.title??"None selected",t.getConfig().xEndstop?.badge?.map(e=>r.jsx(G.Ct,{color:e.color,children:e.children.replace("Tundefined",`T${t.getTool()}`)},e.children))]})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Y Endstop"}),(0,r.jsxs)("dd",{className:"mt-1 flex gap-2 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:[t.getConfig().yEndstop?.title??"None selected",t.getConfig().yEndstop?.badge?.map(e=>r.jsx(G.Ct,{color:e.color,children:e.children},e.children))]})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Probe"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.getConfig().probe?.title??"None selected"})]}),null!=t.getConfig().toolboard&&t.getConfig().xEndstop?.id==="endstop"&&!o&&r.jsx("div",{className:"sm:col-span-2",children:(0,r.jsxs)(I.j,{children:["The current configuration assumes the X endstop is connected to your controlboard, do you want to use an endstop connected to the toolboard instead?",(0,r.jsxs)("div",{className:"mt-4 flex justify-end space-x-2",children:[r.jsx(x.z,{onClick:u,variant:"warning",children:"Yes, use the toolboard connection"}),r.jsx(x.z,{onClick:()=>d(!0),variant:"plain",children:"No, use the controlboard connection"})]})]})})]}),(0,r.jsxs)("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 border-t border-zinc-100 py-4 dark:border-zinc-800 sm:grid-cols-2",children:[(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Part cooling fan"}),(0,r.jsxs)("dd",{className:"mt-1 flex gap-2 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:[t.getConfig().partFan?.title??"None selected",t.getConfig().partFan?.badge?.map(e=>r.jsx(G.Ct,{color:e.color,children:e.children.replace("Tundefined",`T${t.getTool()}`)},e.children))]})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Hotend cooling fan"}),(0,r.jsxs)("dd",{className:"mt-1 flex gap-2 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:[t.getConfig().hotendFan?.title??"None selected",t.getConfig().hotendFan?.badge?.map(e=>r.jsx(G.Ct,{color:e.color,children:e.children.replace("Tundefined",`T${t.getTool()}`)},e.children))]})]})]}),(0,r.jsxs)("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 border-t border-zinc-100 py-4 dark:border-zinc-800 sm:grid-cols-2",children:[(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"X Accelerometer"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.getConfig().xAccelerometer?.title??"None"})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Y Accelerometer"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.getConfig().yAccelerometer?.title??"None"})]})]})]})})]})})},ConfirmConfig=e=>{let{parsedPrinterConfiguration:t,partialPrinterConfiguration:s}=(0,b.usePrinterConfiguration)(),n=(0,i.useMemo)(()=>!0===t.success?(0,b.serializePrinterConfiguration)(t.data):null,[t]),l=[],[o,d]=(0,i.useState)([]),[c,u]=(0,i.useState)([]),x=a.S.mcu.detect.useQuery({boardPath:null!=s?s.controlboard?.path??"":""},{enabled:s?.controlboard!=null}),h=a.S.printer.saveConfiguration.useMutation(),p=(0,i.useCallback)(async()=>{t.success&&h.mutate({config:(0,b.serializePrinterConfiguration)(t.data),overwriteFiles:o,skipFiles:c},{onSuccess:e.nextScreen,onError:()=>window.scrollTo(0,0)})},[t,h,o,c,e.nextScreen]),g=a.S.useUtils().client,f=(0,ey.a)({queryKey:["filesToWrite",n],queryFn:async()=>{let e=await g.printer.getFilesToWrite.mutate({config:n??{}});return e},enabled:t.success}),v=f.data?.some(e=>"changed"===e.state&&!0===e.changedFromConfig&&!1===e.overwrite&&!c.includes(e.fileName)&&!o.includes(e.fileName));if(h.error&&l.push(h.error.message),!1===t.success){let e=t.error.flatten().formErrors,s=t.error.flatten().fieldErrors;if(e.length)e.forEach(e=>{l.push(e)});else for(let e in s)l.push((0,r.jsxs)(r.Fragment,{children:[r.jsx("span",{className:"capitalize",children:e}),": ",s[e]?.[0]]}))}let N=(0,i.useMemo)(()=>t.success?t.data.rails.filter(e=>e.axis.startsWith("x")||e.axis.startsWith("y"))?.map(e=>{let s=t.data.controlboard,a=e.motorSlot;if(null==a||s?.motorSlots?.[a].title==null)return null;let i=s.motorSlots?.[a].diag_pin!=null,n=e.axis.startsWith("x")&&t.data.toolheads.some(e=>e.xEndstop?.id==="sensorless")||e.axis.startsWith("y")&&t.data.toolheads.some(e=>e.yEndstop?.id==="sensorless");return!i&&n?r.jsx(j.B,{className:"col-span-2",title:"Driver Slot Allocation Invalid",children:r.jsx("div",{className:"space-y-2",children:r.jsxs("div",{children:[r.jsx("span",{className:"capitalize",children:e.axis})," is configured to use sensorless homing, but the"," ",r.jsx("span",{className:"capitalize",children:s.motorSlots?.[a].title})," motor slot does not have a diag pin connected."]})})},e.axis):null}).filter(Boolean):null,[t]);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"p-4 @sm:p-8",children:[" ",(0,r.jsxs)("div",{className:"mb-5 border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:e.name}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:e.description})]}),r.jsx("div",{className:"space-y-4 text-zinc-700 dark:text-zinc-300",children:t.success&&(0,r.jsxs)("div",{children:[l.length>0&&r.jsx("div",{className:"mt-2",children:r.jsx(j.B,{children:l.map((e,t)=>r.jsx("div",{className:"mt-2",children:e},t))})}),(0,r.jsxs)(P.i,{className:"mt-4",children:[r.jsx(eS.p,{as:i.Fragment,children:({open:e})=>(0,r.jsxs)(r.Fragment,{children:[r.jsx(eS.p.Button,{as:"div",className:"border-b border-zinc-100 py-4 dark:border-zinc-800",children:(0,r.jsxs)("div",{className:"flex cursor-pointer items-center justify-between",children:[(0,r.jsxs)("h3",{className:"flex items-center space-x-2 text-base font-bold leading-7 text-zinc-900 dark:text-zinc-100",children:[r.jsx("span",{children:"General"}),null!=t.data.controlboard&&!x.data&&r.jsx(G.Ct,{color:"yellow",children:"Has Warnings"})]}),r.jsx("button",{children:r.jsx(ew,{className:(0,m.dV)("h-6 w-6 transition-all duration-200 ease-in-out",e?"rotate-90":"rotate-0")})})]})}),(0,r.jsxs)(eS.p.Panel,{as:"dl",className:"grid grid-cols-1 gap-x-4 gap-y-4 py-4 sm:grid-cols-2",children:[(0,r.jsxs)("div",{className:"sm:col-span-2",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Printer"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:null!=t.data.printer?`${t.data.printer.manufacturer} ${t.data.printer.name} ${Object.keys(t.data.printer.sizes).length>1?t.data.size.x:""}`:"None selected"})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[(0,r.jsxs)("dt",{className:"space-x-2 text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:[r.jsx("span",{children:"Controlboard"}),t.data.controlboard&&r.jsx(G.Ct,{color:!0===x.data?"green":"red",children:!0===x.data?"Detected":"Not detected"})]}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:null!=t.data.controlboard?`${t.data.controlboard.manufacturer} ${t.data.controlboard.name}`:"None selected"})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Controller cooling fan"}),(0,r.jsxs)("dd",{className:"mt-1 flex gap-2 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:[t.data.controllerFan?.title??"None selected",t.data.controllerFan?.badge?.map(e=>r.jsx(G.Ct,{color:e.color,children:e.children},e.children))]})]}),null!=t.data.controlboard&&!x.data&&r.jsx("div",{className:"sm:col-span-2",children:r.jsx(I.j,{children:r.jsx("div",{className:"space-y-2",children:r.jsx("div",{children:"The controlboard you have selected does not seem to be connected, you can still save the config and proceed to mainsail, but you will get an 'mcu' connection error."})})})})]})]})}),r.jsx("div",{className:"",children:t.data.toolheads.map(e=>r.jsx(ConfirmToolhead,{toolOrAxis:e.axis},e.axis))}),r.jsx(eS.p,{as:i.Fragment,defaultOpen:!1,children:({open:e})=>(0,r.jsxs)(r.Fragment,{children:[r.jsx(eS.p.Button,{as:"div",className:"border-b border-zinc-100 py-4 dark:border-zinc-800",children:(0,r.jsxs)("div",{className:"flex cursor-pointer items-center justify-between",children:[(0,r.jsxs)("h3",{className:"flex items-center space-x-2 text-base font-bold leading-7 text-zinc-900 dark:text-zinc-100",children:[r.jsx("span",{children:"Motion"}),(N?.length??0)>0&&r.jsx(G.Ct,{color:"red",children:"Has Errors"})]}),r.jsx("button",{children:r.jsx(ew,{className:(0,m.dV)("h-6 w-6 transition-all duration-200 ease-in-out",e?"rotate-90":"rotate-0")})})]})}),(0,r.jsxs)(eS.p.Panel,{children:[(0,r.jsxs)("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 py-4 sm:grid-cols-2",children:[(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Performance mode"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.data.performanceMode?"Enabled":"Disabled"})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Stealtchop"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.data.stealthchop?"Enabled":"Disabled"})]}),(0,r.jsxs)("div",{className:"sm:col-span-1",children:[r.jsx("dt",{className:"text-sm font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Standstill Stealth"}),r.jsx("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:t.data.standstillStealth?"Enabled":"Disabled"})]})]}),r.jsx("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 border-t border-zinc-100 py-4 dark:border-zinc-700 sm:grid-cols-2",children:t.data.rails?.map((e,t)=>r.jsxs("div",{className:"sm:col-span-1",children:[r.jsxs("dt",{className:"text-sm font-medium capitalize leading-6 text-zinc-900 dark:text-zinc-100",children:[e.axis===z.po.extruder?e.axis:e.axis.toLocaleUpperCase()," Motion Configuration"]}),r.jsxs("dd",{className:"mt-1 text-sm leading-6 text-zinc-600 dark:text-zinc-400 sm:mt-2",children:[r.jsxs("div",{className:"font-medium",children:[e.driver.title," @ ",e.voltage,"V"]}),r.jsxs("div",{className:"font-medium",children:[e.stepper.title," @ ",e.current,"A RMS"]}),r.jsxs("div",{className:"font-medium",children:[e.microstepping," microsteps"]})]})]},t))})]})]})}),(0,r.jsxs)("div",{className:"mb-5 mt-10 border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Configuration Files"}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:"Please review the changes to the configuration files."})]}),r.jsx("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 pb-4 sm:grid-cols-2",children:r.jsx("div",{className:"dark:border-zinc-700 sm:col-span-2",children:r.jsx(ez.o,{serializedConfig:t.success?n:null,onFilesToIgnoreChange:u,onFilesToOverwriteChange:d})})}),r.jsx("dl",{className:"grid grid-cols-1 gap-x-4 gap-y-4 border-zinc-100 dark:border-zinc-700 sm:grid-cols-2",children:r.jsx("div",{className:"dark:border-zinc-700 sm:col-span-2",children:r.jsx(R.$,{children:(0,r.jsxs)("ul",{className:"ml-4 list-disc space-y-2",children:[r.jsx("li",{children:'If the above information is correct, and you agree with the changes, go ahead and save the configuration. If not, go back and change the configuration by clicking the steps in the "Setup Progress" panel.'}),r.jsx("li",{children:"If you are unsure about the changes to a modified file, remember there's always a timestamped backup created next to the given file when a file is overwritten, you can easily copy paste from the old backup file in the Machine tab in mainsail, in case things go wrong."})]})})})})]})]})})]}),r.jsx(StepNavButtons,{left:{onClick:e.previousScreen},right:{onClick:p,disabled:!t.success||(N?.length??0)>0||v,title:v?"You need to explicitly overwrite or ignore one or more files":void 0,isLoading:h.isLoading,label:"Confirm and save"}})]})},ProceedToMainsail=e=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"p-4 @sm:p-8",children:[" ",(0,r.jsxs)("div",{className:"mb-5 border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:e.name}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:e.description})]}),(0,r.jsxs)("div",{className:"space-y-4 text-zinc-700 dark:text-zinc-300",children:["Now that the base configuration has been saved, you can connect to your printer via Mainsail and start calibrating your printer.",(0,r.jsxs)("div",{className:"mt-5",children:["You can now continue to"," ",r.jsx("a",{href:"https://os.ratrig.com/docs/configuration#initial-configuration",target:"_blank",rel:"noreferrer",className:"cursor-pointer text-brand-700 hover:text-brand-600",children:"the next step in the documentation."})]})]})]}),r.jsx(StepNavButtons,{left:{onClick:e.previousScreen},right:{onClick:()=>{window.location.href="http://"+window.location.hostname},label:"Open Mainsail"}})]}),WizardComplete=e=>{let{currentStep:t,screenProps:s}=useSteps({steps:eC,parentScreenProps:e});return t.renderScreen({...s})};var eP=s(32518),eF=s(96434);let makeSteps=(e,t)=>{let s=0,getNextIndex=()=>(++s+"").padStart(2,"0"),r=[{id:getNextIndex(),name:"Network connectivity",description:"Setup Wifi or Ethernet connectivity",href:"#",renderScreen:e=>(0,i.createElement)(WifiSetup,{...e,key:e.key})},{id:getNextIndex(),name:"Printer Selection",description:"Select the printer you want to configure",href:"#",renderScreen:e=>(0,i.createElement)(PrinterSelection,{...e,key:e.key})},{id:getNextIndex(),name:"Control board preparation",canBeSkippedTo:t,description:"Connect to and flash your control board",href:"#",renderScreen:e=>(0,i.createElement)(MCUPreparation,{...e,key:e.key})}];return e.forEach(e=>{let s=new o.D(e);r.push({id:getNextIndex(),name:`${s.getToolCommand()} Toolboard Preparation`,canBeSkippedTo:t,description:`Connect to and flash an optional toolboard located on ${s.getDescription().toLocaleLowerCase()}`,href:"#",renderScreen:t=>(0,i.createElement)(MCUPreparation,{...t,key:t.key,toolOrAxis:e.axis})})}),r.push({id:getNextIndex(),name:"Hardware Selection",canBeSkippedTo:t,description:"Tell RatOS about that hardware you have installed on your printer",href:"#",renderScreen:e=>(0,i.createElement)(HardwareSelection,{...e,key:e.key})}),r.push({id:getNextIndex(),name:"Confirm your setup",canBeSkippedTo:t,description:"Confirm your setup and start printing",href:"#",renderScreen:e=>(0,i.createElement)(WizardComplete,{...e,key:e.key})}),r},LoadScreen=()=>(0,r.jsxs)("div",{className:"",children:[(0,r.jsxs)("div",{className:"mb-5 border-b border-zinc-200 pb-5 dark:border-zinc-700",children:[r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Loading printer configuration..."}),r.jsx("p",{className:"mt-2 max-w-4xl text-sm text-zinc-500 dark:text-zinc-400",children:"Please wait while RatOS loads your printer configuration"})]}),r.jsx("div",{className:"mt-4 flex h-48 items-center justify-center",children:r.jsx(c.$,{})})]}),SetupSteps=e=>{let t=(0,eP.useSearchParams)(),s=(0,eP.useRouter)(),a=(0,eF.useLocalPathname)(),o=(0,l.useRecoilValue)(d.wm),c=(0,i.useMemo)(()=>makeSteps(o,o?.length>0),[o]),m=t?.get("step")?parseInt(t?.get("step")??"",10):null,u=e.hasWifiInterface&&!e.isConnectedToWifi?0:1,{currentStepIndex:x,setCurrentStepIndex:h,screenProps:p,currentStep:g}=useSteps({step:null!=m&&m<c.length?m:u,onStepChange:e=>{s.push(`${a}?step=${e}`,void 0),window.scrollTo(0,0)},steps:c});return(0,r.jsxs)("div",{className:"mx-auto mt-8 grid max-w-3xl grid-cols-1 gap-4 px-4 lg:max-w-7xl lg:grid-flow-col-dense lg:grid-cols-3",children:[r.jsx("div",{className:"lg:col-span-2 lg:col-start-1",children:r.jsx(Z.Card,{children:r.jsx(n().Suspense,{fallback:r.jsx(LoadScreen,{}),children:null==m||m===x?g.renderScreen(p):r.jsx(LoadScreen,{})})})}),r.jsx("div",{className:"space-y-6 lg:col-span-1 lg:col-start-3",children:(0,r.jsxs)(Z.Card,{className:"p-8",children:[r.jsx("div",{className:"mb-5 border-b border-zinc-200 pb-5 dark:border-zinc-800",children:r.jsx("h3",{className:"text-lg font-medium leading-6 text-zinc-900 dark:text-zinc-100",children:"Setup Progress"})}),r.jsx(VerticalSteps,{steps:c,screenProps:p,currentStepIndex:x,setCurrentStepIndex:h})]})})]})};var eT=s(35273);let Wizard=e=>{let{data:t}=a.S.version.useQuery(void 0,{keepPreviousData:!0,refetchOnMount:!1}),{data:s}=a.S.ipAddress.useQuery(void 0,{keepPreviousData:!0,refetchOnMount:!1}),i=(0,l.useRecoilValue)(en.H6);return(0,r.jsxs)(r.Fragment,{children:[r.jsx(eT.wq,{title:`${i?.name??"Printer"} Setup`,description:`RatOS ${t} @ ${s}`}),r.jsx(SetupSteps,{...e})]})}},28912:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>WizardLayout});var r=s(8632),a=s(45650);function WizardLayout({children:e}){return(0,a.headers)().get("x-configurator"),r.jsx("main",{className:"min-h-full",children:e})}},11559:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>Page});var r=s(8632),a=s(80051),i=s(32081),n=s(73837);let getWirelessInterface=async()=>{let e=await (0,n.promisify)(i.exec)("iw dev | awk '$1==\"Interface\"{print $2}' | head -n1");return e.stdout.trim()},isConnectedToWifi=async()=>{let e=await getWirelessInterface();try{let t=await (0,n.promisify)(i.exec)(`sudo wpa_cli -i "${e}" status | grep 'ip_address'`);if(t.stdout.indexOf("ip_address=192.168.50.1")>-1)return!1;return!0}catch(e){return!1}};var l=s(97175);let o=(0,l.createProxy)(String.raw`/home/runner/work/RatOS-configurator/RatOS-configurator/src/app/wizard/wizard.tsx`),{__esModule:d,$$typeof:c}=o;o.default;let m=o.Wizard;var u=s(45650),x=s(3747);function Page(){(0,u.headers)().get("x-configurator");let e=(0,a.use)(isConnectedToWifi()),t=(0,a.use)(getWirelessInterface());return r.jsx(x.r,{children:r.jsx(m,{isConnectedToWifi:e,hasWifiInterface:null!=t&&""!=t.trim()})})}},3747:(e,t,s)=>{"use strict";s.d(t,{r:()=>l});var r=s(97175);let a=(0,r.createProxy)(String.raw`/home/runner/work/RatOS-configurator/RatOS-configurator/src/components/common/no-ssr.tsx`),{__esModule:i,$$typeof:n}=a;a.default;let l=a.NoSSR}};var t=require("../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[7013,2689,8989,2828,1169,5197,7141,1041,5508,6317,1971,9529,8099,7340,2017,6490,2251,8879,3709,991,5260,6,3728,5129,6416,4933],()=>__webpack_exec__(69515));module.exports=s})();